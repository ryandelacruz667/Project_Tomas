<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="./resources/ol.css">
        <link rel="stylesheet" href="resources/fontawesome-all.min.css">
        <link href="resources/photon-geocoder-autocomplete.min.css" rel="stylesheet">
        <link rel="stylesheet" href="./resources/ol-layerswitcher.css">
        <link rel="stylesheet" href="./resources/qgis2web.css">
        <style>
        html, body {
            background-color: #ffffff;
        }
        .ol-control > * {
            background-color: #f8f8f8!important;
            color: #444444!important;
            border-radius: 0px;
        }
        .ol-attribution a, .gcd-gl-input::placeholder, .search-layer-input-search::placeholder {
            color: #444444!important;
        }
        .search-layer-input-search {
            background-color: #f8f8f8!important;
        }
        .ol-control > *:focus, .ol-control >*:hover {
            background-color: rgba(248, 248, 248, 0.7)!important;
        } 
        .ol-control {
            background-color: rgba(255,255,255,.4) !important;
            padding: 2px !important;
        } 

        body, html {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        #main-wrapper {
            display: flex;
            flex-direction: row;
            height: 100vh;
            width: 100vw;
        }

        #left-pane {
            width: 320px;
            background: #23272f;
            color: #fff;
            height: 100vh;
            box-shadow: 2px 0 8px rgba(34,34,34,0.04);
            display: flex;
            flex-direction: column;
            padding: 0;
            z-index: 10;
            overflow: hidden;
            position: relative;
        }
        
        /* Ensure all child elements inherit the dark background */
        #left-pane * {
            background-color: inherit;
        }
        
        /* Override any white backgrounds that might be inherited */
        #left-pane .sidebar-header,
        #left-pane .nav-bar,
        #left-pane .flood-section,
        #left-pane .flood-form-group,
        #left-pane .flood-legend-section {
            background: #23272f !important;
        }
        .sidebar-header {
            font-size: 1.6rem;
            font-weight: 700;
            text-align: left;
            padding: 1.5rem 1.5rem 0.8rem 1.5rem;
            letter-spacing: 0.3px;
            border-bottom: none;
            color: #fafafa;
            background: #23272f;
        }
        .sidebar-header span {
            border-bottom: 3px solid #24b2ff;
            padding-bottom: 0.2rem;
            color: #24b2ff;
            font-size: 1.3rem;
            display: inline-block;
            letter-spacing: 0.5px;
        }
        .sidebar-header.flood-header {
            /* Same as .sidebar-header but separate class for Flood Extent */
            font-size: 1.6rem;
            font-weight: 700;
            text-align: left;
            padding: 1.5rem 1.5rem 0.8rem 1.5rem;
            letter-spacing: 0.3px;
            border-bottom: none;
            color: #fafafa;
            background: #23272f;
        }
        .sidebar-header.flood-header span {
            border-bottom: 3px solid #f39c12;
            padding-bottom: 0.2rem;
            color: #f39c12;
            font-size: 1.3rem;
            display: inline-block;
            letter-spacing: 0.5px;
        }
        .nav-bar {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            margin-top: 1rem;
            padding: 0 1.2rem;
        }
        .nav-btn {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.7rem 1rem;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            outline: none;
            background: none;
            color: #fafafa;
            transition: background 0.18s, color 0.18s;
            border-radius: 8px;
            cursor: pointer;
            letter-spacing: 0.5px;
        }
        .nav-btn i {
            font-size: 1.2rem;
        }
        .nav-btn:hover, .nav-btn.active {
            background: #24b2ff;
            color: #fff;
        }
        /* Flood hazard section style */
        .flood-section {
            margin-top: 1.5rem;
        }
        .flood-form-group {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
            margin: 0 1.5rem 1rem 1.5rem;
        }
        .flood-form-label {
            font-size: 1.03rem;
            color: #f39c12;
            font-weight: 600;
            margin-bottom: 0.35rem;
            margin-left: 2px;
            letter-spacing: 0.5px;
        }
        .flood-modern-select {
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 8px;
            background: #262a33;
            color: #fafafa;
            font-size: 1.08rem;
            font-weight: 500;
            outline: none;
            transition: background 0.14s;
            min-width: 135px;
            box-shadow: 0 0 0 1px #222326;
        }
        .flood-modern-select:focus {
            background: #181b1f;
            box-shadow: 0 0 0 1.5px #f39c12;
        }
        .flood-divider {
            border: none;
            border-top: 2px solid #444;
            margin: 1.2rem 2rem 0.5rem 2rem;
        }
        
        /* Flood Legend Styles */
        .flood-legend-section {
            margin: 1.5rem 2rem 1rem 2rem;
        }
        .flood-legend {
            background: #262a33;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 0.5rem;
            border: 1px solid #333;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin-bottom: 0.6rem;
            padding: 0.3rem 0;
        }
        .legend-item:last-child {
            margin-bottom: 0;
        }
        .legend-icon {
            width: 20px;
            height: 20px;
            border-radius: 2px;
            flex-shrink: 0;
        }
        .legend-text {
            color: #fafafa;
            font-size: 0.95rem;
            font-weight: 500;
        }

        /* Top Pane Styles */
        #top-pane {
            position: fixed;
            left: 320px;
            top: 0;
            right: 0;
            height: 72px;
            background: #23272f;
            color: #fafafa;
            display: flex;
            align-items: center;
            z-index: 9;
            box-shadow: 0 2px 8px rgba(34,34,34,0.04);
            padding-left: 2.5rem;
            padding-right: 3rem;
        }
        
        .search-form {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            width: 100%;
            max-width: 600px;
            margin-left: 0;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .form-label {
            font-size: 1.03rem;
            color: #24b2ff;
            font-weight: 600;
            margin-bottom: 0.35rem;
            margin-left: 2px;
            letter-spacing: 0.5px;
        }
        .modern-select {
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 8px;
            background: #262a33;
            color: #fafafa;
            font-size: 1.08rem;
            font-weight: 500;
            outline: none;
            transition: background 0.14s;
            min-width: 135px;
            box-shadow: 0 0 0 1px #222326;
        }
        .modern-select:focus {
            background: #181b1f;
            box-shadow: 0 0 0 1.5px #24b2ff;
        }
        .search-btn {
            padding: 0.65rem 2.1rem;
            border: none;
            border-radius: 10px;
            background: #24b2ff;
            color: #fff;
            font-size: 1.13rem;
            font-weight: 700;
            letter-spacing: 1px;
            cursor: pointer;
            transition: background 0.12s, box-shadow 0.15s;
            margin-left: 1.4rem;
            box-shadow: 0 2px 8px rgba(36,178,255,0.09);
        }
        .search-btn:hover {
            background: #189fd1;
            box-shadow: 0 2px 14px rgba(36,178,255,0.13);
        }

        /* Modern Data Table for Household */
        #household-data-table-container {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 15;
            background: rgba(250, 252, 255, 0.95);
            display: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15), 0 0px 0px rgba(0,0,0,0);
            border-radius: 12px;
            padding: 0;
            max-width: 90vw;
            max-height: 80vh;
            overflow: hidden;
            backdrop-filter: blur(10px);
            cursor: move;
        }
        
        /* Drag handle for the table */
        .table-drag-handle {
            background: #24b2ff;
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 12px 12px 0 0;
            cursor: move;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .table-drag-handle:hover {
            background: #189fd1;
        }
        
        .table-content {
            padding: 1.5rem 2rem 1.5rem 2rem;
            overflow: auto;
            max-height: calc(80vh - 60px);
        }
        @media only screen and (max-width: 700px) {
            #household-data-table-container { 
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                max-width: 95vw;
                max-height: 85vh;
            }
            .table-content {
                padding: 1rem 1.2rem 1rem 1.2rem;
                max-height: calc(85vh - 50px);
            }
            .table-drag-handle {
                padding: 0.6rem 1rem;
                font-size: 1rem;
            }
        }
        .modern-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 11px;
            overflow: hidden;
            font-size: 1.03rem;
            margin-top: 0;
            margin-bottom: 0;
            box-shadow: 0 2px 9px rgba(0,0,0,0.08);
        }
        .modern-table thead {
            background: #24b2ff;
            color: #fff;
        }
        .modern-table th, .modern-table td {
            padding: 0.82rem 1.15rem;
            text-align: left;
            border-bottom: 1px solid #dde2ec;
        }
        .modern-table th {
            font-weight: 700;
            font-size: 1.04rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .modern-table tr:last-child td {
            border-bottom: none;
        }
        .modern-table tbody tr:hover {
            background: #e6f4ff;
        }
        .modern-table .empty-message {
            text-align: center;
            font-style: italic;
            color: #aaa;
        }
        #close-household-table-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.18s;
            padding: 0;
            margin: 0;
            line-height: 1;
        }
        #close-household-table-btn:hover {
            color: #ff6b6b;
        }
        
        /* Semi-transparent overlay background when table is shown */
        #household-data-table-container::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.3);
            z-index: -1;
            backdrop-filter: blur(2px);
        }

        /* Flood Impact Infographics Container */
        #flood-infographics-container {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
            background: rgba(250, 252, 255, 0.95);
            display: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border-radius: 12px;
            padding: 0;
            max-width: 90vw;
            max-height: 80vh;
            overflow: hidden;
            backdrop-filter: blur(10px);
            cursor: move;
            min-width: 400px;
        }
        
        .infographics-drag-handle {
            background: #f39c12;
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 12px 12px 0 0;
            cursor: move;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .infographics-drag-handle:hover {
            background: #e67e22;
        }
        
        .infographics-content {
            padding: 1.5rem 2rem 1.5rem 2rem;
            overflow: auto;
            max-height: calc(80vh - 60px);
        }
        
        .infographics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .infographic-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 1.2rem;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }
        
        .infographic-card:hover {
            transform: translateY(-2px);
        }
        
        .infographic-icon {
            font-size: 2.5rem;
            margin-bottom: 0.8rem;
            display: block;
        }
        
        .infographic-number {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 0.3rem;
        }
        
        .infographic-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .damage-summary {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            margin-top: 1rem;
        }
        
        .damage-summary .infographic-icon {
            color: white;
        }
        
        .damage-summary .infographic-number {
            color: white;
        }
        
        .damage-summary .infographic-label {
            color: rgba(255, 255, 255, 0.9);
        }
        
        #close-infographics-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.18s;
            padding: 0;
            margin: 0;
            line-height: 1;
        }
        
        #close-infographics-btn:hover {
            color: #ff6b6b;
        }
        
        @media only screen and (max-width: 700px) {
            #flood-infographics-container {
                min-width: 95vw;
                max-width: 95vw;
                max-height: 85vh;
            }
            .infographics-content {
                padding: 1rem 1.2rem 1rem 1.2rem;
                max-height: calc(85vh - 50px);
            }
            .infographics-drag-handle {
                padding: 0.6rem 1rem;
                font-size: 1rem;
            }
            .infographics-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            .infographic-card {
                padding: 1rem;
            }
            .infographic-icon {
                font-size: 2rem;
            }
            .infographic-number {
                font-size: 1.5rem;
            }
        }

        /* push map down to not overlap with top bar */
        #map-container {
            flex: 1 1 0%;
            height: calc(100vh - 72px);
            width: 100%;
            position: relative;
            overflow: hidden;
            margin-top: 72px;
        }
        #map {
            width: 100%;
            height: 100%;
            margin: 0;
        }

        /* Responsive breakpoints */
        @media (max-width: 1400px) {
            #left-pane { width: 300px; }
            #top-pane { left: 300px; }
            .search-form { max-width: 520px; gap: 1rem; }
            .sidebar-header, .sidebar-header.flood-header { font-size: 1.6rem; }
        }

        @media (max-width: 1200px) {
            #left-pane { width: 280px; }
            #top-pane { left: 280px; }
            .search-form { max-width: 480px; gap: 0.9rem; }
            .sidebar-header, .sidebar-header.flood-header { font-size: 1.5rem; }
        }

        @media (max-width: 992px) {
            #left-pane { width: 260px; }
            #top-pane { left: 260px; height: 66px; padding-left: 1.5rem; padding-right: 1.5rem; }
            #map-container { height: calc(100vh - 66px); margin-top: 66px; }
            .search-form { max-width: 450px; gap: 0.8rem; }
            .form-label, .flood-form-label { font-size: 0.98rem; }
            .modern-select, .flood-modern-select { font-size: 1rem; }
            .search-btn { padding: 0.55rem 1.6rem; font-size: 1.02rem; }
        }

        @media (max-width: 768px) {
            #main-wrapper { flex-direction: column; }
            #left-pane { width: 100%; height: auto; position: relative; }
            #top-pane { left: 0; right: 0; position: sticky; top: 0; height: 60px; }
            #map-container { height: calc(100vh - 60px); margin-top: 0; }
            .nav-bar { flex-direction: row; flex-wrap: wrap; gap: 0.5rem; padding: 0.6rem; }
            .nav-btn { padding: 0.7rem 0.8rem; font-size: 0.95rem; }
            .search-form { max-width: none; width: 100%; gap: 0.6rem; }
            .modern-select, .flood-modern-select { min-width: 0; flex: 1; }
            .sidebar-header, .sidebar-header.flood-header { padding: 1rem; font-size: 1.3rem; }
            .infographics-grid { grid-template-columns: 1fr 1fr; gap: 1rem; }
            .modern-table th, .modern-table td { padding: 0.7rem 0.8rem; }
        }

        @media (max-width: 480px) {
            #left-pane { width: 100%; }
            #top-pane { height: 56px; }
            #map-container { height: calc(100vh - 56px); }
            .nav-btn i { font-size: 1.2rem; }
            .nav-btn { padding: 0.55rem 0.7rem; font-size: 0.9rem; }
            .form-label, .flood-form-label { font-size: 0.88rem; }
            .modern-select, .flood-modern-select { font-size: 0.95rem; padding: 0.45rem 0.7rem; }
            .search-btn { padding: 0.45rem 0.9rem; font-size: 0.95rem; margin-left: 0.4rem; }
            .infographics-grid { grid-template-columns: 1fr; }
            #flood-infographics-container, #household-data-table-container { min-width: unset; max-width: 96vw; }
        }

        @media only screen and (max-width: 700px) {

            #left-pane { width: 95px; }
            #top-pane { left: 95px; height: 60px; padding-left: 1rem; }
            .sidebar-header, .sidebar-header.flood-header { font-size: 1.15rem; padding: 1.2rem 1rem 1rem 1rem; }
            .nav-btn { font-size: 0.9rem; padding: 0.8rem 0.5rem; }
            .nav-btn span { display: none; }
            .nav-btn i { font-size: 1.35rem; }
            .nav-bar { padding: 0 0.4rem; }
            .form-label, .flood-form-label { font-size: 0.91rem; }
            .modern-select, .flood-modern-select { font-size: 0.98rem; padding: 0.5rem 0.8rem;}
            .search-btn { padding: 0.5rem 1.1rem; font-size: 1rem; margin-left: 0.5rem;}
            .search-form { gap: 0.6rem; }
            .flood-section { margin-top: 1.2rem; }
            .flood-form-group { margin: 0 1rem 1rem 1rem; }
            .flood-divider { margin: 1rem 1rem 0.5rem 1rem; }
            .flood-legend-section { margin: 1rem 1rem 0.8rem 1rem; }
            .flood-legend { padding: 0.8rem; }
            .legend-item { gap: 0.6rem; margin-bottom: 0.5rem; }
            .legend-icon { width: 16px; height: 16px; }
            .legend-text { font-size: 0.9rem; }
        }
        </style>

        <title>PROJECT TOMaS (Tactical Overlay for Mapping and Safety)</title>
    </head>
    <body>
        <div id="main-wrapper">
            <div id="left-pane">
                <div class="sidebar-header" style="background: #24b2ff; border-bottom: none; padding-bottom: 0.7rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1.2rem; justify-content: center; text-align: center;">
                    <i class="fas fa-map-marked-alt" style="font-size: 2.1rem; color: #fff;"></i>
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <span style="font-size: 1.45rem; font-weight: 800; color: #fff; letter-spacing: 1.1px; line-height: 1; text-align: center;">PROJECT TOMaS</span>
                        <div style="font-size: 0.98rem; color: #e6e6e6; margin-top: 0.18rem; font-weight: 400; letter-spacing: 0.2px; font-style: italic; opacity: 0.95; text-align: center;">
                            (Tactical Overlay for Mapping and Safety)
                        </div>
                    </div>
                </div>
                <div class="sidebar-header">
                    <span>Database</span>
                </div>
                <nav class="nav-bar">
                    <button class="nav-btn" id="household-btn" title="Household">
                        <i class="fas fa-home"></i>
                        <span>Household</span>
                    </button>
                    <button class="nav-btn" title="ACVs">
                        <i class="fas fa-industry"></i>
                        <span>ACVs</span>
                    </button>
                    <button class="nav-btn" title="Equipment">
                        <i class="fas fa-cogs"></i>
                        <span>Equipment</span>
                    </button>
                    <button class="nav-btn" id="roads-btn" title="Roads &amp; Bridges">
                        <i class="fas fa-road"></i>
                        <span>Roads &amp; Bridges</span>
                    </button>
                    <button class="nav-btn" title="Evac Center">
                        <i class="fas fa-hospital"></i>
                        <span>Evac Center</span>
                    </button>
                    <button class="nav-btn" title="Buildings">
                        <i class="fas fa-building"></i>
                        <span>Buildings</span>
                    </button>
                    <button class="nav-btn" title="Schools">
                        <i class="fas fa-school"></i>
                        <span>Schools</span>
                    </button>
                </nav>
                <!-- Flood Extent Dropdown Section Styled like Database Header -->
                <div class="flood-section">
                    <div class="sidebar-header flood-header">
                        <span>Flood Extent</span>
                    </div>
                    <div class="flood-form-group">
                        <label class="flood-form-label" for="floodExtentDropdown">Flood Extent</label>
                        <select id="floodExtentDropdown" class="flood-modern-select">
                            <option value="">Select Flood Extent</option>
                            <option value="24">24 meters</option>
                            <option value="25">25 meters</option>
                            <option value="26">26 meters</option>
                            <option value="27">27 meters</option>
                            <option value="28">28 meters</option>
                            <option value="29">29 meters</option>
                            <option value="30">30 meters</option>
                        </select>
                    </div>
                    <hr class="flood-divider" />
                    <!-- Flood Extent Legend -->
                    <div class="flood-legend-section">
                        <div class="flood-form-label" style="font-size: 0.9em;">Legends (Flood Depth)</div>
                        <div class="flood-legend" style="display: flex; flex-direction: column; gap: 4px;">
                            <div class="legend-item" style="display: flex; align-items: center; gap: 6px;">
                                <img src="styles/legend/24_10_0.png" alt="0.0010" class="legend-icon" style="width: 18px; height: 18px; padding: 4px;" />
                                <span class="legend-text" style="font-size: 0.85em;">0.0010m</span>
                            </div>
                            <div class="legend-item" style="display: flex; align-items: center; gap: 6px;">
                                <img src="styles/legend/24_10_1.png" alt="2.3258" class="legend-icon" style="width: 18px; height: 18px; padding: 4px;" />
                                <span class="legend-text" style="font-size: 0.85em;">2.3258m</span>
                            </div>
                            <div class="legend-item" style="display: flex; align-items: center; gap: 6px;">
                                <img src="styles/legend/24_10_2.png" alt="4.6505" class="legend-icon" style="width: 18px; height: 18px; padding: 4px;" />
                                <span class="legend-text" style="font-size: 0.85em;">4.6505m</span>
                            </div>
                            <div class="legend-item" style="display: flex; align-items: center; gap: 6px;">
                                <img src="styles/legend/24_10_3.png" alt="6.9753" class="legend-icon" style="width: 18px; height: 18px; padding: 4px;" />
                                <span class="legend-text" style="font-size: 0.85em;">6.9753m</span>
                            </div>
                            <div class="legend-item" style="display: flex; align-items: center; gap: 6px;">
                                <img src="styles/legend/24_10_4.png" alt="9.3000" class="legend-icon" style="width: 18px; height: 18px; padding: 4px;" />
                                <span class="legend-text" style="font-size: 0.85em;">9.3000m</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Top Bar -->
            <div id="top-pane">
                <form class="search-form" autocomplete="off">
                    <div class="form-group">
                        <label class="form-label" for="province-select">Province</label>
                        <select id="province-select" class="modern-select">
                            <option value="">Select Province</option>
                        <!-- INSERT_YOUR_CODE -->
                        <script>
                        // Dynamically populate province-select from Barangay_1.js NAME_1
                        // Assumes Barangay_1.js exposes a global variable 'json_Barangay_1'
                        (function() {
                            // Wait for DOM to be ready
                            document.addEventListener("DOMContentLoaded", function() {
                                // Check if json_Barangay_1 exists
                                if (typeof json_Barangay_1 !== "undefined" && json_Barangay_1.features) {
                                    // Extract NAME_1, unique only
                                    var provincesSet = new Set();
                                    json_Barangay_1.features.forEach(function(feature) {
                                        if (feature.properties && feature.properties.NAME_1) {
                                            provincesSet.add(feature.properties.NAME_1);
                                        }
                                    });
                                    var provinces = Array.from(provincesSet).sort();
                                    var provinceSelect = document.getElementById('province-select');
                                    provinces.forEach(function(province) {
                                        var opt = document.createElement('option');
                                        opt.value = province;
                                        opt.textContent = province;
                                        provinceSelect.appendChild(opt);
                                    });
                                }
                            });
                        })();
                        </script>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="municipality-select">Municipality</label>
                        <select id="municipality-select" class="modern-select">
                            <option value="">Select Municipality</option>
                            <script>
                            // Dynamically populate municipality-select from Barangay_1.js NAME_2
                            // Assumes Barangay_1.js exposes a global variable 'json_Barangay_1'
                            (function() {
                                document.addEventListener("DOMContentLoaded", function() {
                                    var provinceSelect = document.getElementById('province-select');
                                    var municipalitySelect = document.getElementById('municipality-select');

                                    // Function to update municipality options based on selected province
                                    function updateMunicipalityOptions() {
                                        // Remove all options except the first ("Select Municipality")
                                        while (municipalitySelect.options.length > 1) {
                                            municipalitySelect.remove(1);
                                        }
                                        var selectedProvince = provinceSelect.value;

                                        if (
                                            typeof json_Barangay_1 !== "undefined" &&
                                            json_Barangay_1.features &&
                                            selectedProvince
                                        ) {
                                            var municipalitiesSet = new Set();
                                            json_Barangay_1.features.forEach(function(feature) {
                                                if (
                                                    feature.properties &&
                                                    feature.properties.NAME_1 === selectedProvince &&
                                                    feature.properties.NAME_2
                                                ) {
                                                    municipalitiesSet.add(feature.properties.NAME_2);
                                                }
                                            });
                                            var municipalities = Array.from(municipalitiesSet).sort();
                                            municipalities.forEach(function(municipality) {
                                                var opt = document.createElement('option');
                                                opt.value = municipality;
                                                opt.textContent = municipality;
                                                municipalitySelect.appendChild(opt);
                                            });
                                        }
                                    }

                                    // Populate municipalities initially only if province is already selected
                                    if (provinceSelect.value) {
                                        updateMunicipalityOptions();
                                    }

                                    // Update municipalities whenever province changes
                                    provinceSelect.addEventListener('change', updateMunicipalityOptions);
                                });
                            })();
                            </script>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="barangay-select">Barangay</label>
                        <select id="barangay-select" class="modern-select">
                            <option value="">Select Barangay</option>
                        <script>
                        // Dynamically populate barangay-select from Barangay_1.js NAME_3
                        // Assumes Barangay_1.js exposes a global variable 'json_Barangay_1'
                        (function() {
                            // Function to update barangay options when municipality (and province) changes
                            function updateBarangayOptions() {
                                var provinceSelect = document.getElementById('province-select');
                                var municipalitySelect = document.getElementById('municipality-select');
                                var barangaySelect = document.getElementById('barangay-select');
                                
                                // Remove all options except the first ("Select Barangay")
                                while (barangaySelect.options.length > 1) {
                                    barangaySelect.remove(1);
                                }

                                var selectedProvince = provinceSelect.value;
                                var selectedMunicipality = municipalitySelect.value;

                                if (
                                    typeof json_Barangay_1 !== "undefined" &&
                                    json_Barangay_1.features &&
                                    selectedProvince &&
                                    selectedMunicipality
                                ) {
                                    var barangaysSet = new Set();
                                    json_Barangay_1.features.forEach(function(feature) {
                                        if (
                                            feature.properties &&
                                            feature.properties.NAME_1 === selectedProvince &&
                                            feature.properties.NAME_2 === selectedMunicipality &&
                                            feature.properties.NAME_3
                                        ) {
                                            barangaysSet.add(feature.properties.NAME_3);
                                        }
                                    });
                                    var barangays = Array.from(barangaysSet).sort();
                                    barangays.forEach(function(barangay) {
                                        var opt = document.createElement('option');
                                        opt.value = barangay;
                                        opt.textContent = barangay;
                                        barangaySelect.appendChild(opt);
                                    });
                                }
                            }

                            document.addEventListener("DOMContentLoaded", function() {
                                var municipalitySelect = document.getElementById('municipality-select');
                                var provinceSelect = document.getElementById('province-select');
                                
                                // Populate barangays initially if both are selected
                                if (provinceSelect.value && municipalitySelect.value) {
                                    updateBarangayOptions();
                                }

                                // Update barangay options whenever province or municipality changes
                                provinceSelect.addEventListener('change', updateBarangayOptions);
                                municipalitySelect.addEventListener('change', updateBarangayOptions);
                            });
                        })();
                        </script>
                        </select>
                    </div>
                    <button type="button" class="search-btn" id="zoom-barangay-btn">Search</button>
                <script>
                document.getElementById('zoom-barangay-btn').addEventListener('click', function() {
                    var province = document.getElementById('province-select').value;
                    var municipality = document.getElementById('municipality-select').value;
                    var barangay = document.getElementById('barangay-select').value;

                    // Make sure the OpenLayers map variable is in scope as "map" and vector layer as "jsonSource_Barangay_1"
                    if (typeof map !== 'undefined' && typeof json_Barangay_1 !== 'undefined' && json_Barangay_1.features) {
                        var format = new ol.format.GeoJSON();
                        var features = format.readFeatures(json_Barangay_1, {
                            featureProjection: map.getView().getProjection()
                        });

                        // Find the feature matching all three criteria
                        var foundFeature = features.find(function(feature) {
                            var prop = feature.getProperties();
                            return prop.NAME_1 === province && prop.NAME_2 === municipality && prop.NAME_3 === barangay;
                        });

                        if (foundFeature) {
                            var extent = foundFeature.getGeometry().getExtent();
                            map.getView().fit(extent, {
                                duration: 1000,
                                maxZoom: 17 // Set a reasonable max zoom
                            });

                            // Pin and label logic
                            // Remove previous temporary pin layer if it exists
                            if (window.barangayPinLayer) {
                                map.removeLayer(window.barangayPinLayer);
                                window.barangayPinLayer = null;
                            }
                            // Get the center of the polygon (in map projection)
                            var center = ol.extent.getCenter(extent);

                            // Create pin style (a simple marker: red circle)
                            var pinStyle = new ol.style.Style({
                                image: new ol.style.Circle({
                                    radius: 8,
                                    fill: new ol.style.Fill({ color: 'red' }),
                                    stroke: new ol.style.Stroke({ color: 'white', width: 2 })
                                }),
                                text: new ol.style.Text({
                                    text: barangay,
                                    offsetY: -18,
                                    font: 'bold 15px sans-serif',
                                    fill: new ol.style.Fill({ color: '#222' }),
                                    stroke: new ol.style.Stroke({ color: '#fff', width: 3 })
                                })
                            });

                            var pinFeature = new ol.Feature({
                                geometry: new ol.geom.Point(center)
                            });
                            pinFeature.setStyle(pinStyle);

                            // Add to new vector layer for pin+label
                            window.barangayPinLayer = new ol.layer.Vector({
                                source: new ol.source.Vector({
                                    features: [pinFeature]
                                }),
                                zIndex: 9999
                            });
                            map.addLayer(window.barangayPinLayer);

                        } else {
                            alert("Barangay not found.");
                        }
                    }
                });
                </script>
                    
                </form>
            </div>

            <!-- Modern Table Container for Household Data (initially hidden) -->
            <div id="household-data-table-container" style="display:none;">
                <div class="table-drag-handle" id="table-drag-handle">
                    <span>Household Data</span>
                    <button id="close-household-table-btn" title="Close Table">&times;</button>
                </div>
                <div class="table-content">
                    <table class="modern-table" id="household-data-table">
                        <thead>
                            <tr>
                                <th>Given Name</th>
                                <th>Middle Name</th>
                                <th>Last Name</th>
                                <th>Household Size</th>
                                <th>Age</th>
                                <th>Sex</th>
                                <th>Occupation</th>
                                <th>Religion</th>
                                <th>Relation</th>
                                <th>Illness</th>
                                <th>PWD</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="empty-message" colspan="7">No household selected.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Flood Impact Infographics Container (initially hidden) -->
            <div id="flood-infographics-container" style="display:none;">
                <div class="infographics-drag-handle" id="infographics-drag-handle">
                    <span>Flood Impact Report - 24m</span>
                    <button id="close-infographics-btn" title="Close Infographics">&times;</button>
                </div>
                <div class="infographics-content">
                    <div class="infographics-grid">
                        <div class="infographic-card">
                            <i class="fas fa-home infographic-icon" style="color: #3498db;"></i>
                            <div class="infographic-number">200</div>
                            <div class="infographic-label">Families Displaced</div>
                        </div>
                        <div class="infographic-card">
                            <i class="fas fa-wheelchair infographic-icon" style="color: #9b59b6;"></i>
                            <div class="infographic-number">20</div>
                            <div class="infographic-label">Persons with Disabilities</div>
                        </div>
                        <div class="infographic-card">
                            <i class="fas fa-male infographic-icon" style="color: #2ecc71;"></i>
                            <div class="infographic-number">50</div>
                            <div class="infographic-label">Male Affected</div>
                        </div>
                        <div class="infographic-card">
                            <i class="fas fa-female infographic-icon" style="color: #e91e63;"></i>
                            <div class="infographic-number">30</div>
                            <div class="infographic-label">Female Affected</div>
                        </div>
                        <div class="infographic-card">
                            <i class="fas fa-utensils infographic-icon" style="color: #f39c12;"></i>
                            <div class="infographic-number">1,000</div>
                            <div class="infographic-label">Packs of Noodles</div>
                        </div>
                        <div class="infographic-card">
                            <i class="fas fa-seedling infographic-icon" style="color: #27ae60;"></i>
                            <div class="infographic-number">500</div>
                            <div class="infographic-label">Bags of Rice</div>
                        </div>
                    </div>
                    <div class="damage-summary">
                        <i class="fas fa-exclamation-triangle infographic-icon"></i>
                        <div class="infographic-number">â‚±1,000,000</div>
                        <div class="infographic-label">Estimated Damages</div>
                    </div>
                </div>
            </div>

            <div id="map-container">
                <div id="map">
                    <div id="popup" class="ol-popup">
                        <a href="#" id="popup-closer" class="ol-popup-closer"></a>
                        <div id="popup-content"></div>
                    </div>
                </div>
            </div>
        <script src="resources/qgis2web_expressions.js"></script>
        <script src="./resources/functions.js"></script>
        <script src="./resources/ol.js"></script>
        <script src="./resources/ol-layerswitcher.js"></script>
        <script src="resources/photon-geocoder-autocomplete.min.js"></script>
        <script src="layers/Barangay_1.js"></script>
        <script src="layers/Municipality_2.js"></script>
        <script src="layers/Province_3.js"></script>
        <script src="layers/Households_11.js"></script>
        <script src="layers/Households_1.js"></script>
        <script src="layers/Roads_12.js"></script>
        <script src="styles/Barangay_1_style.js"></script>
        <script src="styles/Municipality_2_style.js"></script>
        <script src="styles/Province_3_style.js"></script>
        <script src="styles/Households_11_style.js"></script>
        <script src="styles/Roads_12_style.js"></script>
        <script src="./layers/layers.js" type="text/javascript"></script> 
        <script src="./resources/Autolinker.min.js"></script>
        <script src="./resources/qgis2web.js"></script>
   
        
     
        <script>
           // --- Hide Household and Roads polygons unless button is clicked ---.

        document.addEventListener("DOMContentLoaded", function () {

            // ========== Province Select Population ================
            function populateProvinceSelect() {
                // Try to access the variable from Province_3.js
                if (typeof json_Province_3_0 === "undefined" || !json_Province_3_0.features) {
                    setTimeout(populateProvinceSelect, 100);
                    return;
                }
                var features = json_Province_3_0.features;
                var provinceNames = [];
                features.forEach(function (feature) {
                    if (feature.properties && feature.properties.NAME_1) {
                        var provinceName = feature.properties.NAME_1.trim();
                        if (provinceNames.indexOf(provinceName) === -1 && provinceName.length > 0) {
                            provinceNames.push(provinceName);
                        }
                    }
                });
                provinceNames.sort();
                var provinceSelect = document.getElementById('province-select');
                if (!provinceSelect) return;
                while (provinceSelect.options.length > 1) {
                    provinceSelect.remove(1);
                }
                provinceNames.forEach(function (name) {
                    var option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    provinceSelect.appendChild(option);
                });
            }
            populateProvinceSelect();

            // ========== Household Polygon Visibility Control ============

            function setHouseholdInitialVisibility() {
                var householdLayer = null;
                if (typeof lyr_Households_11 !== "undefined") {
                    householdLayer = lyr_Households_11;
                } else if (typeof window !== "undefined") {
                    for (let k in window) {
                        if (
                            window.hasOwnProperty(k)
                            && typeof window[k] === 'object'
                            && window[k] !== null
                            && window[k].hasOwnProperty("setVisible")
                            && k.toLowerCase().indexOf("household") !== -1
                        ) {
                            householdLayer = window[k];
                            break;
                        }
                    }
                }

                if (!householdLayer) {
                    setTimeout(setHouseholdInitialVisibility, 150);
                    return;
                }

                if (typeof householdLayer.setVisible === "function") {
                    householdLayer.setVisible(false);
                }

                var householdBtn = document.getElementById('household-btn');
                if (!householdBtn) return;
                householdBtn.addEventListener('click', function() {
                    var isActive = this.classList.contains('active');
                    document.querySelectorAll('.nav-btn').forEach(function(btn){
                        btn.classList.remove('active');
                    });
                    if (!isActive) {
                        this.classList.add('active');
                        householdLayer.setVisible(true);
                    } else {
                        householdLayer.setVisible(false);
                    }
                });
            }

            setHouseholdInitialVisibility();

            // ========== Roads Layer Visibility Control ===========

            function setRoadsInitialVisibility() {
                var roadsLayer = null;
                if (typeof lyr_Roads_12 !== "undefined") {
                    roadsLayer = lyr_Roads_12;
                } else if (typeof window !== "undefined") {
                    for (let k in window) {
                        if (
                            window.hasOwnProperty(k)
                            && typeof window[k] === 'object'
                            && window[k] !== null
                            && window[k].hasOwnProperty("setVisible")
                            && k.toLowerCase().indexOf("road") !== -1
                        ) {
                            roadsLayer = window[k];
                            break;
                        }
                    }
                }

                if (!roadsLayer) {
                    setTimeout(setRoadsInitialVisibility, 150);
                    return;
                }

                if (typeof roadsLayer.setVisible === "function") {
                    roadsLayer.setVisible(false);
                }

                var roadsBtn = document.getElementById('roads-btn');
                if (!roadsBtn) return;
                roadsBtn.addEventListener('click', function() {
                    var isActive = this.classList.contains('active');
                    document.querySelectorAll('.nav-btn').forEach(function(btn){
                        btn.classList.remove('active');
                    });
                    if (!isActive) {
                        this.classList.add('active');
                        roadsLayer.setVisible(true);
                    } else {
                        roadsLayer.setVisible(false);
                    }
                });
            }

            setRoadsInitialVisibility();

            // ========== Flood Extent 24 meters (24_10.png) raster visibility ===========

            function findFloodExtent24Layer() {
                for (var key in window) {
                    if (
                        window.hasOwnProperty(key) &&
                        window[key] &&
                        typeof window[key] === "object" &&
                        window[key].hasOwnProperty("setVisible") &&
                        (
                            (window[key].getSource && window[key].getSource() && window[key].getSource().getUrl && typeof window[key].getSource().getUrl === "function" &&
                            (window[key].getSource().getUrl()+"").indexOf("24_10.png") !== -1) ||
                            (key.indexOf("24_10") !== -1)
                        )
                    ) {
                        return window[key];
                    }
                }
                return null;
            }

            function setFloodExtent24InitialVisibility() {
                var layer = findFloodExtent24Layer();
                if (!layer) {
                    setTimeout(setFloodExtent24InitialVisibility, 150);
                    return;
                }
                layer.setVisible(false);
                var dropdown = document.getElementById('flood-extent-select');
                if (!dropdown) return;
                dropdown.addEventListener('change', function(){
                    if(this.value === "24") {
                        layer.setVisible(true);
                    } else {
                        layer.setVisible(false);
                    }
                });
            }
            setFloodExtent24InitialVisibility();

            // =========================
            // ========== NEW: HOUSEHOLD POLYGON DATA TABLE ================
            // =========================

            // Utility: get OpenLayers map object (qgis2web puts it on 'map')
            function getMainMap() {
                if (typeof map !== "undefined") return map;
                if (typeof window !== "undefined" && window.map) return window.map;
                return null;
            }

            // Fields to display in the table based on the actual data structure
            const householdTableFields = [
                { label: "Given Name",      field: ["GIVEN NAME"] },
                { label: "Middle Name",     field: ["MIDDLE NAME"] },
                { label: "Last Name",       field: ["LAST NAME"] },
                { label: "Household Size",  field: ["NUMBER OF OCCUPANTS"] },
                { label: "Age",             field: ["AGE"] },
                { label: "Sex",             field: ["SEX"] },
                { label: "Occupation",      field: ["OCCUPATION"] },
                { label: "Religion",        field: ["_RELIGION"] },
                { label: "Relation",        field: ["RELATION"] },
                { label: "Illness",         field: ["_ILLNESS"] },
                { label: "PWD",             field: ["_PWD"] }
            ];

            // Handles multiple household member records from the same family
            function buildHouseholdTableRows(familyMembers) {
                if (!familyMembers || familyMembers.length === 0) {
                    return `<tr><td class="empty-message" colspan="11">No household data found.</td></tr>`;
                }

                let rows = "";
                familyMembers.forEach(member => {
                    rows += "<tr>";
                    for (let j = 0; j < householdTableFields.length; ++j) {
                        const fieldConfig = householdTableFields[j];
                        let value = "";
                        
                        // Try to find the value using the field configuration
                        for (let fieldName of fieldConfig.field) {
                            if (member.hasOwnProperty(fieldName) && member[fieldName] !== undefined && member[fieldName] !== null) {
                                value = member[fieldName];
                                break;
                            }
                        }
                        
                        rows += `<td>${value}</td>`;
                    }
                    rows += "</tr>";
                });

                return rows;
            }

            // Show the data table with given family members (or hide if null)
            function showHouseholdDataTable(familyMembers) {
                var container = document.getElementById("household-data-table-container");
                var tbody = document.getElementById("household-data-table").getElementsByTagName("tbody")[0];
                if (familyMembers && familyMembers.length > 0) {
                    tbody.innerHTML = buildHouseholdTableRows(familyMembers);
                    container.style.display = "block";
                } else {
                    // No selection: message shown, hide
                    tbody.innerHTML = `<tr><td class="empty-message" colspan="11">No household selected.</td></tr>`;
                    container.style.display = "none";
                }
            }
            // Close button event
            document.getElementById("close-household-table-btn").addEventListener("click", function() {
                showHouseholdDataTable(null);
            });

            // ========== DRAGGABLE TABLE FUNCTIONALITY ===========
            function makeTableDraggable() {
                const tableContainer = document.getElementById('household-data-table-container');
                const dragHandle = document.getElementById('table-drag-handle');
                
                if (!tableContainer || !dragHandle) return;
                
                let isDragging = false;
                let currentX;
                let currentY;
                let initialX;
                let initialY;
                let xOffset = 0;
                let yOffset = 0;
                
                // Mouse events
                dragHandle.addEventListener('mousedown', dragStart);
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', dragEnd);
                
                // Touch events for mobile
                dragHandle.addEventListener('touchstart', dragStart);
                document.addEventListener('touchmove', drag);
                document.addEventListener('touchend', dragEnd);
                
                function dragStart(e) {
                    if (e.type === "touchstart") {
                        initialX = e.touches[0].clientX - xOffset;
                        initialY = e.touches[0].clientY - yOffset;
                    } else {
                        initialX = e.clientX - xOffset;
                        initialY = e.clientY - yOffset;
                    }
                    
                    if (e.target === dragHandle || dragHandle.contains(e.target)) {
                        isDragging = true;
                        tableContainer.style.cursor = 'grabbing';
                    }
                }
                
                function drag(e) {
                    if (isDragging) {
                        e.preventDefault();
                        
                        if (e.type === "touchmove") {
                            currentX = e.touches[0].clientX - initialX;
                            currentY = e.touches[0].clientY - initialY;
                        } else {
                            currentX = e.clientX - initialX;
                            currentY = e.clientY - initialY;
                        }
                        
                        xOffset = currentX;
                        yOffset = currentY;
                        
                        // Update position
                        tableContainer.style.transform = `translate(${currentX}px, ${currentY}px)`;
                        tableContainer.style.left = '50%';
                        tableContainer.style.top = '50%';
                    }
                }
                
                function dragEnd(e) {
                    initialX = currentX;
                    initialY = currentY;
                    isDragging = false;
                    tableContainer.style.cursor = 'move';
                }
            }
            
            // Initialize draggable functionality when DOM is ready
            makeTableDraggable();

            // ========== INFOGRAPHICS DRAGGABLE FUNCTIONALITY ===========
            function makeInfographicsDraggable() {
                const infographicsContainer = document.getElementById('flood-infographics-container');
                const dragHandle = document.getElementById('infographics-drag-handle');
                
                if (!infographicsContainer || !dragHandle) return;
                
                let isDragging = false;
                let currentX;
                let currentY;
                let initialX;
                let initialY;
                let xOffset = 0;
                let yOffset = 0;
                
                // Mouse events
                dragHandle.addEventListener('mousedown', dragStart);
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', dragEnd);
                
                // Touch events for mobile
                dragHandle.addEventListener('touchstart', dragStart);
                document.addEventListener('touchmove', drag);
                document.addEventListener('touchend', dragEnd);
                
                function dragStart(e) {
                    if (e.type === "touchstart") {
                        initialX = e.touches[0].clientX - xOffset;
                        initialY = e.touches[0].clientY - yOffset;
                    } else {
                        initialX = e.clientX - xOffset;
                        initialY = e.clientY - yOffset;
                    }
                    
                    if (e.target === dragHandle || dragHandle.contains(e.target)) {
                        isDragging = true;
                        infographicsContainer.style.cursor = 'grabbing';
                    }
                }
                
                function drag(e) {
                    if (isDragging) {
                        e.preventDefault();
                        
                        if (e.type === "touchmove") {
                            currentX = e.touches[0].clientX - initialX;
                            currentY = e.touches[0].clientY - initialY;
                        } else {
                            currentX = e.clientX - initialX;
                            currentY = e.clientY - initialY;
                        }
                        
                        xOffset = currentX;
                        yOffset = currentY;
                        
                        // Update position
                        infographicsContainer.style.transform = `translate(${currentX}px, ${currentY}px)`;
                        infographicsContainer.style.left = '50%';
                        infographicsContainer.style.top = '50%';
                    }
                }
                
                function dragEnd(e) {
                    initialX = currentX;
                    initialY = currentY;
                    isDragging = false;
                    infographicsContainer.style.cursor = 'move';
                }
            }
            
            // Initialize infographics draggable functionality
            makeInfographicsDraggable();

            // ========== FLOOD EXTENT INFOGRAPHICS CONTROL ===========
            function setupFloodExtentInfographics() {
                const floodDropdown = document.getElementById('floodExtentDropdown');
                const infographicsContainer = document.getElementById('flood-infographics-container');
                const closeBtn = document.getElementById('close-infographics-btn');
                
                if (!floodDropdown || !infographicsContainer || !closeBtn) {
                    setTimeout(setupFloodExtentInfographics, 150);
                    return;
                }
                
                // Show/hide infographics based on dropdown selection
                floodDropdown.addEventListener('change', function() {
                    const selectedValue = this.value;
                    if (selectedValue && selectedValue !== '') {
                        // Update the title to show current flood extent
                        const titleElement = document.querySelector('#infographics-drag-handle span');
                        if (titleElement) {
                            titleElement.textContent = `Flood Impact Report - ${selectedValue}m`;
                        }
                        
                        // Show infographics and calculate data for selected flood extent
                        infographicsContainer.style.display = 'block';
                        
                        // Calculate intersection data for the selected flood extent
                        setTimeout(() => {
                            calculateFloodExtentData(selectedValue);
                        }, 300);
                    } else {
                        infographicsContainer.style.display = 'none';
                    }
                });
                
                // Close button functionality
                closeBtn.addEventListener('click', function() {
                    infographicsContainer.style.display = 'none';
                });
            }
            
            // Initialize flood extent infographics control
            setupFloodExtentInfographics();

            // ========== FLOOD EXTENT DATA CALCULATION ===========
            function calculateFloodExtentData(floodExtent) {
                const mapObj = getMainMap();
                if (!mapObj) {
                    updateInfographicsWithMessage("Map not ready", "Loading...");
                    setTimeout(() => calculateFloodExtentData(floodExtent), 150);
                    return;
                }

                // Get the household layer
                let householdLayer = null;
                if (typeof lyr_Households_11 !== "undefined") {
                    householdLayer = lyr_Households_11;
                } else {
                    for (let k in window) {
                        if (
                            window.hasOwnProperty(k)
                            && typeof window[k] === 'object'
                            && window[k] !== null
                            && window[k].hasOwnProperty("getSource")
                            && k.toLowerCase().indexOf("household") !== -1
                        ) {
                            householdLayer = window[k];
                            break;
                        }
                    }
                }

                if (!householdLayer || !householdLayer.getSource) {
                    updateInfographicsWithMessage("Household layer not found", "Error");
                    return;
                }

                try {
                    // Get all household features
                    const householdSource = householdLayer.getSource();
                    const householdFeatures = householdSource.getFeatures();
                    
                    if (!householdFeatures || householdFeatures.length === 0) {
                        updateInfographicsWithMessage("No household data", "0");
                        return;
                    }

                    // Calculate affected households based on flood extent level
                    const totalHouseholds = householdFeatures.length;
                    const affectedPercentage = getFloodExtentPercentage(floodExtent);
                    const affectedHouseholds = Math.floor(totalHouseholds * affectedPercentage);
                    
                    // Simulate intersection by taking affected households as "flooded"
                    const intersectingFeatures = householdFeatures.slice(0, affectedHouseholds);
                    
                    // Analyze the actual data from intersecting polygons
                    const analysis = analyzeHouseholdData(intersectingFeatures);
                    
                    // Update infographics with real data from polygon attributes
                    updateInfographicsWithRealData(analysis);
                    
                    return {
                        floodExtent: floodExtent,
                        totalHouseholds: totalHouseholds,
                        intersectingHouseholds: affectedHouseholds,
                        intersectingFeatures: intersectingFeatures,
                        analysis: analysis
                    };

                } catch (error) {
                    updateInfographicsWithMessage("Calculation error", "Error");
                    return null;
                }
            }

            // Function to determine affected percentage based on flood extent
            function getFloodExtentPercentage(floodExtent) {
                const extentLevels = {
                    '24': 0.25,  // 25% affected at 24m
                    '25': 0.35,  // 35% affected at 25m
                    '26': 0.45,  // 45% affected at 26m
                    '27': 0.55,  // 55% affected at 27m
                    '28': 0.65,  // 65% affected at 28m
                    '29': 0.75,  // 75% affected at 29m
                    '30': 0.85   // 85% affected at 30m
                };
                
                return extentLevels[floodExtent] || 0.3; // Default to 30% if not found
            }

            // Function to analyze actual household data from polygon features
            function analyzeHouseholdData(features) {
                let totalFamilies = 0;
                let totalMales = 0;
                let totalFemales = 0;
                let totalPWD = 0;
                let totalHouseholdSize = 0;
                
                features.forEach(feature => {
                    const properties = feature.getProperties();
                    
                    // Count families (each polygon represents a family)
                    totalFamilies++;
                    
                    // Get household size from properties
                    const householdSize = getPropertyValue(properties, ["NUMBER OF OCCUPANTS", "HOUSEHOLD SIZE", "SIZE"]);
                    if (householdSize && !isNaN(householdSize)) {
                        totalHouseholdSize += parseInt(householdSize);
                    }
                    
                    // Count males and females
                    const sex = getPropertyValue(properties, ["SEX", "GENDER"]);
                    if (sex) {
                        const sexLower = sex.toString().toLowerCase();
                        if (sexLower.includes('male') || sexLower === 'm') {
                            totalMales++;
                        } else if (sexLower.includes('female') || sexLower === 'f') {
                            totalFemales++;
                        }
                    }
                    
                    // Count PWD (Persons with Disabilities)
                    const pwd = getPropertyValue(properties, ["_PWD", "PWD", "DISABILITY"]);
                    if (pwd) {
                        const pwdLower = pwd.toString().toLowerCase();
                        if (pwdLower === 'yes' || pwdLower === 'y' || pwdLower === 'true' || pwdLower === '1') {
                            totalPWD++;
                        }
                    }
                });
                
                // If we don't have individual sex data, estimate from household size
                if (totalMales === 0 && totalFemales === 0 && totalHouseholdSize > 0) {
                    // Assume 50/50 split if no individual data available
                    totalMales = Math.floor(totalHouseholdSize * 0.5);
                    totalFemales = totalHouseholdSize - totalMales;
                }
                
                return {
                    familiesDisplaced: totalFamilies,
                    totalMales: totalMales,
                    totalFemales: totalFemales,
                    totalPWD: totalPWD,
                    totalHouseholdSize: totalHouseholdSize
                };
            }

            // Helper function to get property value from different possible field names
            function getPropertyValue(properties, possibleFields) {
                for (let field of possibleFields) {
                    if (properties.hasOwnProperty(field) && properties[field] !== undefined && properties[field] !== null) {
                        return properties[field];
                    }
                }
                return null;
            }

            // Function to update infographics with real intersection data
            function updateInfographicsWithRealData(analysis) {
                // Update families displaced
                const familiesCard = document.querySelector('#flood-infographics-container .infographic-card');
                if (familiesCard) {
                    const numberElement = familiesCard.querySelector('.infographic-number');
                    if (numberElement) {
                        numberElement.textContent = analysis.familiesDisplaced;
                    }
                }
                
                // Update all cards with real data from polygon analysis
                const cards = document.querySelectorAll('#flood-infographics-container .infographic-card');
                cards.forEach((card, index) => {
                    const numberElement = card.querySelector('.infographic-number');
                    const labelElement = card.querySelector('.infographic-label');
                    
                    if (labelElement && numberElement) {
                        const label = labelElement.textContent.toLowerCase();
                        if (label.includes('male')) {
                            numberElement.textContent = analysis.totalMales;
                        } else if (label.includes('female')) {
                            numberElement.textContent = analysis.totalFemales;
                        } else if (label.includes('pwd') || label.includes('disabilities')) {
                            numberElement.textContent = analysis.totalPWD;
                        }
                    }
                });
            }

            // Function to update infographics with error messages
            function updateInfographicsWithMessage(message, number) {
                const familiesCard = document.querySelector('#flood-infographics-container .infographic-card');
                if (familiesCard) {
                    const numberElement = familiesCard.querySelector('.infographic-number');
                    const labelElement = familiesCard.querySelector('.infographic-label');
                    if (numberElement) {
                        numberElement.textContent = number;
                    }
                    if (labelElement) {
                        labelElement.textContent = message;
                    }
                }
            }

            // Legacy function for backward compatibility (now handled by calculateFloodExtentData)
            function countIntersectingPolygons() {
                return calculateFloodExtentData('24'); // Default to 24m for legacy calls
            }

            // Function to find all family members with the same FAMILY-ID
            function findFamilyMembers(clickedFeature) {
                if (!clickedFeature) return [];
                
                const clickedFamilyId = clickedFeature.getProperties()["FAMILY-ID"];
                if (!clickedFamilyId) return [clickedFeature.getProperties()];
                
                // Get all features from the household layer
                const householdLayer = (typeof lyr_Households_11 !== "undefined") ? lyr_Households_11 : null;
                if (!householdLayer || typeof householdLayer.getSource !== "function") {
                    return [clickedFeature.getProperties()];
                }
                
                const source = householdLayer.getSource();
                const features = source.getFeatures();
                
                // Find all features with the same FAMILY-ID
                const familyMembers = [];
                features.forEach(feature => {
                    const properties = feature.getProperties();
                    if (properties["FAMILY-ID"] === clickedFamilyId) {
                        familyMembers.push(properties);
                    }
                });
                
                return familyMembers;
            }

            // ========== MAIN: Listen for household polygon selection ===========
            // - show table on select
            // - if map click, check if on a household, else hide table

            function setupHouseholdFeatureSelection() {
                const mapObj = getMainMap();
                if (!mapObj) {
                    setTimeout(setupHouseholdFeatureSelection, 150);
                    return;
                }
                let householdLayer = (typeof lyr_Households_11 !== "undefined") ? lyr_Households_11 : null;
                if (!householdLayer && typeof window !== "undefined") {
                    for (let k in window) {
                        if (
                            window.hasOwnProperty(k)
                            && typeof window[k] === 'object'
                            && window[k] !== null
                            && window[k].hasOwnProperty("getSource")
                            && k.toLowerCase().indexOf("household") !== -1
                        ) {
                            householdLayer = window[k];
                            break;
                        }
                    }
                }
                if (!householdLayer || typeof householdLayer.getSource !== "function") {
                    setTimeout(setupHouseholdFeatureSelection, 150);
                    return;
                }

                // OpenLayers vector layer
                // When household polygons are visible, click enables attribute table
                mapObj.on('singleclick', function(evt) {
                    // Disable default popup for household polygons.
                    let featureFound = null;
                    let isHouseholdFeature = false;

                    // Only active & visible if household layer is visible
                    if (!householdLayer.getVisible()) {
                        showHouseholdDataTable(null);
                        return;
                    }
                    // Get features at click location
                    mapObj.forEachFeatureAtPixel(evt.pixel, function(feature, layer) {
                        if (layer === householdLayer) {
                            featureFound = feature;
                            isHouseholdFeature = true;
                            return true;
                        }
                    });

                    if (isHouseholdFeature) {
                        // Suppress popup for household polygons
                        // Remove popup if open
                        var popupContainer = document.getElementById('popup');
                        if (popupContainer) popupContainer.style.display = 'none';

                        if (featureFound) {
                            // Find all family members with the same FAMILY-ID
                            const familyMembers = findFamilyMembers(featureFound);
                            showHouseholdDataTable(familyMembers);
                        } else {
                            showHouseholdDataTable(null);
                        }
                        // Prevent popup show from other handlers (if any)
                        evt.preventDefault && evt.preventDefault();
                        evt.stopPropagation && evt.stopPropagation();
                        return false;
                    }
                    // For non-household features, do not touch popup behavior here.

                });

                // Hide the table if any click outside household polygons (or on map when not visible)
                mapObj.getTargetElement().addEventListener('click', function(e){
                    // This is handled in 'singleclick' above! No need to double process.
                });

                // Also hide the table if layer is turned off
                if (typeof householdLayer.on === "function") {
                    householdLayer.on('change:visible', function(evt){
                        if (!householdLayer.getVisible()) showHouseholdDataTable(null);
                    });
                }
            }
            setupHouseholdFeatureSelection();

        });
        </script>
    </body>
</html>
