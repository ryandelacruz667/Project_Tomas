<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="./resources/ol.css">
        <link rel="stylesheet" href="resources/fontawesome-all.min.css">
        <link href="resources/photon-geocoder-autocomplete.min.css" rel="stylesheet">
        <link rel="stylesheet" href="./resources/ol-layerswitcher.css">
        <link rel="stylesheet" href="./resources/qgis2web.css">
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
        <style>
        html, body {
            background-color: #ffffff;
        }
        .ol-control > * {
            background-color: #f8f8f8!important;
            color: #444444!important;
            border-radius: 0px;
        }
        .ol-attribution a, .gcd-gl-input::placeholder, .search-layer-input-search::placeholder {
            color: #444444!important;
        }
        .search-layer-input-search {
            background-color: #f8f8f8!important;
        }
        .ol-control > *:focus, .ol-control >*:hover {
            background-color: rgba(248, 248, 248, 0.7)!important;
        } 
        .ol-control {
            background-color: rgba(255,255,255,.4) !important;
            padding: 2px !important;
        } 
        </style>

        <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }

        body, html {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        #main-wrapper {
            display: flex;
            flex-direction: row;
            height: 100vh;
            width: 100vw;
            position: relative;
        }

        #left-pane {
            width: 320px;
            background: #23272f;
            color: #fff;
            height: 100vh;
            box-shadow: 2px 0 8px rgba(34,34,34,0.04);
            display: flex;
            flex-direction: column;
            padding: 0;
            z-index: 10;
            overflow: hidden;
            position: fixed;
            left: 0;
            top: 0;
        }
        
        /* Ensure all child elements inherit the dark background */
        #left-pane * {
            background-color: inherit;
        }
        
        /* Override any white backgrounds that might be inherited */
        #left-pane .sidebar-header,
        #left-pane .nav-bar,
        #left-pane .flood-section,
        #left-pane .flood-form-group,
        #left-pane .flood-legend-section {
            background: #23272f !important;
        }
        .sidebar-header {
            font-size: 1.6rem;
            font-weight: 700;
            text-align: left;
            padding: 1.5rem 1.5rem 0.8rem 1.5rem;
            letter-spacing: 0.3px;
            border-bottom: none;
            color: #fafafa;
            background: #23272f;
        }
        .sidebar-header span {
            border-bottom: 3px solid #24b2ff;
            padding-bottom: 0.2rem;
            color: #24b2ff;
            font-size: 1.3rem;
            display: inline-block;
            letter-spacing: 0.5px;
        }
        .sidebar-header.flood-header {
            /* Same as .sidebar-header but separate class for Flood Extent */
            font-size: 1.6rem;
            font-weight: 700;
            text-align: left;
            padding: 1.5rem 1.5rem 0.8rem 1.5rem;
            letter-spacing: 0.3px;
            border-bottom: none;
            color: #fafafa;
            background: #23272f;
        }
        .sidebar-header.flood-header span {
            border-bottom: 3px solid #f39c12;
            padding-bottom: 0.2rem;
            color: #f39c12;
            font-size: 1.3rem;
            display: inline-block;
            letter-spacing: 0.5px;
        }
        .nav-bar {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            margin-top: 1rem;
            padding: 0 1.2rem;
        }
        .nav-btn {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.7rem 1rem;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            outline: none;
            background: none;
            color: #fafafa;
            transition: background 0.18s, color 0.18s;
            border-radius: 8px;
            cursor: pointer;
            letter-spacing: 0.5px;
        }
        .nav-btn i {
            font-size: 1.2rem;
        }
        .nav-btn:hover, .nav-btn.active {
            background: #24b2ff;
            color: #fff;
        }
        .nav-btn.is-disabled {
            opacity: 0.45;
            cursor: not-allowed;
            pointer-events: none;
            background: rgba(36, 178, 255, 0.08);
            color: #8d939f;
        }
        button.is-disabled {
            opacity: 0.5;
            cursor: not-allowed !important;
            pointer-events: none;
        }
        /* Flood hazard section style */
        .flood-section {
            margin-top: 1.5rem;
        }
        .flood-form-group {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
            margin: 0 1.5rem 1rem 1.5rem;
        }
        .flood-form-label {
            font-size: 1.03rem;
            color: #f39c12;
            font-weight: 600;
            margin-bottom: 0.35rem;
            margin-left: 2px;
            letter-spacing: 0.5px;
        }
        .flood-modern-select {
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 8px;
            background: #262a33;
            color: #fafafa;
            font-size: 1.08rem;
            font-weight: 500;
            outline: none;
            transition: background 0.14s;
            min-width: 135px;
            box-shadow: 0 0 0 1px #222326;
            position: relative;
            z-index: 1; /* Below charts panel (999) and table (1001) */
            overflow: visible;
        }
        .flood-modern-select:focus {
            background: #181b1f;
            box-shadow: 0 0 0 1.5px #f39c12;
            z-index: 100; /* Higher when focused to show dropdown options */
        }
        .flood-modern-select.is-disabled {
            opacity: 0.45;
            cursor: not-allowed;
        }
        .flood-divider {
            border: none;
            border-top: 2px solid #444;
            margin: 1.2rem 2rem 0.5rem 2rem;
        }
        
        /* Flood Legend Styles */
        .flood-legend-section {
            margin: 0.8rem 2rem 0.8rem 2rem;
        }
        .flood-legend-section:first-of-type {
            margin: 1.5rem 2rem 1rem 2rem;
        }
        .flood-legend {
            background: #262a33;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 0.5rem;
            border: 1px solid #333;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin-bottom: 0.6rem;
            padding: 0.3rem 0;
        }
        .legend-item:last-child {
            margin-bottom: 0;
        }
        .legend-icon {
            width: 20px;
            height: 20px;
            border-radius: 2px;
            flex-shrink: 0;
        }
        .legend-text {
            color: #fafafa;
            font-size: 0.95rem;
            font-weight: 500;
        }

        /* Top Pane Styles */
        #top-pane {
            position: fixed;
            left: 320px;
            top: 0;
            right: 0;
            height: 72px;
            background: #23272f;
            color: #fafafa;
            display: flex;
            align-items: center;
            z-index: 9;
            box-shadow: 0 2px 8px rgba(34,34,34,0.04);
            padding-left: 2.5rem;
            padding-right: 3rem;
        }
        
        .search-form {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            width: 100%;
            max-width: 600px;
            margin-left: 0;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .form-label {
            font-size: 1.03rem;
            color: #24b2ff;
            font-weight: 600;
            margin-bottom: 0.35rem;
            margin-left: 2px;
            letter-spacing: 0.5px;
        }
        .modern-select {
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 8px;
            background: #262a33;
            color: #fafafa;
            font-size: 1.08rem;
            font-weight: 500;
            outline: none;
            transition: background 0.14s;
            min-width: 135px;
            box-shadow: 0 0 0 1px #222326;
            position: relative;
            z-index: 1; /* Below charts panel (999) and table (1001) */
            overflow: visible;
        }
        .modern-select:focus {
            background: #181b1f;
            box-shadow: 0 0 0 1.5px #24b2ff;
            z-index: 100; /* Higher when focused to show dropdown options */
        }
        .modern-multiselect {
            position: relative;
            min-width: 135px;
        }
        .multiselect-button {
            width: 100%;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
        }
        .multiselect-button::after {
            content: '\25BC';
            font-size: 0.8rem;
            color: #9aa0ae;
            transition: transform 0.2s ease;
        }
        .multiselect-button.is-open::after {
            transform: rotate(180deg);
        }
        .multiselect-dropdown {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            right: 0;
            background: #262a33;
            border-radius: 10px;
            border: 1px solid #3a3f4a;
            padding: 0.5rem 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.35);
            display: none;
            max-height: 240px;
            overflow-y: auto;
            z-index: 150;
        }
        .multiselect-dropdown.is-open {
            display: block;
            animation: dropdownFade 0.18s ease;
        }
        .multiselect-option {
            display: flex;
            align-items: center;
            gap: 0.55rem;
            padding: 0.45rem 0.35rem;
            border-radius: 6px;
            transition: background 0.14s ease, color 0.14s ease;
        }
        .multiselect-option:hover {
            background: rgba(36, 178, 255, 0.08);
        }
        .multiselect-option input[type="checkbox"] {
            accent-color: #24b2ff;
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }
        .multiselect-option label {
            flex: 1;
            color: #e1e4eb;
            font-size: 0.95rem;
            cursor: pointer;
            user-select: none;
        }
        .multiselect-empty {
            text-align: center;
            padding: 0.6rem 0.35rem;
            color: #9aa0ae;
            font-size: 0.92rem;
        }
        @keyframes dropdownFade {
            from {
                opacity: 0;
                transform: translateY(-6px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .search-btn {
            padding: 0.65rem 2.1rem;
            border: none;
            border-radius: 10px;
            background: #24b2ff;
            color: #fff;
            font-size: 1.13rem;
            font-weight: 700;
            letter-spacing: 1px;
            cursor: pointer;
            transition: background 0.12s, box-shadow 0.15s;
            margin-left: 1.4rem;
            box-shadow: 0 2px 8px rgba(36,178,255,0.09);
        }
        .search-btn:hover {
            background: #189fd1;
            box-shadow: 0 2px 14px rgba(36,178,255,0.13);
        }

        /* Map container adjustments */
        #map-container {
            position: fixed;
            left: 320px;
            top: 72px;
            right: 0;
            bottom: 0;
            width: calc(100vw - 320px);
            height: calc(100vh - 72px);
            transition: left 0.3s ease, right 0.3s ease, width 0.3s ease;
        }
        
        /* Charts panel adjustments */
        #map-container.charts-open {
            right: 400px; /* 400px charts panel on right */
            width: calc(100vw - 720px); /* 320px sidebar + 400px charts panel */
        }
        
        #charts-panel {
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            overflow-x: hidden;
            overflow-y: hidden;
            box-sizing: border-box;
            max-width: 100%;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 72px); /* Full viewport height minus top bar */
        }
        
        /* Contain all chart content within panel - use flex to fill height */
        #charts-panel > div {
            max-width: 100%;
            box-sizing: border-box;
            overflow: hidden;
            width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        /* Chart container divs - fill available height */
        #charts-panel > div > div {
            width: 100% !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
            overflow: hidden !important;
            flex: 1;
            min-height: 0;
            position: relative;
        }
        
        #charts-panel canvas {
            max-width: 100% !important;
            max-height: 100% !important;
            width: 100% !important;
            height: 100% !important;
            box-sizing: border-box !important;
            display: block;
        }
        
        /* Modern charts panel styling */
        #charts-panel h4 {
            color: #f39c12;
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid rgba(243, 156, 18, 0.3);
            padding-bottom: 0.5rem;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        /* Ensure no white background shows when panel is hidden */
        body {
            background-color: #1e2329 !important;
            overflow-x: hidden;
        }
        
        html {
            background-color: #1e2329 !important;
        }

        /* Split pane inside map container */
        #split-pane {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-sizing: border-box;
        }
        
        /* Ensure split-pane respects map container bounds when charts are open */
        #map-container.charts-open #split-pane {
            right: 0;
            max-width: 100%;
        }

        #upper-pane-people24 {
            display: none; /* shown when 24m is selected */
            background: linear-gradient(135deg, rgba(35, 39, 47, 0.98) 0%, rgba(42, 47, 57, 0.98) 100%);
            color: #fafafa;
            border-bottom: 2px solid rgba(243, 156, 18, 0.3);
            overflow-y: auto;
            overflow-x: hidden;
            box-sizing: border-box;
            z-index: 950; /* Below modals (1000) but above charts panel (999) */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        #upper-pane-people24 .content {
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 1rem 1.5rem 1.25rem 1.5rem;
            box-sizing: border-box;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        /* Ensure table doesn't extend into charts panel area */
        #map-container.charts-open #upper-pane-people24 {
            max-width: 100%;
            overflow-x: hidden;
            overflow-y: auto;
            width: 100%;
        }
        
        #map-container.charts-open #upper-pane-people24 .content {
            max-width: 100%;
            width: 100%;
            overflow-x: hidden;
            overflow-y: auto;
            padding-right: 0.5rem; /* Small gap from charts */
        }
        
        /* Ensure table and its container don't extend into charts panel */
        #map-container.charts-open #people-24-table-inner {
            max-width: 100%;
            width: 100%;
            overflow-x: hidden;
            box-sizing: border-box;
            table-layout: fixed;
        }
        
        /* Make sure the table wrapper div respects bounds */
        #map-container.charts-open #people-table-wrapper {
            max-width: 100% !important;
            width: 100% !important;
            overflow-x: hidden !important;
            overflow-y: auto !important;
            box-sizing: border-box;
            max-height: calc(40vh - 200px); /* Match table pane height minus header/filters */
        }
        
        /* Set specific column widths for better fit */
        #people-24-table-inner th:nth-child(1),
        #people-24-table-inner td:nth-child(1) {
            width: 5%;
        }
        #people-24-table-inner th:nth-child(2),
        #people-24-table-inner td:nth-child(2) {
            width: 20%;
        }
        #people-24-table-inner th:nth-child(3),
        #people-24-table-inner td:nth-child(3),
        #people-24-table-inner th:nth-child(4),
        #people-24-table-inner td:nth-child(4),
        #people-24-table-inner th:nth-child(5),
        #people-24-table-inner td:nth-child(5),
        #people-24-table-inner th:nth-child(6),
        #people-24-table-inner td:nth-child(6),
        #people-24-table-inner th:nth-child(7),
        #people-24-table-inner td:nth-child(7),
        #people-24-table-inner th:nth-child(8),
        #people-24-table-inner td:nth-child(8),
        #people-24-table-inner th:nth-child(9),
        #people-24-table-inner td:nth-child(9) {
            width: 7%;
        }
        #people-24-table-inner th:nth-child(10),
        #people-24-table-inner td:nth-child(10) {
            width: 7%;
        }
        #people-24-table-inner th:nth-child(11),
        #people-24-table-inner td:nth-child(11) {
            width: 15%;
        }

        #lower-pane-map {
            flex: 1 1 auto;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        /* Flood Data Table Styles */
        #flood-data-table {
            position: fixed;
            top: 90px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(35, 39, 47, 0.95);
            color: #fafafa;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
            max-width: 80%;
            max-height: 60vh;
            overflow-y: auto;
            display: none;
        }
        
        #flood-data-table h3 {
            margin: 0 0 1rem 0;
            color: #f39c12;
            font-size: 1.4rem;
            font-weight: 700;
            text-align: center;
            border-bottom: 2px solid #f39c12;
            padding-bottom: 0.5rem;
        }
        
        .flood-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            table-layout: fixed;
        }
        
        .flood-table th {
            background: #2a2f39;
            color: #f39c12;
            padding: 0.6rem 0.4rem;
            text-align: center;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border: 1px solid #444;
        }
        
        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none; /* Allow clicks to pass through to map */
        }
        
        .modal-content {
            background: #2a2f39;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            pointer-events: auto; /* Enable interaction with modal content */
        }

/* Maximize behavior for infographics modal */
.modal-content.maximized {
    width: 100% !important;
    max-width: none !important;
    height: 95vh !important;
}

        /* Simple loading spinner */
        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #3a3f4a;
            border-top-color: #f39c12;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-wrap {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #1e2329;
        }
        .inline-error {
            color: #ff7675;
            background: #2a2f39;
            border: 1px solid #3a3f4a;
            padding: 12px 14px;
            border-radius: 8px;
            text-align: center;
        }

        /* Bright blue glow on hover for buttons */
        button, .nav-btn, .close-btn {
            transition: box-shadow 0.2s ease, border-color 0.2s ease;
        }
        button:hover, .nav-btn:hover, .close-btn:hover {
            border-color: #3ea8ff !important;
            box-shadow: 0 0 0 2px rgba(62, 168, 255, 0.35), 0 0 10px rgba(62, 168, 255, 0.6) inset;
        }

        /* Chat widget */
        .ai-chat-toggle {
            position: fixed;
            right: 20px;
            bottom: 20px;
            z-index: 1200;
            background: #2a2f39;
            color: #fff;
            border: 1px solid #3a3f4a;
            padding: 10px 12px;
            border-radius: 999px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.4);
        }
        .ai-chat-callout {
            position: fixed;
            right: 92px; /* 20px (edge) + ~72px (toggle total width) */
            bottom: 28px;
            z-index: 1200;
            background: #243447;
            color: #ffffff;
            border: 1px solid #355070;
            border-radius: 22px;
            padding: 10px 14px;
            font-size: 14px;
            font-weight: 600;
            line-height: 1;
            white-space: nowrap;
            box-shadow: 0 6px 18px rgba(0,0,0,0.35);
            animation: aiCalloutPulse 2s ease-in-out infinite;
            transition: box-shadow 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
        }
        .ai-chat-callout::after {
            content: '';
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 0; height: 0;
            border-left: 6px solid #243447;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
        }
        .ai-chat-callout:hover {
            border-color: #3ea8ff !important;
            box-shadow: 0 0 0 2px rgba(62, 168, 255, 0.35), 0 0 10px rgba(62, 168, 255, 0.6) inset, 0 8px 22px rgba(0,0,0,0.45);
            transform: translateY(-2px);
        }
        @keyframes aiCalloutPulse {
            0%, 100% { transform: translateY(0); box-shadow: 0 6px 18px rgba(0,0,0,0.35); }
            50% { transform: translateY(-2px); box-shadow: 0 8px 22px rgba(0,0,0,0.45); }
        }
        .ai-chat-panel {
            position: fixed;
            right: 20px;
            bottom: 76px;
            width: 340px;
            max-height: 70vh;
            display: none;
            flex-direction: column;
            background: #1e2329;
            border: 1px solid #3a3f4a;
            border-radius: 12px;
            overflow: hidden;
            z-index: 1200;
            box-shadow: 0 12px 30px rgba(0,0,0,0.5);
        }
        .ai-chat-header {
            padding: 10px 12px;
            background: #161b22;
            border-bottom: 1px solid #2a2f39;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .ai-chat-title { color: #f39c12; font-weight: 700; }
        .ai-chat-actions { display: flex; gap: 6px; }
        .ai-chat-body {
            padding: 10px 12px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 52vh;
        }
        .ai-msg { padding: 8px 10px; border-radius: 10px; max-width: 85%; }
        .ai-msg.user { background: #243447; align-self: flex-end; border: 1px solid #355070; }
        .ai-msg.assistant { background: #2a2f39; align-self: flex-start; border: 1px solid #3a3f4a; }
        .ai-chat-input {
            display: flex;
            gap: 8px;
            padding: 10px 12px;
            border-top: 1px solid #2a2f39;
            background: #1e2329;
        }
        .ai-chat-input input {
            flex: 1 1 auto;
            background: #14181d;
            color: #fff;
            border: 1px solid #3a3f4a;
            border-radius: 8px;
            padding: 8px 10px;
        }
        .ai-chat-input button { border-radius: 8px; background:#2a2f39; color:#fff; border:1px solid #3a3f4a; padding: 8px 10px; cursor: pointer; }
        .ai-key-hint { color:#8aa0b4; font-size: 12px; padding: 6px 12px; border-top: 1px dashed #2a2f39; }
        
        .modal-header {
            cursor: move;
            user-select: none;
        }
        
        .modal-header:hover {
            background: #252a33;
        }
        
        .modal-header {
            background: #1e2329;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #f39c12;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #ccc;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .close-btn:hover {
            background-color: #444;
            color: #fff;
        }
        
        .modal-body {
            padding: 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .household-table {
            width: 100%;
            border-collapse: collapse;
            background: #1e2329;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .household-table th {
            background: #2a2f39;
            color: #fafafa;
            font-weight: 600;
            padding: 0.75rem 0.5rem;
            text-align: left;
            border-bottom: 2px solid #444;
            font-size: 0.9rem;
        }
        
        .household-table td {
            padding: 0.6rem 0.5rem;
            border-bottom: 1px solid #333;
            color: #e0e0e0;
            font-size: 0.85rem;
        }
        
        .household-table tbody tr:hover {
            background-color: #2a2f39;
        }
        
        .household-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .flood-table td {
            padding: 0.5rem 0.4rem;
            border: 1px solid #444;
            background: rgba(42, 47, 57, 0.5);
            color: #ffffff;
            font-weight: 500;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .flood-table tr:nth-child(even) td {
            background: rgba(42, 47, 57, 0.7);
        }
        
        .flood-table tr:hover td {
            background: rgba(243, 156, 18, 0.1);
        }
        .flood-table tbody tr.household-row-selected td {
            background: rgba(243, 156, 18, 0.25);
            color: #fff5d6;
            font-weight: 600;
        }
        
        .close-table-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: #fafafa;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }
        
        .close-table-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* Layer Switcher Styles */
        .layer-switcher {
            background: rgba(35, 39, 47, 0.95);
            color: #fafafa;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .layer-switcher .panel {
            background: rgba(35, 39, 47, 0.95);
        }
        
        .layer-switcher label {
            color: #fafafa;
        }
        
        .layer-switcher input[type="checkbox"]:checked + label {
            color: #24b2ff;
        }

        /* Responsive Design - Multiple Screen Sizes */
        @media (max-width: 1400px) {
            #charts-panel {
                width: 350px;
            }
            #map-container.charts-open {
                right: 350px;
                width: calc(100vw - 670px); /* 320px sidebar + 350px charts panel */
            }
        }

        @media (max-width: 1200px) {
            #charts-panel {
                width: 300px;
            }
            #map-container.charts-open {
                right: 300px;
                width: calc(100vw - 620px); /* 320px sidebar + 300px charts panel */
            }
            #upper-pane-people24 {
                height: 35vh;
            }
            #charts-panel {
                height: calc(100vh - 72px); /* Full height */
            }
        }

        @media (max-width: 1024px) {
            #charts-panel {
                width: 280px;
                padding: 1rem;
            }
            #map-container.charts-open {
                right: 280px;
                width: calc(100vw - 600px); /* 320px sidebar + 280px charts panel */
            }
            #upper-pane-people24 {
                height: 30vh;
            }
            #charts-panel {
                height: calc(100vh - 72px); /* Full height */
            }
            #charts-panel h4 {
                font-size: 0.85rem;
            }
            /* Charts will flex to fill available height - no fixed heights */
            .flood-table {
                font-size: 0.75rem;
            }
            .flood-table th,
            .flood-table td {
                padding: 0.4rem 0.3rem;
            }
        }

        @media (max-width: 768px) {
            #left-pane {
                width: 280px;
            }
            #map-container {
                left: 280px;
                width: calc(100vw - 280px);
            }
            #charts-panel {
                width: 250px;
                padding: 0.8rem;
            }
            #map-container.charts-open {
                left: 280px;
                right: 250px;
                width: calc(100vw - 530px);
            }
            #upper-pane-people24 {
                height: 25vh;
            }
            #charts-panel {
                height: calc(100vh - 72px); /* Full height */
            }
            /* Charts will flex to fill available height - no fixed heights */
            #people-filters {
                flex-direction: column;
                align-items: stretch !important;
            }
            #people-filters > div {
                width: 100%;
            }
            .modern-select {
                width: 100%;
                min-width: unset;
            }
        }

        @media (max-width: 640px) {
            #left-pane {
                width: 260px;
            }
            #map-container {
                left: 260px;
                width: calc(100vw - 260px);
            }
            #charts-panel {
                width: 100%;
                right: 0;
                top: 72px;
                bottom: 0;
                height: calc(100vh - 72px); /* Full height */
                border-left: none;
                border-top: 2px solid rgba(243, 156, 18, 0.3);
            }
            #map-container.charts-open {
                left: 260px;
                right: 0;
                width: calc(100vw - 260px);
                bottom: 0;
            }
            #upper-pane-people24 {
                height: 30vh;
            }
            /* Charts will flex to fill available height - no fixed heights */
            .flood-modern-select,
            .modern-select {
                font-size: 0.95rem;
                padding: 0.5rem 0.8rem;
            }
        }

        /* Ensure selects in sidebar don't overflow charts */
        #left-pane select {
            max-width: 100%;
            box-sizing: border-box;
        }

        /* Prevent dropdowns from appearing over charts panel */
        #left-pane {
            position: relative;
            z-index: 100; /* Below table (950) and modals (1000) but above charts (999) when sidebar is open */
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Ensure charts panel stays on top */
        #charts-panel {
            position: fixed;
            z-index: 999;
        }

        /* Ensure table stays above charts but below modals */
        #upper-pane-people24 {
            position: relative;
            z-index: 950; /* Below modals (1000) but above charts panel (999) */
        }
        </style>
        <title>PROJECT TOMaS (Tactical Overlay for Mapping and Safety)</title>
    </head>
    <body>
        <div id="main-wrapper">
            <div id="left-pane">
                <div class="sidebar-header" style="background: #24b2ff; border-bottom: none; padding-bottom: 0.7rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1.2rem; justify-content: center; text-align: center;">
                    <i class="fas fa-map-marked-alt" style="font-size: 2.1rem; color: #fff;"></i>
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <span style="font-size: 1.45rem; font-weight: 800; color: #fff; letter-spacing: 1.1px; line-height: 1; text-align: center;">PROJECT TOMaS</span>
                        <div style="font-size: 0.98rem; color: #e6e6e6; margin-top: 0.18rem; font-weight: 400; letter-spacing: 0.2px; font-style: italic; opacity: 0.95; text-align: center;">
                            (Tactical Overlay for Mapping and Safety)
                        </div>
                    </div>
                </div>
                <div class="sidebar-header">
                    <span>Database</span>
                </div>
                <nav class="nav-bar">
                    <button class="nav-btn" id="household-btn" title="Household">
                        <i class="fas fa-home"></i>
                        <span>Household</span>
                    </button>
                    <button class="nav-btn" title="ACVs">
                        <i class="fas fa-industry"></i>
                        <span>ACVs</span>
                    </button>
                    <button class="nav-btn" title="Equipment">
                        <i class="fas fa-cogs"></i>
                        <span>Equipment</span>
                    </button>
                    <button class="nav-btn" id="roads-btn" title="Roads &amp; Bridges">
                        <i class="fas fa-road"></i>
                        <span>Roads &amp; Bridges</span>
                    </button>
                    <button class="nav-btn" title="Evac Center">
                        <i class="fas fa-hospital"></i>
                        <span>Evac Center</span>
                    </button>
                    <button class="nav-btn" title="Buildings">
                        <i class="fas fa-building"></i>
                        <span>Buildings</span>
                    </button>
                    <button class="nav-btn" title="Schools">
                        <i class="fas fa-school"></i>
                        <span>Schools</span>
                    </button>
                    <button class="nav-btn" id="documentation-btn" title="Documentation">
                        <i class="fas fa-book"></i>
                        <span>Documentation</span>
                    </button>
                </nav>
                <!-- Flood Extent Dropdown Section Styled like Database Header -->
                <div class="flood-section">
                    <div class="sidebar-header flood-header">
                        <span>Flood Extent</span>
                    </div>
                    <div class="flood-form-group">
                        <label class="flood-form-label" for="floodExtentDropdown">Flood Extent</label>
                        <select id="floodExtentDropdown" class="flood-modern-select">
                            <option value="">Select Flood Extent</option>
                            <option value="24">24 meters</option>
                            <option value="25">25 meters</option>
                            <option value="26">26 meters</option>
                            <option value="27">27 meters</option>
                            <option value="28">28 meters</option>
                            <option value="29">29 meters</option>
                            <option value="30">30 meters</option>
                        </select>
                        <button id="toggleInfographicsBtn" style="margin-top: 12px; padding: 0.5rem 0.8rem; border-radius: 8px; border: 1px solid #3a3f4a; background:#2a2f39; color:#fff; cursor:pointer; font-weight:600; width: 100%;">Infographics</button>
                        <button id="impactReportBtn" style="margin-top: 8px; padding: 0.5rem 0.8rem; border-radius: 8px; border: 1px solid #3a3f4a; background:#2a2f39; color:#fff; cursor:pointer; font-weight:600; width: 100%;">Impact Report</button>
                    </div>
                </div>
            </div>
            <!-- Top Bar -->
            <div id="top-pane">
                <form class="search-form" autocomplete="off">
                    <div class="form-group">
                        <label class="form-label" for="region-select">Region</label>
                        <select id="region-select" class="modern-select">
                            <option value="">Select Region</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="province-select">Province</label>
                        <select id="province-select" class="modern-select">
                            <option value="">Select Province</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="municipality-select">Municipality</label>
                        <select id="municipality-select" class="modern-select">
                            <option value="">Select Municipality</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="barangay-multiselect-button">Barangay</label>
                        <div id="barangay-multiselect" class="modern-multiselect">
                            <button type="button" id="barangay-multiselect-button" class="modern-select multiselect-button">Select Barangay</button>
                            <div id="barangay-multiselect-dropdown" class="multiselect-dropdown">
                                <div class="multiselect-empty">Select a municipality first</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <!-- Map Container -->
            <div id="map-container">
                <!-- Charts Panel (Right Side) -->
                <div id="charts-panel" style="display: none; position: fixed; right: 0; top: 72px; bottom: 0; height: auto; width: 400px; background: linear-gradient(135deg, rgba(35, 39, 47, 0.98) 0%, rgba(42, 47, 57, 0.98) 100%); border-left: 2px solid rgba(243, 156, 18, 0.3); z-index: 999; overflow-y: hidden; overflow-x: hidden; padding: 1.5rem; box-shadow: -4px 0 20px rgba(0, 0, 0, 0.4); box-sizing: border-box;">
                    <div style="flex: 1; max-width: 100%; box-sizing: border-box; overflow: hidden; display: flex; flex-direction: column; min-height: 0; margin-bottom: 0.75rem;">
                        <h4>Hazard Level Distribution</h4>
                        <div style="position: relative; flex: 1; max-width: 100%; background: rgba(42, 47, 57, 0.4); border-radius: 8px; padding: 1rem; box-sizing: border-box; overflow: hidden; min-height: 0;">
                            <canvas id="hazardPieChart" style="max-width: 100%; max-height: 100%; box-sizing: border-box;"></canvas>
                        </div>
                    </div>
                    <div style="flex: 1; max-width: 100%; box-sizing: border-box; overflow: hidden; display: flex; flex-direction: column; min-height: 0;">
                        <h4>Exposed Population by Age</h4>
                        <div style="position: relative; flex: 1; max-width: 100%; background: rgba(42, 47, 57, 0.4); border-radius: 8px; padding: 1rem; box-sizing: border-box; overflow: hidden; min-height: 0;">
                            <canvas id="demographicsBarChart" style="max-width: 100%; max-height: 100%; box-sizing: border-box;"></canvas>
                        </div>
                    </div>
                </div>
                <div id="split-pane">
                    <div id="upper-pane-people24" style="height: 0;">
                        <div class="content">
                            <div style="display:flex; align-items:center; justify-content:space-between; gap: 12px;">
                                <h3 id="people-table-title" style="margin: 0; color: #f39c12; font-size: 1.2rem; font-weight: 700;">
                                    <span id="people-table-title-text">Population Exposure</span>
                                    <span id="people-table-count" style="font-size: 0.9rem; color: #cccccc; font-weight: 500; margin-left: 8px;">0 of 0 rows</span>
                                </h3>
                                <button id="people-24-close" class="close-table-btn" title="Close" style="position: static;">&times;</button>
                            </div>
                            <!-- Filters -->
                            <div id="people-filters" style="margin-top: 0.75rem; display: flex; gap: 12px; align-items: center; flex-wrap: wrap;"></div>
                            
                            <div id="people-table-wrapper" style="margin-top: 0.5rem; overflow-y: auto; overflow-x: hidden; background: rgba(42, 47, 57, 0.5); border: 1px solid rgba(243, 156, 18, 0.2); border-radius: 8px; max-height: calc(40vh - 200px); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);">
                                <table class="flood-table" id="people-24-table-inner" style="margin:0;">
                                    <thead style="position: sticky; top: 0; z-index: 2;">
                                        <tr>
                                            <th>No.</th>
                                            <th>Barangay</th>
                                            <th>Infant</th>
                                            <th>Child</th>
                                            <th>Youth</th>
                                            <th>Adult</th>
                                            <th>Elderly</th>
                                            <th>Male</th>
                                            <th>Female</th>
                                            <th>Disabled</th>
                                            <th>Flood Exposure</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Household Details Modal -->
                    <div id="household-modal" class="modal" style="display: none;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 id="household-modal-title">Household Details</h3>
                                <button id="household-modal-close" class="close-btn">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div id="household-size-display" style="margin-bottom: 1rem; padding: 0.75rem; background: #1e2329; border-radius: 6px; border-left: 4px solid #f39c12;">
                                    <strong style="color: #f39c12;">Household Size: </strong>
                                    <span id="household-size-value" style="color: #e0e0e0;">-</span>
                                </div>
                                <div id="household-table-container">
                                    <table id="household-details-table" class="household-table">
                                        <thead>
                                            <tr>
                                                <th>Relation</th>
                                                <th>Given Name</th>
                                                <th>Last Name</th>
                                                <th>Age</th>
                                                <th>Sex</th>
                                                <th>Occupation</th>
                                                <th>Religion</th>
                                            </tr>
                                        </thead>
                                        <tbody id="household-details-tbody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Infographics Modal -->
                    <div id="infographics-modal" class="modal" style="display: none;">
                        <div class="modal-content" style="width: 95%; max-width: 1000px; height: 85vh; display: flex; flex-direction: column;">
                            <div class="modal-header">
                                <h3 id="infographics-modal-title">Infographics</h3>
                                <div style="display:flex; gap:8px; align-items:center;">
                                    <button id="infographics-modal-maximize" class="close-btn" title="Maximize" style="line-height:1;">â›¶</button>
                                    <button id="infographics-modal-close" class="close-btn">&times;</button>
                                </div>
                            </div>
                            <div class="modal-body" style="flex: 1 1 auto; padding: 0;">
                                <div id="infographics-container" style="width:100%; height:100%; background:#1e2329; display:flex; align-items:center; justify-content:center;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Impact Report Modal -->
                    <div id="impact-report-modal" class="modal" style="display: none;">
                        <div class="modal-content" style="width: 95%; max-width: 1000px; height: 85vh; display: flex; flex-direction: column;">
                            <div class="modal-header">
                                <h3 id="impact-report-modal-title">Impact Report</h3>
                                <div style="display:flex; gap:8px; align-items:center;">
                                    <button id="impact-report-modal-maximize" class="close-btn" title="Maximize" style="line-height:1;">â›¶</button>
                                    <button id="impact-report-modal-close" class="close-btn">&times;</button>
                                </div>
                            </div>
                            <div class="modal-body" style="flex: 1 1 auto; padding: 0;">
                                <div id="impact-report-container" style="width:100%; height:100%; background:#1e2329; display:flex; align-items:center; justify-content:center;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Barangay Population Modal -->
                    <div id="barangay-population-modal" class="modal" style="display: none;">
                        <div class="modal-content" style="width: 90%; max-width: 700px; max-height: 85vh; display: flex; flex-direction: column;">
                            <div class="modal-header">
                                <h3 id="barangay-population-title">Population by Barangay</h3>
                                <button id="barangay-population-close" class="close-btn">&times;</button>
                            </div>
                            <div class="modal-body" style="flex: 1 1 auto; overflow: hidden;">
                                <div id="barangay-population-content" style="height: 100%; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>
                    <div id="lower-pane-map">
                        <div id="map">
                            <div>
                                <a href="#" id="popup-closer" class="ol-popup-closer"></a>
                                <div id="popup-content"></div>
                            </div>
                            <!-- Barangay Tooltip -->
                        </div>
                        <!-- Map Legend -->
                        <div id="map-legend" style="display: none; position: absolute; bottom: 20px; left: 20px; background: rgba(38, 42, 51, 0.2); border: 1px solid #666; border-radius: 8px; padding: 12px; width: auto; height: auto; min-width: fit-content; z-index: 1000;">
                            <div style="color: #1a1a1a; font-size: 0.9rem; font-weight: 600; margin-bottom: 8px; text-align: center;">Legends</div>
                            <!-- Flood Depth Legend -->
                            <div style="margin-bottom: 8px;">
                                <div style="color: #1a1a1a; font-size: 0.85rem; font-weight: 500; margin-bottom: 4px; padding-bottom: 4px; border-bottom: 1px solid #999;">Water Depth</div>
                                <div style="display: flex; flex-direction: column; gap: 3px;">
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <img src="styles/legend/24_10_0.png" alt="0.0010" style="width: 18px; height: 18px; padding: 4px;" />
                                        <span style="color: #1a1a1a; font-size: 0.85em;">0.0010m</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <img src="styles/legend/24_10_1.png" alt="2.3258" style="width: 18px; height: 18px; padding: 4px;" />
                                        <span style="color: #1a1a1a; font-size: 0.85em;">2.3258m</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <img src="styles/legend/24_10_2.png" alt="4.6505" style="width: 18px; height: 18px; padding: 4px;" />
                                        <span style="color: #1a1a1a; font-size: 0.85em;">4.6505m</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <img src="styles/legend/24_10_3.png" alt="6.9753" style="width: 18px; height: 18px; padding: 4px;" />
                                        <span style="color: #1a1a1a; font-size: 0.85em;">6.9753m</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <img src="styles/legend/24_10_4.png" alt="9.3000" style="width: 18px; height: 18px; padding: 4px;" />
                                        <span style="color: #1a1a1a; font-size: 0.85em;">9.3000m</span>
                                    </div>
                                </div>
                            </div>
                            <!-- Population Affected Legend -->
                            <div>
                                <div style="color: #1a1a1a; font-size: 0.85rem; font-weight: 500; margin-bottom: 4px; padding-top: 4px; padding-bottom: 4px; border-top: 1px solid #999; border-bottom: 1px solid #999;">Flood Exposure</div>
                                <div style="display: flex; flex-direction: column; gap: 3px;">
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <img src="styles/legend/Numberofpeopleat24meters_12_0.png" alt="High" style="width: 18px; height: 18px; padding: 4px;" />
                                        <span style="color: #1a1a1a; font-size: 0.85em;">High (> 1.5 m)</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <img src="styles/legend/Numberofpeopleat24meters_12_1.png" alt="Moderate" style="width: 18px; height: 18px; padding: 4px;" />
                                        <span style="color: #1a1a1a; font-size: 0.85em;">Moderate (> 0.7 - 1.5 m)</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <img src="styles/legend/Numberofpeopleat24meters_12_2.png" alt="Low" style="width: 18px; height: 18px; padding: 4px;" />
                                        <span style="color: #1a1a1a; font-size: 0.85em;">Low (> 0.1 - 0.7 m)</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <img src="styles/legend/Numberofpeopleat24meters_12_3.png" alt="Very Low" style="width: 18px; height: 18px; padding: 4px;" />
                                        <span style="color: #1a1a1a; font-size: 0.85em;">Very Low (<= 0.1 m)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI Chat Widget - Removed -->
                    <div id="ai-chat-panel" class="ai-chat-panel">
                        <div class="ai-chat-header">
                            <div class="ai-chat-title">Chat with TOMAS</div>
                            <div class="ai-chat-actions">
                                <button id="ai-chat-docs" class="close-btn" title="Proxy setup (docs)">?</button>
                                <button id="ai-chat-settings" class="close-btn" title="Settings">âš™</button>
                                <button id="ai-chat-close" class="close-btn" title="Close">Ã—</button>
                            </div>
                        </div>
                        <div id="ai-chat-body" class="ai-chat-body"></div>
                        <div class="ai-key-hint" id="ai-key-hint" style="display:none;">No API key set. Click âš™ to add your OpenAI API key locally.</div>
                        <div class="ai-chat-input">
                            <input id="ai-chat-input" type="text" placeholder="Ask about the data..." />
                            <button id="ai-chat-send">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script src="resources/qgis2web_expressions.js"></script>
        <script src="./resources/functions.js"></script>
        <script src="./resources/ol.js"></script>
        <script src="./resources/ol-layerswitcher.js"></script>
        <script src="resources/photon-geocoder-autocomplete.min.js"></script>
        <script src="layers/Households_1.js"></script><script src="layers/People_0.js"></script><script src="layers/AnalysisSummaryat24meters_9.js"></script><script src="layers/AggregationSummaryat24meters_10.js"></script><script src="layers/HazardAggregationSummaryat24meters_11.js"></script><script src="layers/Numberofpeopleat24meters_12.js"></script><script src="layers/AnalysisSummaryat25meters_13.js"></script><script src="layers/AggregationSummaryat25meters_14.js"></script><script src="layers/HazardAggregationSummaryat25meters_15.js"></script><script src="layers/Numberofpeopleat25meters_16.js"></script><script src="layers/AnalysisSummaryat27meters_17.js"></script><script src="layers/AggregationSummaryat27meters_18.js"></script><script src="layers/HazardAggregationSummaryat27meters_19.js"></script><script src="layers/Numberofpeopleat26meters_20.js"></script><script src="layers/AnalysisSummaryat27meters_21.js"></script><script src="layers/AggregationSummaryatat27meters_22.js"></script><script src="layers/HazardAggregationSummaryat27meters_23.js"></script><script src="layers/Numberofpeopleat27meters_24.js"></script><script src="layers/AnalysisSummaryat28meters_25.js"></script><script src="layers/AggregationSummaryat28meters_26.js"></script><script src="layers/HazardAggregationSummaryat28meters_27.js"></script><script src="layers/Numberofpeopleat28meters_28.js"></script><script src="layers/AnalysisSummaryat29meters_29.js"></script><script src="layers/AggregationSummaryat29meters_30.js"></script><script src="layers/HazardAggregationSummaryat29meters_31.js"></script><script src="layers/Numberofpeopleat29meters_32.js"></script><script src="layers/AnalysisSummaryat30meters_33.js"></script><script src="layers/AggregationSummaryfor30meters_34.js"></script><script src="layers/HazardAggregationSummaryat30meters_35.js"></script><script src="layers/Numberofpeopleaffectedat30meters_36.js"></script><script src="layers/Schools_37.js"></script><script src="layers/Roads_38.js"></script><script src="layers/Region2_39.js"></script>
        <script src="styles/Households_1_style.js"></script><script src="styles/People_0_style.js"></script><script src="styles/AnalysisSummaryat24meters_9_style.js"></script><script src="styles/AggregationSummaryat24meters_10_style.js"></script><script src="styles/HazardAggregationSummaryat24meters_11_style.js"></script><script src="styles/Numberofpeopleat24meters_12_style.js"></script><script src="styles/AnalysisSummaryat25meters_13_style.js"></script><script src="styles/AggregationSummaryat25meters_14_style.js"></script><script src="styles/HazardAggregationSummaryat25meters_15_style.js"></script><script src="styles/Numberofpeopleat25meters_16_style.js"></script><script src="styles/AnalysisSummaryat27meters_17_style.js"></script><script src="styles/AggregationSummaryat27meters_18_style.js"></script><script src="styles/HazardAggregationSummaryat27meters_19_style.js"></script><script src="styles/Numberofpeopleat26meters_20_style.js"></script><script src="styles/AnalysisSummaryat27meters_21_style.js"></script><script src="styles/AggregationSummaryatat27meters_22_style.js"></script><script src="styles/HazardAggregationSummaryat27meters_23_style.js"></script><script src="styles/Numberofpeopleat27meters_24_style.js"></script><script src="styles/AnalysisSummaryat28meters_25_style.js"></script><script src="styles/AggregationSummaryat28meters_26_style.js"></script><script src="styles/HazardAggregationSummaryat28meters_27_style.js"></script><script src="styles/Numberofpeopleat28meters_28_style.js"></script><script src="styles/AnalysisSummaryat29meters_29_style.js"></script><script src="styles/AggregationSummaryat29meters_30_style.js"></script><script src="styles/HazardAggregationSummaryat29meters_31_style.js"></script><script src="styles/Numberofpeopleat29meters_32_style.js"></script><script src="styles/AnalysisSummaryat30meters_33_style.js"></script><script src="styles/AggregationSummaryfor30meters_34_style.js"></script><script src="styles/HazardAggregationSummaryat30meters_35_style.js"></script><script src="styles/Numberofpeopleaffectedat30meters_36_style.js"></script><script src="styles/Schools_37_style.js"></script><script src="styles/Roads_38_style.js"></script><script src="styles/Region2_39_style.js"></script>
        
        <!-- Place a small safe-guard before layers/layers.js runs to avoid undefined style references -->
        <script>
        // Ensure any missing style helper used by layers.js won't throw at parse time.
        // Add placeholders only if they don't already exist.
        window.style_Numberofpeopleat24meters_12 = window.style_Numberofpeopleat24meters_12 || function(feature, resolution){
            // return null or a very simple style if OL expects a style object
            try {
                if (typeof ol !== 'undefined' && ol.style && ol.style.Style) {
                    return new ol.style.Style({
                        stroke: new ol.style.Stroke({ color: 'rgba(0,0,0,0.6)', width: 1 }),
                        fill: new ol.style.Fill({ color: 'rgba(255,255,255,0.01)' })
                    });
                }
            } catch (e) {}
            return null;
        };
        </script>

        <!-- existing layer/style/layers.js includes follow here (no change) -->
        <script src="./layers/layers.js" type="text/javascript"></script> 
        <script src="./resources/Autolinker.min.js"></script>
        <script src="./resources/qgis2web.js"></script>
        
        
        
        <script>
        // Global variables
        var regionLayer = null;
        var highlightLayer = null;
        var popupOverlay = null;
        var selectedFeatures = [];
        var peopleLayer = null;
        var householdLayers = [];
        var householdLayersVisible = false;
        var barangaySelectionState = {
            options: [],
            selected: new Set()
        };
        var barangayDropdownInitialized = false;
        
        // Initialize map with base map and Region_2 layer visible
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for the map to be fully loaded
            setTimeout(function() {
                console.log('Checking map layers...');
                if (typeof map !== 'undefined' && map.getLayers) {
                    var layers = map.getLayers().getArray();
                    console.log('Total layers found:', layers.length);
                    
                    // Layer visibility is now controlled by layers.js - only Region2 and Positron are visible by default
                    layers.forEach(function(layer, index) {
                        var layerTitle = layer.get('title') || layer.get('name') || 'Unknown';
                        var layerType = layer.getType ? layer.getType() : 'unknown';
                        console.log('Layer ' + index + ':', layerTitle, 'Type:', layerType, 'Visible:', layer.getVisible());
                        
                        // Store region layer reference for other functionality
                        var layerTitleLower = layerTitle.toLowerCase();
                        var isRegionLayer = layerTitle === 'Region2' || 
                            layerTitle === 'Region_2' || 
                            layerTitle === 'Region2_39' ||
                            layerTitleLower.includes('region2') ||
                            layerTitleLower.includes('region_2');
                        
                        if (isRegionLayer) {
                            regionLayer = layer;
                            console.log('Region layer reference stored:', layerTitle);
                        }
                    });
                    
                    // Debug: List all layer names for troubleshooting
                    console.log('=== ALL LAYER NAMES ===');
                    layers.forEach(function(layer, index) {
                        var layerTitle = layer.get('title') || layer.get('name') || 'Unknown';
                        console.log('Layer ' + index + ' name:', layerTitle, 'Visible:', layer.getVisible());
                    });
                    console.log('=== END LAYER NAMES ===');
                    
                    // Create highlight layer
                    createHighlightLayer();
                    
                    // Create popup overlay
                    createPopupOverlay();
                    
                    // Add map click listener to clear highlights
                    setupMapClickHandler();
                    
                    // Add layer switcher control
                    setupLayerSwitcher();

                    // Ensure basemap and region layers are visible and ordered correctly now that layers exist
                    ensureBasemapVisible();

                    // Prepare the People layer so it is ready for toggling
                    ensurePeopleLayer();
                    ensureHouseholdLayers();
                } else {
                    console.log('Map not found or not ready');
                }
                
                // Initialize custom barangay multiselect before populating options
                initializeBarangayMultiselect();

                // Populate dropdowns from Region2_39 data
                populateDropdowns();
                
                // Add event listeners for dropdowns
                setupDropdownEventListeners();

                // Initialize barangay display value
                updatePeopleBarangayDisplay();
                updateFloodExtentAvailability();
                filterHouseholdsBySelectedBarangay();
                
                // Add event listeners for navigation buttons
                setupNavigationButtons();
                
                // Add event listeners for flood extent functionality
                setupFloodExtentListeners();
                
            }, 2000); // Increased wait time to 2 seconds
        });
        
        function setFloodExtent24InitialVisibility() {
                var layer = findFloodExtent24Layer();
                if (!layer) {
                    setTimeout(setFloodExtent24InitialVisibility, 150);
                    return;
                }
                layer.setVisible(false);
                var dropdown = document.getElementById('flood-extent-select');
                if (!dropdown) return;
                dropdown.addEventListener('change', function(){
                    if(this.value === "24") {
                        layer.setVisible(true);
                    } else {
                        layer.setVisible(false);
                    }
                });
            }
            setFloodExtent24InitialVisibility();
        // Create highlight layer for selected polygons
        function createHighlightLayer() {
            highlightLayer = new ol.layer.Vector({
                source: new ol.source.Vector(),
                style: new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: '#ff0000',
                        width: 4,
                        lineDash: [5, 5]
                    }),
                    fill: new ol.style.Fill({
                        color: 'rgba(255, 0, 0, 0.1)'
                    })
                }),
                zIndex: 1000
            });
            map.addLayer(highlightLayer);
        }
        
        // Create popup overlay
        function createPopupOverlay() {
            var popupElement = document.getElementById('popup');
            popupOverlay = new ol.Overlay({
                element: popupElement,
                positioning: 'bottom-center',
                stopEvent: false,
                offset: [0, -50]
            });
            map.addOverlay(popupOverlay);
            
            // Close popup when clicking the closer
            document.getElementById('popup-closer').onclick = function() {
                popupOverlay.setPosition(undefined);
                return false;
            };
        }
        
        // Function to populate dropdowns from Region2_39 data
        function populateDropdowns() {
            if (typeof json_Region2_39 !== 'undefined' && json_Region2_39.features) {
                console.log('Populating dropdowns from Region2_39 data...');
                
                // Get unique values for Region dropdown only
                var regions = new Set();
                
                json_Region2_39.features.forEach(function(feature) {
                    if (feature.properties && feature.properties.Reg_Name) {
                        regions.add(feature.properties.Reg_Name);
                    }
                });
                
                // Populate Region dropdown only
                var regionSelect = document.getElementById('region-select');
                if (regionSelect) {
                    Array.from(regions).sort().forEach(function(region) {
                        var option = document.createElement('option');
                        option.value = region;
                        option.textContent = region;
                        regionSelect.appendChild(option);
                    });
                }
                
                // Clear other dropdowns - they will be populated based on selections
                var provinceSelect = document.getElementById('province-select');
                var municipalitySelect = document.getElementById('municipality-select');
                
                if (provinceSelect) {
                    provinceSelect.innerHTML = '<option value="">Select Province</option>';
                }
                if (municipalitySelect) {
                    municipalitySelect.innerHTML = '<option value="">Select Municipality</option>';
                }
                renderBarangayOptions([]);
                
                console.log('Region dropdown populated successfully. Other dropdowns will populate based on selections.');
            } else {
                console.log('Region2_39 data not found');
            }
        }
        
        // Setup event listeners for dropdowns
        function setupDropdownEventListeners() {
            var regionSelect = document.getElementById('region-select');
            var provinceSelect = document.getElementById('province-select');
            var municipalitySelect = document.getElementById('municipality-select');
            
            if (regionSelect) {
                regionSelect.addEventListener('change', function() {
                    clearHighlight();
                    if (provinceSelect) {
                        provinceSelect.value = '';
                    }
                    clearLowerDropdowns();
                    updateProvinceDropdown();
                    updateMunicipalityDropdown();
                    updateBarangayDropdown();
                    handleBarangaySelectionChange({ skipZoom: true, reason: 'region-change' });
                    if (this.value) {
                        highlightSelectedPolygon();
                        zoomToArea();
                    }
                });
            }
            
            if (provinceSelect) {
                provinceSelect.addEventListener('change', function() {
                    clearHighlight();
                    if (!this.value && municipalitySelect) {
                        municipalitySelect.value = '';
                    }
                    clearBarangayDropdown();
                    updateMunicipalityDropdown();
                    updateBarangayDropdown();
                    handleBarangaySelectionChange({ skipZoom: true, reason: 'province-change' });
                    if (this.value) {
                        highlightSelectedPolygon();
                        zoomToArea();
                    }
                });
            }
            
            if (municipalitySelect) {
                municipalitySelect.addEventListener('change', function() {
                    clearHighlight();
                    clearBarangayDropdown();
                    updateBarangayDropdown();
                    handleBarangaySelectionChange({ skipZoom: true, reason: 'municipality-change' });
                    if (this.value) {
                        highlightSelectedPolygon();
                        zoomToArea();
                    }
                });
            }
        }

        function initializeBarangayMultiselect() {
            if (barangayDropdownInitialized) return;
            var button = document.getElementById('barangay-multiselect-button');
            var dropdown = document.getElementById('barangay-multiselect-dropdown');
            if (!button || !dropdown) return;

            button.addEventListener('click', function(event) {
                event.preventDefault();
                event.stopPropagation();
                var willOpen = !dropdown.classList.contains('is-open');
                toggleBarangayDropdown(willOpen);
            });

            dropdown.addEventListener('click', function(event) {
                event.stopPropagation();
            });

            document.addEventListener('click', function() {
                closeBarangayDropdown();
            });

            barangayDropdownInitialized = true;
        }

        function toggleBarangayDropdown(shouldOpen) {
            var button = document.getElementById('barangay-multiselect-button');
            var dropdown = document.getElementById('barangay-multiselect-dropdown');
            if (!button || !dropdown) return;
            if (shouldOpen) {
                dropdown.classList.add('is-open');
                button.classList.add('is-open');
            } else {
                dropdown.classList.remove('is-open');
                button.classList.remove('is-open');
            }
        }

        function closeBarangayDropdown() {
            toggleBarangayDropdown(false);
        }

        function getSelectedBarangays() {
            return Array.from(barangaySelectionState.selected);
        }

        function normalizeBarangayName(value) {
            return (value || '').toString().trim().toLowerCase();
        }

        function updateBarangaySelectionDisplay() {
            var button = document.getElementById('barangay-multiselect-button');
            if (!button) return;
            var selections = getSelectedBarangays();
            if (barangaySelectionState.options.length === 0) {
                button.textContent = 'Select Barangay';
                return;
            }
            if (selections.length === 0) {
                button.textContent = 'Select Barangay';
            } else if (selections.length === 1) {
                button.textContent = selections[0];
            } else {
                button.textContent = selections.length + ' barangays selected';
            }
        }

        function renderBarangayOptions(barangays) {
            var dropdown = document.getElementById('barangay-multiselect-dropdown');
            if (!dropdown) return;

            dropdown.innerHTML = '';
            barangaySelectionState.options = Array.isArray(barangays) ? barangays.slice() : [];

            if (!barangaySelectionState.options.length) {
                barangaySelectionState.selected.clear();
                dropdown.innerHTML = '<div class="multiselect-empty">Select a municipality first</div>';
                updateBarangaySelectionDisplay();
                handleBarangaySelectionChange({ skipZoom: true, reason: 'options-cleared' });
                return;
            }

            var previousSelection = new Set(barangaySelectionState.selected);
            barangaySelectionState.selected.clear();
            var availableSet = new Set(barangaySelectionState.options);
            var selectionChanged = false;

            previousSelection.forEach(function(name) {
                if (availableSet.has(name)) {
                    barangaySelectionState.selected.add(name);
                } else {
                    selectionChanged = true;
                }
            });

            var fragment = document.createDocumentFragment();
            barangaySelectionState.options.forEach(function(name, index) {
                var option = document.createElement('div');
                option.className = 'multiselect-option';

                var checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = 'barangay-checkbox-' + index;
                checkbox.value = name;
                checkbox.checked = barangaySelectionState.selected.has(name);
                checkbox.addEventListener('change', function(event) {
                    handleBarangayOptionToggle(name, event.target.checked);
                });

                var label = document.createElement('label');
                label.setAttribute('for', checkbox.id);
                label.textContent = name;

                option.appendChild(checkbox);
                option.appendChild(label);
                fragment.appendChild(option);
            });

            dropdown.appendChild(fragment);
            updateBarangaySelectionDisplay();

            if (selectionChanged) {
                console.log('Pruned barangay selections that are no longer available.');
                handleBarangaySelectionChange({ skipZoom: true, reason: 'pruned-selection' });
            }
        }

        function handleBarangayOptionToggle(name, isChecked) {
            if (!name) return;
            if (isChecked) {
                barangaySelectionState.selected.add(name);
            } else {
                barangaySelectionState.selected.delete(name);
            }
            updateBarangaySelectionDisplay();
            console.log('Barangay selection updated:', getSelectedBarangays());
            handleBarangaySelectionChange({ reason: 'checkbox' });
        }

        function clearBarangaySelections(options) {
            options = options || {};
            if (barangaySelectionState.selected.size === 0 && !options.force) {
                return;
            }
            barangaySelectionState.selected.clear();
            var dropdown = document.getElementById('barangay-multiselect-dropdown');
            if (dropdown) {
                dropdown.querySelectorAll('input[type="checkbox"]').forEach(function(cb) {
                    cb.checked = false;
                });
            }
            updateBarangaySelectionDisplay();
            console.log('Barangay selections cleared.', options.reason ? '(' + options.reason + ')' : '');
            handleBarangaySelectionChange({ skipZoom: true, reason: options.reason || 'clear' });
        }

        function handleBarangaySelectionChange(options) {
            options = options || {};
            var selections = getSelectedBarangays();
            if (!options.reason) {
                console.log('Barangay selection change detected.');
            }
            console.log('Current barangay selections:', selections, 'Reason:', options.reason || 'unknown');
            if (selections.length === 0) {
                clearHighlight();
            } else {
                highlightSelectedPolygon();
                if (!options.skipZoom) {
                    zoomToArea();
                }
            }
            updatePeopleBarangayDisplay();
            updateFloodExtentAvailability();
            filterHouseholdsBySelectedBarangay();
            if (selections.length > 0) {
                setPeopleLayerVisible(false);
            } else if (householdLayersVisible) {
                setBaseHouseholdLayersVisible(true);
            }
            applyPeopleFiltersAndRender();
            updateCharts();
        }
        
        // Setup navigation button event listeners
        function setupNavigationButtons() {
            console.log('Setting up navigation buttons...');
            
            // Household button
            var householdBtn = document.getElementById('household-btn');
            if (householdBtn) {
                console.log('Household button found, adding event listener');
                householdBtn.addEventListener('click', function() {
                    if (this.disabled || this.classList.contains('is-disabled')) {
                        console.log('Household button click ignored - disabled state');
                        return;
                    }
                    console.log('Household button clicked');
                    toggleLayer('household');
                    toggleButtonActive(this);
                });
            } else {
                console.log('Household button not found');
            }
            
            // Roads button
            var roadsBtn = document.getElementById('roads-btn');
            if (roadsBtn) {
                console.log('Roads button found, adding event listener');
                roadsBtn.addEventListener('click', function() {
                    console.log('Roads button clicked');
                    toggleLayer('roads');
                    toggleButtonActive(this);
                });
            } else {
                console.log('Roads button not found');
            }
            
            // Schools button
            var schoolsBtn = document.querySelector('.nav-btn[title="Schools"]');
            if (schoolsBtn) {
                console.log('Schools button found, adding event listener');
                schoolsBtn.addEventListener('click', function() {
                    console.log('Schools button clicked');
                    toggleLayer('schools');
                    toggleButtonActive(this);
                });
            } else {
                console.log('Schools button not found');
            }
            
            // Documentation button
            var documentationBtn = document.getElementById('documentation-btn');
            if (documentationBtn) {
                console.log('Documentation button found, adding event listener');
                documentationBtn.addEventListener('click', function() {
                    console.log('Documentation button clicked');
                    window.location.href = 'Documentation.html';
                });
            } else {
                console.log('Documentation button not found');
            }

            // (Removed redundant nav Infographics button wiring)
        }
        function ensurePeopleLayer() {
            if (peopleLayer || typeof map === 'undefined' || !map.getView || !map.getView().getProjection) {
                return;
            }
            if (typeof json_People_0 === 'undefined') {
                console.warn('People layer data unavailable');
                return;
            }

            try {
                var format = new ol.format.GeoJSON({
                    dataProjection: 'EPSG:4326',
                    featureProjection: map.getView().getProjection()
                });
                var features = format.readFeatures(json_People_0);
                peopleLayer = new ol.layer.Vector({
                    source: new ol.source.Vector({
                        features: features
                    }),
                    style: (typeof style_People_0 === 'function') ? style_People_0 : undefined,
                    title: 'People_0',
                    visible: false,
                    zIndex: 1100
                });
                map.addLayer(peopleLayer);
            } catch (e) {
                console.error('Failed to initialize People layer:', e);
            }
        }
        
        // Toggle layer visibility
        function toggleLayer(layerType) {
            if (typeof map === 'undefined' || !map.getLayers) {
                return;
            }

            var layers = map.getLayers().getArray();
            console.log('toggleLayer called for:', layerType);

            if (layerType === 'household') {
                ensureHouseholdLayers();
                var householdBtn = document.getElementById('household-btn');
                if (!householdLayersVisible) {
                    householdLayersVisible = true;
                    if (householdBtn) {
                        toggleButtonActive(householdBtn);
                    }
                    console.log('Activating household layer view. Current barangay selections:', getSelectedBarangays());
                    setPeopleLayerVisible(false);
                    var selections = getSelectedBarangays();
                    if (selections.length > 0) {
                        filterHouseholdsBySelectedBarangay();
                        if (filteredHouseholdLayer) {
                            filteredHouseholdLayer.setVisible(true);
                        }
                        setBaseHouseholdLayersVisible(false);
                    } else {
                        setBaseHouseholdLayersVisible(true);
                        if (filteredHouseholdLayer) {
                            filteredHouseholdLayer.setVisible(false);
                        }
                    }
                } else {
                    householdLayersVisible = false;
                    if (householdBtn) {
                        householdBtn.classList.remove('active');
                    }
                    console.log('Deactivating household layer view.');
                    setBaseHouseholdLayersVisible(false);
                    if (filteredHouseholdLayer) {
                        filteredHouseholdLayer.setVisible(false);
                        removeFilteredHouseholdLayer();
                    }
                }
                return;
            }

            layers.forEach(function(layer) {
                var layerTitle = layer.get('title') || layer.get('name') || 'Unknown';
                var layerTitleLower = layerTitle.toLowerCase();
                console.log('Checking layer:', layerTitle, 'for type:', layerType);

                if (layerType === 'roads' &&
                    (layerTitleLower.includes('roads') || layerTitleLower.includes('road') ||
                     layerTitle === 'Roads_38' || layerTitleLower.includes('roads_38'))) {
                    layer.setVisible(!layer.getVisible());
                    console.log('Toggled roads layer:', layerTitle, 'Visible:', layer.getVisible());
                } else if (layerType === 'schools' &&
                           (layerTitleLower.includes('schools') || layerTitleLower.includes('school') ||
                            layerTitle === 'Schools_37' || layerTitleLower.includes('schools_37'))) {
                    layer.setVisible(!layer.getVisible());
                    console.log('Toggled schools layer:', layerTitle, 'Visible:', layer.getVisible());
                }
            });
        }
        
        // Toggle button active state
        function toggleButtonActive(button) {
            // Remove active class from all nav buttons
            var allNavBtns = document.querySelectorAll('.nav-btn');
            allNavBtns.forEach(function(btn) {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked button
            button.classList.add('active');
        }
        
        // Update province dropdown based on selected region
        function updateProvinceDropdown() {
            var regionSelect = document.getElementById('region-select');
            var provinceSelect = document.getElementById('province-select');
            
            if (!regionSelect || !provinceSelect) return;
            
            var selectedRegion = regionSelect.value;
            var provinces = new Set();
            
            if (selectedRegion) {
                // Only show provinces if a region is selected
                json_Region2_39.features.forEach(function(feature) {
                    if (feature.properties && 
                        feature.properties.Reg_Name === selectedRegion && 
                        feature.properties.Pro_Name) {
                        provinces.add(feature.properties.Pro_Name);
                    }
                });
                    }
            // If no region is selected, don't show any provinces
            
            // Clear and repopulate province dropdown
            provinceSelect.innerHTML = '<option value="">Select Province</option>';
            if (selectedRegion && provinces.size > 0) {
            Array.from(provinces).sort().forEach(function(province) {
                var option = document.createElement('option');
                option.value = province;
                option.textContent = province;
                provinceSelect.appendChild(option);
            });
            }
            
            console.log('Updated province dropdown with', provinces.size, 'options for region:', selectedRegion);
        }
        
        // Update municipality dropdown based on selected province
        function updateMunicipalityDropdown() {
            var regionSelect = document.getElementById('region-select');
            var provinceSelect = document.getElementById('province-select');
            var municipalitySelect = document.getElementById('municipality-select');
            
            if (!regionSelect || !provinceSelect || !municipalitySelect) return;
            
            var selectedRegion = regionSelect.value;
            var selectedProvince = provinceSelect.value;
            var municipalities = new Set();
            
            console.log('updateMunicipalityDropdown called with region:', selectedRegion, 'province:', selectedProvince);
            
            if (selectedProvince) {
                // Only show municipalities if a province is selected
                json_Region2_39.features.forEach(function(feature) {
                    if (feature.properties && 
                        feature.properties.Reg_Name === selectedRegion && 
                        feature.properties.Pro_Name === selectedProvince && 
                        feature.properties.Mun_Name) {
                        municipalities.add(feature.properties.Mun_Name);
                    }
                });
            }
            // If no province is selected, don't show any municipalities
            
            // Clear and repopulate municipality dropdown
            municipalitySelect.innerHTML = '<option value="">Select Municipality</option>';
            if (selectedProvince && municipalities.size > 0) {
            Array.from(municipalities).sort().forEach(function(municipality) {
                var option = document.createElement('option');
                option.value = municipality;
                option.textContent = municipality;
                municipalitySelect.appendChild(option);
            });
            }
            
            console.log('Updated municipality dropdown with', municipalities.size, 'options for region:', selectedRegion, 'province:', selectedProvince);
        }
        
        // Update barangay dropdown based on selected municipality
        function updateBarangayDropdown() {
            var regionSelect = document.getElementById('region-select');
            var provinceSelect = document.getElementById('province-select');
            var municipalitySelect = document.getElementById('municipality-select');
            
            if (!regionSelect || !provinceSelect || !municipalitySelect) return;
            
            var selectedRegion = regionSelect.value;
            var selectedProvince = provinceSelect.value;
            var selectedMunicipality = municipalitySelect.value;
            var barangays = new Set();
            
            console.log('updateBarangayDropdown called with region:', selectedRegion, 'province:', selectedProvince, 'municipality:', selectedMunicipality);
            
            if (selectedMunicipality) {
                json_Region2_39.features.forEach(function(feature) {
                    if (feature.properties && 
                        feature.properties.Reg_Name === selectedRegion && 
                        feature.properties.Pro_Name === selectedProvince && 
                        feature.properties.Mun_Name === selectedMunicipality && 
                        feature.properties.Bgy_Name) {
                        barangays.add(feature.properties.Bgy_Name);
                    }
                });
            }
            
            var sortedBarangays = selectedMunicipality && barangays.size > 0
                ? Array.from(barangays).sort()
                : [];
            
            renderBarangayOptions(sortedBarangays);
            
            console.log('Updated barangay checkbox list with', sortedBarangays.length, 'options for region:', selectedRegion, 'province:', selectedProvince, 'municipality:', selectedMunicipality);
        }
        
        // Clear lower level dropdowns
        function clearLowerDropdowns() {
            var municipalitySelect = document.getElementById('municipality-select');
            
            if (municipalitySelect) {
                municipalitySelect.innerHTML = '<option value="">Select Municipality</option>';
                municipalitySelect.value = '';
            }
            renderBarangayOptions([]);
            resetHouseholdSelection();
            updateFloodExtentAvailability();
            filterHouseholdsBySelectedBarangay();
        }
        
        // Clear only barangay dropdown
        function clearBarangayDropdown() {
            renderBarangayOptions([]);
            resetHouseholdSelection();
            updateFloodExtentAvailability();
            filterHouseholdsBySelectedBarangay();
        }
        
        // Zoom to selected area
        function zoomToArea() {
            var region = document.getElementById('region-select').value;
            var province = document.getElementById('province-select').value;
            var municipality = document.getElementById('municipality-select').value;
            var barangays = getSelectedBarangays();
            var barangaySet = new Set(barangays.map(function(name) {
                return (name || '').toString().trim().toLowerCase();
            }));
            
            if (!region && !province && !municipality && barangaySet.size === 0) {
                return;
            }
            
            if (typeof map !== 'undefined' && typeof json_Region2_39 !== 'undefined' && json_Region2_39.features) {
                var format = new ol.format.GeoJSON();
                var features = format.readFeatures(json_Region2_39, {
                    featureProjection: map.getView().getProjection()
                });
                
                var matchingFeatures = features.filter(function(feature) {
                    var props = feature.getProperties();
                    var matches = true;
                    
                    if (region && props.Reg_Name !== region) matches = false;
                    if (province && props.Pro_Name !== province) matches = false;
                    if (municipality && props.Mun_Name !== municipality) matches = false;
                    if (barangaySet.size > 0) {
                        var bgyName = (props.Bgy_Name || '').toString().trim().toLowerCase();
                        if (!barangaySet.has(bgyName)) matches = false;
                    }
                    
                    return matches;
                });
                
                if (matchingFeatures.length > 0) {
                    var extent = matchingFeatures[0].getGeometry().getExtent();
                    for (var i = 1; i < matchingFeatures.length; i++) {
                        extent = ol.extent.extend(extent, matchingFeatures[i].getGeometry().getExtent());
                    }
                    
                    map.getView().fit(extent, {
                        duration: 1000,
                        maxZoom: 17
                    });
                    
                    console.log('Zoomed to', matchingFeatures.length, 'matching features');
                }
            }
        }
        
        // Highlight selected polygon
        function highlightSelectedPolygon() {
            var region = document.getElementById('region-select').value;
            var province = document.getElementById('province-select').value;
            var municipality = document.getElementById('municipality-select').value;
            var barangays = getSelectedBarangays();
            var barangaySet = new Set(barangays.map(function(name) {
                return (name || '').toString().trim().toLowerCase();
            }));
            
            if (!region && !province && !municipality && barangaySet.size === 0) {
                return;
            }
            
            if (typeof json_Region2_39 !== 'undefined' && json_Region2_39.features) {
                var format = new ol.format.GeoJSON();
                var features = format.readFeatures(json_Region2_39, {
                    featureProjection: map.getView().getProjection()
                });
                
                var matchingFeatures = features.filter(function(feature) {
                    var props = feature.getProperties();
                    var matches = true;
                    
                    if (region && props.Reg_Name !== region) matches = false;
                    if (province && props.Pro_Name !== province) matches = false;
                    if (municipality && props.Mun_Name !== municipality) matches = false;
                    if (barangaySet.size > 0) {
                        var bgyName = (props.Bgy_Name || '').toString().trim().toLowerCase();
                        if (!barangaySet.has(bgyName)) matches = false;
                    }
                    
                    return matches;
                });
                
                if (matchingFeatures.length > 0) {
                    highlightLayer.getSource().clear();
                    selectedFeatures = matchingFeatures;
                    matchingFeatures.forEach(function(feature) {
                        highlightLayer.getSource().addFeature(feature);
                    });
                    console.log('Highlighted', matchingFeatures.length, 'polygons');
                    addHoverListeners();
                }
            }
        }
        
        // Add hover event listeners to highlighted features
        function addHoverListeners() {
            // Remove existing listeners
            map.un('pointermove', handlePointerMove);
            
            // Add new pointer move listener
            map.on('pointermove', handlePointerMove);
        }
        
        // Handle pointer move for popup display
        function handlePointerMove(evt) {
            if (selectedFeatures.length === 0) {
                popupOverlay.setPosition(undefined);
                return;
            }
            
            var pixel = evt.pixel;
            var coordinate = evt.coordinate;
            
            // Check if pointer is over any selected feature
            var feature = map.forEachFeatureAtPixel(pixel, function(feature, layer) {
                if (layer === highlightLayer) {
                    return feature;
                }
                return null;
            });
            
            // Popup disabled - always hide it
                popupOverlay.setPosition(undefined);
        }
        
        // Clear highlight
        function clearHighlight() {
            if (highlightLayer) {
                highlightLayer.getSource().clear();
            }
            selectedFeatures = [];
            // Remove hover listeners
            map.un('pointermove', handlePointerMove);
            popupOverlay.setPosition(undefined);
        }
        
        // Setup map click handler to clear highlights
        function setupMapClickHandler() {
            if (typeof map !== 'undefined') {
                map.on('click', function(evt) {
                    if (!map) return;
                    var hit = map.forEachFeatureAtPixel(evt.pixel, function(feature, layer) {
                        return { feature: feature, layer: layer };
                    });

                    if (hit && hit.feature) {
                        if (peopleLayer && hit.layer === peopleLayer) {
                            var props = hit.feature.get ? hit.feature.getProperties() : hit.feature.properties;
                            var familyCode = '';
                            if (props) {
                                familyCode = props['FAMILY_ID'] || props['FAMILY-ID'] || props['fid'] || '';
                            }
                            if (familyCode) {
                                var geoFeature = featureToGeoJson(hit.feature);
                                var members = findHouseholdDataByFamilyId(familyCode) || [];
                                console.log('Household details for FAMILY-ID', String(familyCode) + ':', members);
                                showHouseholdModal(familyCode, geoFeature);
                                if (geoFeature) {
                                    zoomToFeature(geoFeature);
                                    highlightPopulationPolygon(geoFeature);
                                }
                            } else {
                                console.warn('People feature clicked without FAMILY-ID information.');
                            }
                            return;
                        }

                        if (selectedBarangayHighlightLayer && hit.layer === selectedBarangayHighlightLayer) {
                            console.log('Clicked highlighted barangay - keeping multi-selection pinned.');
                            return;
                        }

                        var familyId = getFamilyIdFromFeature(hit.feature);
                        if (familyId) {
                            var geoFeature = featureToGeoJson(hit.feature);
                            applyHouseholdSelection(familyId, geoFeature);
                            showHouseholdModal(familyId, geoFeature);
                            return;
                        }
                    }

                    console.log('Map clicked - clearing highlights and barangay selections');
                    clearBarangaySelections({ reason: 'map-click', force: true });
                    clearHighlight();
                    resetHouseholdSelection();
                    
                    // Also clear any active button states
                    var allNavBtns = document.querySelectorAll('.nav-btn');
                    allNavBtns.forEach(function(btn) {
                        btn.classList.remove('active');
                    });
                });
                console.log('Map click handler setup complete');
            }
        }
        
              
        // Show specific flood group
        function showFloodGroup(groupName) {
            if (typeof map !== 'undefined' && map.getLayers) {
                var layers = map.getLayers().getArray();
                var found = false;
                
                console.log('Looking for flood group:', groupName);
                
                layers.forEach(function(layer, index) {
                    var layerTitle = layer.get('title') || layer.get('name') || 'Unknown';
                    var layerType = layer.getType ? layer.getType() : 'unknown';
                    
                    // Check if this is the group we want to show
                    if (layerType === 'GROUP' && layerTitle.includes(groupName.replace('group_', ''))) {
                        layer.setVisible(true);
                        layer.setZIndex(1000); // Set high z-index to ensure it's on top
                        
                        // Also ensure all child layers in the group are visible
                        if (layer.getLayers) {
                            var childLayers = layer.getLayers().getArray();
                            childLayers.forEach(function(childLayer, childIndex) {
                                childLayer.setVisible(true);
                                childLayer.setZIndex(1000 + childIndex); // Set z-index for each child
                                console.log('Enabled child layer:', childLayer.get('title') || childLayer.get('name') || 'Unknown', 'z-index:', 1000 + childIndex);
                            });
                        }
                        
                        found = true;
                        console.log('Enabled flood group:', layerTitle, 'z-index: 1000');
                        
                        // Force map to re-render
                        map.render();
                    }
                });
                
                if (!found) {
                    console.log('Flood group not found:', groupName);
                    console.log('Available groups:');
                    layers.forEach(function(layer, index) {
                        var layerTitle = layer.get('title') || layer.get('name') || 'Unknown';
                        var layerType = layer.getType ? layer.getType() : 'unknown';
                        if (layerType === 'GROUP') {
                            console.log('Group ' + index + ':', layerTitle);
                        }
                    });
                }
            }
        }
        
        
        
        // Find flood extent layer for a specific meter value
        function findFloodExtentLayer(meter) {
            try {
                var globalKey = 'lyr_' + meter;
                if (typeof window[globalKey] !== 'undefined' && window[globalKey]) return window[globalKey];
                
                var needles = [
                    meter + '_2.png',
                    meter + '_3.png',
                    meter + '_4.png',
                    meter + '_5.png',
                    meter + '_6.png',
                    meter + '_7.png',
                    meter + '_8.png',
                    meter + '_10.png',
                    meter + '_2',
                    meter + '_3',
                    meter + '_4',
                    meter + '_5',
                    meter + '_6',
                    meter + '_7',
                    meter + '_8',
                    meter + '_10'
                ];
                
                // search window globals
                for (var key in window) {
                    if (!window.hasOwnProperty(key)) continue;
                    var obj = window[key];
                    if (!obj || typeof obj !== 'object') continue;
                    if (typeof obj.setVisible !== 'function') continue;
                    try {
                        var src = null;
                        if (obj.getSource && typeof obj.getSource === 'function') {
                            var s = obj.getSource();
                            if (s) {
                                if (typeof s.getUrl === 'function') src = s.getUrl();
                                else if (s.getUrls) src = (s.getUrls()[0] || '');
                            }
                        }
                        var name = (key + '').toLowerCase();
                        var url = (src && (src + '') || '').toLowerCase();
                        for (var i = 0; i < needles.length; i++) {
                            if (url.indexOf(needles[i]) !== -1 || name.indexOf(needles[i]) !== -1) {
                                return obj;
                            }
                        }
                    } catch (e) { /* ignore */ }
                }
                
                // search map layers
                if (typeof map !== 'undefined' && map.getLayers) {
                    var layers = map.getLayers().getArray();
                    for (var i = 0; i < layers.length; i++) {
                        var layer = layers[i];
                        try {
                            var title = (layer.get('title') || layer.get('name') || '').toString().toLowerCase();
                            for (var j = 0; j < needles.length; j++) {
                                if (title.indexOf(needles[j]) !== -1) return layer;
                            }
                            var src = layer.getSource && layer.getSource();
                            var url = (src && ((typeof src.getUrl === 'function' && src.getUrl()) || (src.getUrls && src.getUrls()[0])) || '').toString().toLowerCase();
                            for (var k = 0; k < needles.length; k++) {
                                if (url.indexOf(needles[k]) !== -1) return layer;
                            }
                        } catch (e) { /* ignore */ }
                    }
                }
            } catch (e) { console.warn('findFloodExtentLayer(' + meter + ') error', e); }
            return null;
        }

        // Add PNG layer for a specific meter value
        function addMeterPNGLayer(meter) {
            if (typeof map === 'undefined') return;
            var key = 'lyr_' + meter;
            
            // reuse if already created
            if (window[key]) {
                try {
                    var existing = window[key];
                    if (map.getLayers().getArray().indexOf(existing) === -1) map.addLayer(existing);
                    existing.setVisible(true);
                    if (typeof existing.setOpacity === 'function') existing.setOpacity(0.8);
                    try { existing.setZIndex(2000); } catch (e) {}
                    map.render();
                    console.log('Reused existing ' + meter + ' PNG layer and made visible');
                    return;
                } catch (e) { console.warn('Error re-showing existing layer', e); }
            }
            
            // helper to add image given a working url
            function createAndAddImage(url) {
                try {
                    var imageExtent = [13540235.716279, 1947216.452722, 13566724.528428, 1971690.071692];
                    var src = new ol.source.ImageStatic({
                        url: url,
                        imageExtent: imageExtent,
                        projection: 'EPSG:3857',
                        alwaysInRange: true
                    });
                    var imageLayer = new ol.layer.Image({
                        source: src,
                        opacity: 0.8,
                        visible: true
                    });
                    imageLayer.set('title', meter + '_flood_image');
                    window[key] = imageLayer;
                    map.addLayer(imageLayer);
                    try { imageLayer.setZIndex(2000); } catch (e) {}
                    map.render();
                    console.log('Successfully added ' + meter + ' PNG layer from', url);
                } catch (err) {
                    console.error('Error creating image layer for', url, err);
                }
            }
            
            // Attempt candidates with preload to detect missing/corrupt files early
            function tryCandidates(candidates, onComplete) {
                var idx = 0;
                function attempt() {
                    if (idx >= candidates.length) {
                        console.error('All attempts to load ' + meter + ' PNG failed.');
                        if (typeof onComplete === 'function') onComplete(false);
                        return;
                    }
                    var url = candidates[idx];
                    var testImg = new Image();
                    testImg.onload = function() {
                        createAndAddImage(url);
                        if (typeof onComplete === 'function') onComplete(true);
                    };
                    testImg.onerror = function() {
                        console.warn('Preload failed for', url);
                        idx++;
                        attempt();
                    };
                    testImg.src = url + '?_ts=' + Date.now();
                }
                attempt();
            }
            
            // special-case 24 -> 24_8.png
            if (String(meter) === '24') {
                tryCandidates([
                    './layers/24_8.png',
                    './24_8.png',
                    './layers/24_10.png',
                    './24_10.png',
                    './layers/24_7.png',
                    './24_7.png'
                ]);
                return;
            }
            
            // special-case 25 -> 25_7.png
            if (String(meter) === '25') {
                tryCandidates([
                    './layers/25_7.png',
                    './25_7.png',
                    './layers/25_8.png',
                    './25_8.png',
                    './layers/25_6.png',
                    './25_6.png'
                ]);
                return;
            }
            
            // special-case 26 -> 26_6.png
            if (String(meter) === '26') {
                tryCandidates([
                    './layers/26_6.png',
                    './26_6.png',
                    './layers/26_7.png',
                    './26_7.png',
                    './layers/26_5.png',
                    './26_5.png'
                ]);
                return;
            }
            
            // special-case 27 -> 27_5.png
            if (String(meter) === '27') {
                tryCandidates([
                    './layers/27_5.png',
                    './27_5.png',
                    './layers/27_6.png',
                    './27_6.png',
                    './layers/27_4.png',
                    './27_4.png'
                ]);
                return;
            }
            
            // special-case 28 -> 28_4.png
            if (String(meter) === '28') {
                tryCandidates([
                    './layers/28_4.png',
                    './28_4.png',
                    './layers/28_5.png',
                    './28_5.png',
                    './layers/28_3.png',
                    './28_3.png'
                ]);
                return;
            }
            
            // special-case 29 -> 29_3.png
            if (String(meter) === '29') {
                tryCandidates([
                    './layers/29_3.png',
                    './29_3.png',
                    './layers/29_4.png',
                    './29_4.png',
                    './layers/29_2.png',
                    './29_2.png'
                ]);
                return;
            }
            
            // special-case 30 -> 30_2.png
            if (String(meter) === '30') {
                tryCandidates([
                    './layers/30_2.png',
                    './30_2.png',
                    './layers/30_3.png',
                    './30_3.png',
                    './layers/30_1.png',
                    './30_1.png'
                ]);
                return;
            }
            
            // fallback generic attempt for other meters
            try {
                var urlCandidates = [
                    './layers/' + meter + '_2.png',
                    './layers/' + meter + '_3.png',
                    './layers/' + meter + '_4.png',
                    './layers/' + meter + '_5.png',
                    './layers/' + meter + '_6.png',
                    './layers/' + meter + '_7.png',
                    './layers/' + meter + '_8.png',
                    './layers/' + meter + '_10.png',
                    './' + meter + '_2.png',
                    './' + meter + '_3.png',
                    './' + meter + '_4.png',
                    './' + meter + '_5.png',
                    './' + meter + '_6.png',
                    './' + meter + '_7.png',
                    './' + meter + '_8.png',
                    './' + meter + '_10.png'
                ];
                tryCandidates(urlCandidates);
            } catch (err) {
                console.error('Error creating/showing ' + meter + ' PNG layer:', err);
            }
        }

        function showFloodData(extent) {
            extent = String(extent);
            
            if (typeof hideAllFloodGroups !== 'function' ||
                typeof ensureBasemapVisible !== 'function') {
                console.warn('Required helper functions are missing');
                return false;
            }

            // Hide all flood groups first
            hideAllFloodGroups();
            
            // Try to find existing layer for this extent
            var layer = findFloodExtentLayer(extent);
            
            if (layer) {
                // Layer exists, just make it visible
                try {
                    layer.setVisible(true);
                    layer.setZIndex(2000);
                    if (typeof layer.setOpacity === 'function') layer.setOpacity(0.8);
                    ensureBasemapVisible();
                    map.render();
                    console.log('Showed existing flood layer for', extent, 'meters');
                    return true;
                } catch (err) {
                    console.error('Error showing flood layer:', err);
                }
            } else {
                // Layer doesn't exist, create it
                try {
                    addMeterPNGLayer(extent);
                    setTimeout(function() {
                        var l = findFloodExtentLayer(extent);
                        if (l) {
                            try { 
                                l.setVisible(true); 
                                l.setZIndex(2000);
                                if (typeof l.setOpacity === 'function') l.setOpacity(0.8);
                                ensureBasemapVisible();
                                map.render();
                            } catch (e) {}
                        }
                    }, 200);
                    return true;
                } catch (err) {
                    console.error('Error creating flood layer for', extent, 'meters:', err);
                    return false;
                }
            }

            return false;
        }



    
        
        // Ensure basemap layers always stay visible & ordered
        function ensureBasemapVisible() {
            if (typeof map === 'undefined' || !map.getLayers) return;
            try {
                var layersColl = map.getLayers();
                var layers = layersColl.getArray().slice(); // copy to avoid mutation issues
                var basemapLayer = null;
                var regionLyr = null;

                // 1) detect basemap (tile) and region layer
                for (var i = 0; i < layers.length; i++) {
                    var lyr = layers[i];
                    try {
                        var src = lyr.getSource && lyr.getSource();
                        var srcName = (src && (src.constructor && src.constructor.name || '') || '').toString().toLowerCase();
                        var title = (lyr.get('title') || lyr.get('name') || '').toString().toLowerCase();

                        // tile-based basemap detection
                        if (!basemapLayer && (srcName.indexOf('tile') !== -1 || srcName.indexOf('xyz') !== -1 || typeof src.getTileGrid === 'function' || typeof src.getTileLoadFunction === 'function')) {
                            basemapLayer = lyr;
                        }

                        // region layer detection by title
                        if (!regionLyr && (title.indexOf('region2') !== -1 || title.indexOf('region_2') !== -1 || title === 'region2' || title === 'region_2')) {
                            regionLyr = lyr;
                        }
                    } catch (e) { /* ignore per-layer inspect errors */ }
                }

                // 2) Ensure basemap visible and put at bottom (zIndex 0)
                if (basemapLayer) {
                    try { basemapLayer.setVisible(true); } catch (e) {}
                    try { basemapLayer.setZIndex(0); } catch (e) {}
                    // move to bottom of collection
                    try {
                        layersColl.remove(basemapLayer);
                        layersColl.insertAt(0, basemapLayer);
                    } catch (e) {}
                }

                // 3) Ensure region visible and placed above basemap (zIndex 5)
                if (regionLyr) {
                    try { regionLyr.setVisible(true); } catch (e) {}
                    try { regionLyr.setZIndex(5); } catch (e) {}
                    // move to just above basemap
                    try {
                        if (basemapLayer) {
                            layersColl.remove(regionLyr);
                            layersColl.insertAt(1, regionLyr);
                        } else {
                            layersColl.remove(regionLyr);
                            layersColl.insertAt(0, regionLyr);
                        }
                    } catch (e) {}
                    console.log('Region2 ensured visible and ordered above basemap');
                }

                // 4) For safety: ensure any known highlight layer stays above region but below flood PNGs
                try { if (highlightLayer) { highlightLayer.setZIndex(900); } } catch (e) {}
                
                // 5) Ensure flood layers have high z-index and reduced opacity
                layers.forEach(function(layer) {
                    var layerTitle = layer.get('title') || layer.get('name') || 'Unknown';
                    var layerTitleLower = layerTitle.toLowerCase();
                    if (layerTitleLower.includes('flood') || 
                        layerTitleLower.includes('24meter') || 
                        layerTitleLower.includes('25meter') ||
                        layerTitleLower.includes('26meter') ||
                        layerTitleLower.includes('27meter') ||
                        layerTitleLower.includes('28meter') ||
                        layerTitleLower.includes('29meter') ||
                        layerTitleLower.includes('30meter') ||
                        layerTitleLower.includes('24_8') ||
                        layerTitleLower.includes('25_7') ||
                        layerTitleLower.includes('26_6') ||
                        layerTitleLower.includes('27_5') ||
                        layerTitleLower.includes('28_4') ||
                        layerTitleLower.includes('29_3') ||
                        layerTitleLower.includes('30_2') ||
                        layerTitleLower.includes('_flood_image')) {
                        try { 
                            layer.setZIndex(2000); 
                            layer.setVisible(true);
                            if (typeof layer.setOpacity === 'function') layer.setOpacity(0.8);
                            console.log('Set flood layer z-index to 2000 and opacity to 0.8:', layerTitle);
                        } catch (e) {}
                    }
                });
                
                try { map.render(); } catch (e) {}
            } catch (err) {
                console.warn('ensureBasemapVisible error', err);
            }
        }
        
        // ========== Flood Extent 24 meters (24_8.png) raster visibility ===========

        function findFloodExtent24Layer() {
            return findFloodExtentLayer('24');
        }

        function setFloodExtent24InitialVisibility() {
            var dropdown = document.getElementById('floodExtentDropdown');
            if (!dropdown) {
                setTimeout(setFloodExtent24InitialVisibility, 150);
                return;
            }
            
            // Try to find layer now; if not found, poll until it appears
            function ensureLayerHidden() {
                var layer = findFloodExtent24Layer();
                if (!layer) {
                    setTimeout(ensureLayerHidden, 150);
                    return;
                }
                try {
                    // store a consistent global reference if possible
                    window.lyr_24 = window.lyr_24 || layer;
                    window.lyr_24_8 = window.lyr_24_8 || layer;
                    layer.setVisible(false);
                } catch (e) { /* ignore */ }
            }
            ensureLayerHidden();
            
            // Keep dropdown and layer in sync
            dropdown.addEventListener('change', function() {
                var layer = findFloodExtent24Layer();
                if (!layer) {
                    // if layer not yet created and 24 selected, create it
                    if (this.value === '24' && typeof addMeterPNGLayer === 'function') {
                        addMeterPNGLayer('24');
                        // after creation ensure it's visible
                        setTimeout(function() {
                            var l = findFloodExtent24Layer();
                            if (l) try { l.setVisible(true); } catch (e) {}
                        }, 200);
                    }
                    return;
                }
                if (this.value === '24') {
                    try { layer.setVisible(true); } catch (e) {}
                } else {
                    try { layer.setVisible(false); } catch (e) {}
                }
            });
        }
        setFloodExtent24InitialVisibility();

        // ========== Flood Extent 25-30 meters initial visibility ===========
        
        function setFloodExtentInitialVisibilityFor(meter) {
            var dropdown = document.getElementById('floodExtentDropdown');
            if (!dropdown) {
                setTimeout(function(){ setFloodExtentInitialVisibilityFor(meter); }, 150);
                return;
            }

            function ensureLayerHidden() {
                var layer = findFloodExtentLayer(meter);
                if (!layer) {
                    setTimeout(ensureLayerHidden, 150);
                    return;
                }
                try {
                    window['lyr_' + meter] = window['lyr_' + meter] || layer;
                    layer.setVisible(false);
                } catch (e) { /* ignore */ }
            }
            ensureLayerHidden();

            // Listen for dropdown changes (multiple listeners ok)
            dropdown.addEventListener('change', function () {
                var layer = findFloodExtentLayer(meter);
                if (!layer) {
                    if (this.value === String(meter)) {
                        addMeterPNGLayer(meter);
                        setTimeout(function () {
                            var l = findFloodExtentLayer(meter);
                            if (l) try { l.setVisible(true); } catch (e) {}
                        }, 200);
                    }
                    return;
                }
                if (this.value === String(meter)) {
                    try { layer.setVisible(true); } catch (e) {}
                } else {
                    try { layer.setVisible(false); } catch (e) {}
                }
            });
        }

        // Initialize handlers for meters 25..30
        [25,26,27,28,29,30].forEach(function(m) {
            setFloodExtentInitialVisibilityFor(m);
        });

        // Setup flood extent event listeners
        function setupFloodExtentListeners() {
            var floodExtentDropdown = document.getElementById('floodExtentDropdown');
            if (floodExtentDropdown) {
                console.log('Setting up flood extent listeners');
                floodExtentDropdown.addEventListener('change', function() {
                    var selectedValue = this.value;
                    console.log('Flood extent changed to:', selectedValue);
                    
                    // Show/hide map legend based on selection
                    var mapLegend = document.getElementById('map-legend');
                    if (mapLegend) {
                        mapLegend.style.display = (selectedValue !== '') ? 'block' : 'none';
                    }
                    
                    if (selectedValue === '24') {
                        showFloodData('24');
                        setTimeout(function(){ showPeopleTableFor(24); }, 200);
                        // Toggle thematic layers for 24m
                        setTimeout(function(){
                            try {
                                toggleHouseholds(false);
                                toggleNumberOfPeople24(true);
                            } catch (e) { /* ignore */ }
                        }, 250);
                    } else if (selectedValue === '25') {
                        showFloodData('25');
                        setTimeout(function(){ showPeopleTableFor(25); }, 200);
                        setTimeout(function(){ try { toggleHouseholds(true); toggleNumberOfPeople24(false); } catch (e) {} }, 150);
                    } else if (selectedValue === '26') {
                        showFloodData('26');
                        setTimeout(function(){ showPeopleTableFor(26); }, 200);
                        setTimeout(function(){ try { toggleHouseholds(true); toggleNumberOfPeople24(false); } catch (e) {} }, 150);
                    } else if (selectedValue === '27') {
                        showFloodData('27');
                        setTimeout(function(){ showPeopleTableFor(27); }, 200);
                        setTimeout(function(){ try { toggleHouseholds(true); toggleNumberOfPeople24(false); } catch (e) {} }, 150);
                    } else if (selectedValue === '28') {
                        showFloodData('28');
                        setTimeout(function(){ showPeopleTableFor(28); }, 200);
                        setTimeout(function(){ try { toggleHouseholds(true); toggleNumberOfPeople24(false); } catch (e) {} }, 150);
                    } else if (selectedValue === '29') {
                        showFloodData('29');
                        setTimeout(function(){ showPeopleTableFor(29); }, 200);
                        setTimeout(function(){ try { toggleHouseholds(true); toggleNumberOfPeople24(false); } catch (e) {} }, 150);
                    } else if (selectedValue === '30') {
                        showFloodData('30');
                        setTimeout(function(){ showPeopleTableFor(30); }, 200);
                        setTimeout(function(){ try { toggleHouseholds(true); toggleNumberOfPeople24(false); } catch (e) {} }, 150);
                    } else {
                        // Only hide all flood layers when no value is selected
                        hideAllFloodGroups();
                        ensureBasemapVisible();
                            hidePeople24Table();
                        setTimeout(function(){ try { toggleHouseholds(true); toggleNumberOfPeople24(false); } catch (e) {} }, 150);
                    }
                });
            } else {
                console.log('Flood extent dropdown not found');
            }
        }
        
        // Hide all flood groups and layers except the currently selected one
        function hideAllFloodGroups() {
            if (typeof map !== 'undefined' && map.getLayers) {
                var layers = map.getLayers().getArray();
                console.log('Hiding all flood groups');
                
                // Get the currently selected flood extent
                var floodExtentDropdown = document.getElementById('floodExtentDropdown');
                var selectedExtent = floodExtentDropdown ? floodExtentDropdown.value : '';
                var selectedExtentSlug = selectedExtent ? (selectedExtent + 'meter') : '';
                
                layers.forEach(function(layer) {
                    var layerTitle = layer.get('title') || layer.get('name') || 'Unknown';
                    var layerTitleLower = layerTitle.toLowerCase();
                    var layerTitleCompact = layerTitleLower.replace(/[^a-z0-9]+/g, '');
                    
                    // Check if this layer should be hidden
                    var shouldHide = false;
                    
                    // Hide layers that contain flood-related keywords
                    if (layerTitleLower.includes('flood') || 
                        layerTitleLower.includes('analysis') ||
                        layerTitleLower.includes('aggregation') ||
                        layerTitleLower.includes('hazard') ||
                        layerTitleLower.includes('number of people') ||
                        layerTitleCompact.includes('numberofpeople') ||
                        layerTitleCompact.includes('24meter') ||
                        layerTitleCompact.includes('25meter') ||
                        layerTitleCompact.includes('26meter') ||
                        layerTitleCompact.includes('27meter') ||
                        layerTitleCompact.includes('28meter') ||
                        layerTitleCompact.includes('29meter') ||
                        layerTitleCompact.includes('30meter')) {
                        shouldHide = true;
                    }
                    
                    // Don't hide the currently selected flood extent layer
                    if (shouldHide && selectedExtent) {
                        var keepVisible = false;
                        
                        if (selectedExtent === '24') {
                            keepVisible = layerTitleCompact.includes('24meter') || layerTitleCompact.includes('24meters') || layerTitleLower.includes('24 meter');
                            if (!keepVisible && layerTitleLower.includes('24_8')) {
                                keepVisible = true;
                            }
                            if (!keepVisible && layerTitle.includes('24 Meter Flood Extent')) {
                                keepVisible = true;
                            }
                        } else {
                            keepVisible = layerTitleCompact.includes(selectedExtentSlug);
                        }
                        
                        if (keepVisible) {
                            shouldHide = false;
                            console.log('Keeping selected ' + selectedExtent + 'm flood layer visible:', layerTitle);
                        }
                    }
                    
                    if (shouldHide) {
                        layer.setVisible(false);
                        console.log('Hidden layer:', layerTitle);
                    }
                });
                // Also hide the people table if we're clearing flood groups or not on 24
                if (selectedExtent !== '24') hidePeople24Table();
            }
        }
        
                
        // Setup layer switcher control
        function setupLayerSwitcher() {
            // Layer switcher control is disabled - no layer list button will be shown
            console.log('Layer switcher control disabled - layer list button hidden');
        }
        
        // ===== Helpers to find/toggle specific layers =====
        function findLayerByNameIncludes(substr) {
            try {
                substr = (substr || '').toLowerCase();
                // Check window-scoped layer variables first
                for (var k in window) {
                    if (!window.hasOwnProperty(k)) continue;
                    var obj = window[k];
                    if (!obj || typeof obj !== 'object') continue;
                    if (typeof obj.setVisible !== 'function') continue;
                    try {
                        var title = ((obj.get && obj.get('title')) || (obj.get && obj.get('name')) || k || '').toString().toLowerCase();
                        if (title.indexOf(substr) !== -1 || (k.toLowerCase().indexOf(substr) !== -1)) return obj;
                    } catch (e) { /* ignore */ }
                }
                // Fallback: search map layers list
                if (typeof map !== 'undefined' && map.getLayers) {
                    var layers = map.getLayers().getArray();
                    for (var i = 0; i < layers.length; i++) {
                        try {
                            var layer = layers[i];
                            var t = (layer.get('title') || layer.get('name') || '').toString().toLowerCase();
                            if (t.indexOf(substr) !== -1) return layer;
                        } catch (e) { /* ignore */ }
                    }
                }
            } catch (e) { /* ignore */ }
            return null;
        }

        function findHouseholdsLayer() {
            // Match common variants
            var cand = findLayerByNameIncludes('households');
            if (cand) return cand;
            return findLayerByNameIncludes('household');
        }

        function findNumberOfPeople24Layer() {
            // Exact export usually: Numberofpeopleat24meters_12
            var cand = findLayerByNameIncludes('numberofpeopleat24meters_12');
            if (cand) return cand;
            // Fallback partials
            cand = findLayerByNameIncludes('numberofpeopleat24');
            if (cand) return cand;
            return findLayerByNameIncludes('numberofpeople');
        }

        function toggleHouseholds(visible) {
            var lyr = findHouseholdsLayer();
            if (lyr && typeof lyr.setVisible === 'function') {
                try { lyr.setVisible(!!visible); } catch (e) {}
            }
        }

        function toggleNumberOfPeople24(visible) {
            var lyr = findNumberOfPeople24Layer();
            if (lyr && typeof lyr.setVisible === 'function') {
                try { lyr.setVisible(!!visible); lyr.setZIndex && lyr.setZIndex(1200); } catch (e) {}
            }
        }
        
        // ===== People Table (24â€“30m) =====
        function getPeopleJsonFor(meter) {
            try {
                var wanted = String(meter);
                var matches = [];
                for (var key in window) {
                    if (!window.hasOwnProperty(key)) continue;
                    var low = key.toLowerCase();
                    // look for json_Numberofpeople... containing the meter number
                    if (low.indexOf('json_numberofpeople') !== -1 && low.indexOf(wanted) !== -1) {
                        matches.push(key);
                    }
                }
                // Prefer exact pattern json_NumberofpeopleatXm...
                matches.sort(function(a,b){ return a.length - b.length; });
                for (var i = 0; i < matches.length; i++) {
                    var obj = window[matches[i]];
                    if (obj && obj.features) return obj;
                }
            } catch (e) { /* ignore */ }
            return null;
        }

        function buildPeopleRowsFromJson(jsonObj) {
            try {
                if (!jsonObj || !jsonObj.features) {
                    return '';
                }
                var rows = '';
                var feats = jsonObj.features;
                var seenExposureIds = new Set(); // Track unique exposure_id values
                
                for (var i = 0; i < feats.length; i++) {
                    var p = feats[i] && feats[i].properties ? feats[i].properties : {};
                    
                    // Check for unique exposure_id
                    var exposureId = p.exposure_id;
                    if (exposureId != null && seenExposureIds.has(exposureId)) {
                        continue; // Skip duplicate exposure_id
                    }
                    seenExposureIds.add(exposureId);
                    
                    // Filter to only show affected populations
                    var affected = p.affected;
                    if (affected !== 'True' && affected !== true) continue;
                    
                    // Check if sum of all demographic values is 0
                    var sum = (p.infant || 0) + (p.child || 0) + (p.youth || 0) + (p.adult || 0) + 
                             (p.elderly || 0) + (p.male || 0) + (p.female || 0) + (p.disabled || 0);
                    if (sum === 0) continue; // Skip rows with no population data
                    
                    var brgy = p['aggregation_name'] || '';
                    rows += '<tr data-exposure-id="' + (exposureId || '') + '">' +
                        '<td>' + brgy + '</td>' +
                        '<td>' + (p.infant || 0) + '</td>' +
                        '<td>' + (p.child || 0) + '</td>' +
                        '<td>' + (p.youth || 0) + '</td>' +
                        '<td>' + (p.adult || 0) + '</td>' +
                        '<td>' + (p.elderly || 0) + '</td>' +
                        '<td>' + (p.male || 0) + '</td>' +
                        '<td>' + (p.female || 0) + '</td>' +
                        '<td>' + (p.disabled || 0) + '</td>' +
                        '<td>' + (p.hazard_class != null ? p.hazard_class : '') + '</td>' +
                    '</tr>';
                }
                return rows || '<tr><td colspan="10" class="empty-message">No data</td></tr>';
            } catch (e) {
                return '<tr><td colspan="10" class="empty-message">Error loading data</td></tr>';
            }
        }

        // Helper function to calculate demographics from household data based on exposure_id
        function calculateDemographicsFromHouseholds(exposureId) {
            try {
                if (typeof json_Households_1 === 'undefined' || !json_Households_1.features) {
                    return null;
                }
                
                var demographics = {
                    infant: 0,
                    child: 0,
                    youth: 0,
                    adult: 0,
                    elderly: 0,
                    male: 0,
                    female: 0,
                    disabled: 0
                };
                
                // Convert exposure_id to string for comparison
                var exposureIdStr = String(exposureId || '');
                
                // Find all household members with matching FAMILY-ID
                // First, we need to find the household feature that has this exposure_id as fid
                var householdFeature = null;
                for (var i = 0; i < json_Households_1.features.length; i++) {
                    var feature = json_Households_1.features[i];
                    if (feature && feature.properties) {
                        var householdFid = String(feature.properties['fid'] || '');
                        if (householdFid === exposureIdStr) {
                            householdFeature = feature;
                            break;
                        }
                    }
                }
                
                if (!householdFeature) {
                    return null;
                }
                
                // Get FAMILY-ID from the matched household
                var familyId = householdFeature.properties['FAMILY-ID'];
                if (!familyId) {
                    return null;
                }
                
                // Find all household members with the same FAMILY-ID
                var familyIdStr = String(familyId);
                for (var i = 0; i < json_Households_1.features.length; i++) {
                    var feature = json_Households_1.features[i];
                    if (!feature || !feature.properties) continue;
                    
                    var memberFamilyId = String(feature.properties['FAMILY-ID'] || '');
                    if (memberFamilyId !== familyIdStr) continue;
                    
                    // Get age and sex from household member
                    var age = parseInt(feature.properties['AGE'] || 0);
                    var sex = String(feature.properties['SEX'] || '').toLowerCase();
                    var disabled = String(feature.properties['Disabled'] || feature.properties['DISABLED'] || '').toLowerCase();
                    
                    // Count by age group (mutually exclusive ranges)
                    // Infant: 0-4 years
                    if (age >= 0 && age <= 4) {
                        demographics.infant++;
                    }
                    // Child: 5-14 years
                    else if (age >= 5 && age <= 14) {
                        demographics.child++;
                    }
                    // Youth: 15-24 years
                    else if (age >= 15 && age <= 24) {
                        demographics.youth++;
                    }
                    // Adult: 25-64 years
                    else if (age >= 25 && age <= 64) {
                        demographics.adult++;
                    }
                    // Elderly: 65+ years
                    else if (age >= 65) {
                        demographics.elderly++;
                    }
                    
                    // Count by sex
                    if (sex === 'male' || sex === 'm') {
                        demographics.male++;
                    } else if (sex === 'female' || sex === 'f') {
                        demographics.female++;
                    }
                    
                    // Count disabled
                    if (disabled === 'yes' || disabled === 'true' || disabled === '1') {
                        demographics.disabled++;
                    }
                }
                
                return demographics;
            } catch (e) {
                console.error('Error calculating demographics from households:', e);
                return null;
            }
        }
        
        // Count households by barangay that match Region2_39 barangays
        // Optional: filter by municipality name
        function countHouseholdsByBarangay(municipalityName) {
            try {
                // Check if both data sources are available
                if (typeof json_Region2_39 === 'undefined' || !json_Region2_39.features) {
                    console.error('Region2_39 data not available');
                    return null;
                }
                
                if (typeof json_Households_1 === 'undefined' || !json_Households_1.features) {
                    console.error('Households_1 data not available');
                    return null;
                }
                
                // Get all unique Bgy_Name values from Region2_39, optionally filtered by municipality
                var regionBarangays = new Set();
                var municipalityBarangays = new Set(); // Barangays in the selected municipality
                
                json_Region2_39.features.forEach(function(feature) {
                    if (feature.properties && feature.properties.Bgy_Name) {
                        var bgyName = String(feature.properties.Bgy_Name).trim();
                        var munName = feature.properties.Mun_Name ? String(feature.properties.Mun_Name).trim() : '';
                        
                        if (bgyName) {
                            // If municipality filter is provided, only include barangays from that municipality
                            if (municipalityName) {
                                if (munName === municipalityName) {
                                    regionBarangays.add(bgyName);
                                    municipalityBarangays.add(bgyName);
                                }
                            } else {
                                regionBarangays.add(bgyName);
                            }
                        }
                    }
                });
                
                // Count households by barangay
                var counts = {};
                var totalCount = 0;
                
                // Initialize counts for all region barangays (filtered by municipality if provided)
                regionBarangays.forEach(function(bgyName) {
                    counts[bgyName] = 0;
                });
                
                // Count households that match
                json_Households_1.features.forEach(function(feature) {
                    if (feature.properties && feature.properties.BARANGAY) {
                        var householdBarangay = String(feature.properties.BARANGAY).trim();
                        
                        // Check if this barangay exists in Region2_39 (and matches municipality filter if provided)
                        if (regionBarangays.has(householdBarangay)) {
                            counts[householdBarangay] = (counts[householdBarangay] || 0) + 1;
                            totalCount++;
                        }
                    }
                });
                
                // Return summary object
                var result = {
                    total: totalCount,
                    byBarangay: counts,
                    matchedBarangays: Object.keys(counts).filter(function(bgy) { return counts[bgy] > 0; }),
                    unmatchedCount: json_Households_1.features.length - totalCount,
                    municipality: municipalityName || null
                };
                
                console.log('Household count by barangay:', result);
                return result;
            } catch (e) {
                console.error('Error counting households by barangay:', e);
                return null;
            }
        }
        
        // Show barangay population popup
        function showBarangayPopulationPopup(municipalityName) {
            try {
                var modal = document.getElementById('barangay-population-modal');
                var title = document.getElementById('barangay-population-title');
                var content = document.getElementById('barangay-population-content');
                
                if (!modal || !title || !content) {
                    console.error('Barangay population modal elements not found');
                    return;
                }
                
                // Set title
                title.textContent = 'Population by Barangay - ' + municipalityName;
                
                // Show loading state
                content.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner" style="margin: 0 auto;"></div><p style="margin-top: 20px; color: #ccc;">Loading population data...</p></div>';
                modal.style.display = 'flex';
                
                // Get population counts
                var result = countHouseholdsByBarangay(municipalityName);
                
                if (!result || !result.byBarangay) {
                    content.innerHTML = '<div style="text-align: center; padding: 40px; color: #ccc;">No data available for this municipality.</div>';
                    return;
                }
                
                // Build content HTML
                var html = '<div style="padding: 20px;">';
                html += '<div style="margin-bottom: 20px; padding: 15px; background: rgba(74, 144, 226, 0.1); border-radius: 8px; border-left: 4px solid #4a90e2;">';
                html += '<div style="color: #4a90e2; font-weight: 600; font-size: 1.1rem; margin-bottom: 5px;">Total Population</div>';
                html += '<div style="color: #fafafa; font-size: 1.5rem; font-weight: 700;">' + result.total.toLocaleString() + '</div>';
                html += '</div>';
                
                html += '<div style="max-height: 400px; overflow-y: auto;">';
                html += '<table style="width: 100%; border-collapse: collapse;">';
                html += '<thead>';
                html += '<tr style="background: rgba(74, 144, 226, 0.15); border-bottom: 2px solid #4a90e2;">';
                html += '<th style="padding: 12px; text-align: left; color: #4a90e2; font-weight: 600;">Barangay Name</th>';
                html += '<th style="padding: 12px; text-align: right; color: #4a90e2; font-weight: 600;">Number of Population</th>';
                html += '</tr>';
                html += '</thead>';
                html += '<tbody>';
                
                // Sort barangays by name
                var sortedBarangays = Object.keys(result.byBarangay).sort();
                
                if (sortedBarangays.length === 0) {
                    html += '<tr><td colspan="2" style="padding: 20px; text-align: center; color: #999;">No barangays found in this municipality.</td></tr>';
                } else {
                    sortedBarangays.forEach(function(bgyName) {
                        var count = result.byBarangay[bgyName];
                        html += '<tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">';
                        html += '<td style="padding: 12px; color: #fafafa;">' + bgyName + '</td>';
                        html += '<td style="padding: 12px; text-align: right; color: #fafafa; font-weight: 500;">' + count.toLocaleString() + '</td>';
                        html += '</tr>';
                    });
                }
                
                html += '</tbody>';
                html += '</table>';
                html += '</div>';
                html += '</div>';
                
                content.innerHTML = html;
            } catch (e) {
                console.error('Error showing barangay population popup:', e);
                var content = document.getElementById('barangay-population-content');
                if (content) {
                    content.innerHTML = '<div style="text-align: center; padding: 40px; color: #f44336;">Error loading population data.</div>';
                }
            }
        }
        
        // Hide barangay population popup
        function hideBarangayPopulationPopup() {
            var modal = document.getElementById('barangay-population-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Filtering
        var currentPeopleAllFeats = [];

        function updatePeopleBarangayDisplay() {
            try {
                var displayEl = document.getElementById('people-filter-barangay-display');
                if (!displayEl) return;

                var selections = getSelectedBarangays();
                var selectedText = 'All Barangays';

                if (selections.length === 1) {
                    selectedText = selections[0];
                } else if (selections.length > 1) {
                    var preview = selections.slice(0, 3).join(', ');
                    if (selections.length > 3) {
                        preview += ' +' + (selections.length - 3);
                    }
                    selectedText = preview;
                }

                displayEl.textContent = selectedText;
            } catch (e) { /* ignore */ }
        }

        function populatePeopleFiltersFromFeatures(feats) {
            try {
                updatePeopleBarangayDisplay();
                updateFloodExtentAvailability();
            } catch (e) { /* ignore */ }
        }

        function traverseLayerTree(layer, callback) {
            if (!layer) return;
            try {
                callback(layer);
            } catch (e) { /* ignore */ }
            if (layer && typeof layer.getLayers === 'function') {
                var children = layer.getLayers();
                if (children && typeof children.forEach === 'function') {
                    children.forEach(function(child) {
                        traverseLayerTree(child, callback);
                    });
                }
            }
        }

        function ensureHouseholdLayers() {
            try {
                if (typeof map === 'undefined' || !map.getLayers || householdLayers.length > 0) {
                    return;
                }
                var layersCollection = map.getLayers();
                var registered = [];
                layersCollection.forEach(function(layer) {
                    traverseLayerTree(layer, function(candidate) {
                        if (!candidate || typeof candidate.get !== 'function') return;
                        var title = candidate.get('title') || candidate.get('name') || '';
                        if (!title) return;
                        var lower = String(title).toLowerCase();
                        if (lower.indexOf('households_1') !== -1) {
                            if (householdLayers.indexOf(candidate) === -1) {
                                householdLayers.push(candidate);
                                registered.push(title);
                                if (candidate.setVisible) {
                                    candidate.setVisible(false);
                                }
                            }
                        }
                    });
                });
                if (registered.length) {
                    console.log('Registered household base layers:', registered);
                } else {
                    console.warn('No household base layers found during initialization.');
                }
            } catch (e) {
                console.error('Failed to register household layers:', e);
            }
        }

        function setBaseHouseholdLayersVisible(visible) {
            try {
                ensureHouseholdLayers();
                var bool = !!visible;
                householdLayers.forEach(function(layer) {
                    if (layer && typeof layer.setVisible === 'function') {
                        layer.setVisible(bool);
                    }
                });
                console.log('Base household layers visibility set to:', bool);
            } catch (e) {
                console.error('Failed to toggle household base layers:', e);
            }
        }

        function setPeopleLayerVisible(visible) {
            try {
                ensurePeopleLayer();
                if (!peopleLayer || typeof peopleLayer.setVisible !== 'function') return;
                var bool = !!visible;
                if (peopleLayer.getVisible && peopleLayer.getVisible() === bool) {
                    return;
                }
                peopleLayer.setVisible(bool);
                console.log('People layer visibility forced to:', bool);
            } catch (e) {
                console.error('Failed to toggle people layer visibility:', e);
            }
        }

        function setControlDisabledById(id, disabled) {
            try {
                var el = document.getElementById(id);
                if (!el) return;
                var shouldDisable = !!disabled;
                if (shouldDisable && el.classList.contains('nav-btn')) {
                    el.classList.remove('active');
                }
                el.disabled = shouldDisable;
                el.classList.toggle('is-disabled', shouldDisable);
                if (shouldDisable) {
                    el.setAttribute('aria-disabled', 'true');
                } else {
                    el.removeAttribute('aria-disabled');
                }
            } catch (e) { /* ignore */ }
        }

        function updateFloodExtentAvailability() {
            try {
                var floodDropdown = document.getElementById('floodExtentDropdown');
                if (!floodDropdown) return;
                var hasBarangay = getSelectedBarangays().length > 0;
                if (!hasBarangay && floodDropdown.value) {
                    floodDropdown.value = '';
                    floodDropdown.dispatchEvent(new Event('change'));
                }
                floodDropdown.disabled = !hasBarangay;
                floodDropdown.classList.toggle('is-disabled', !hasBarangay);

                setControlDisabledById('toggleInfographicsBtn', !hasBarangay);
                setControlDisabledById('impactReportBtn', !hasBarangay);
            } catch (e) { /* ignore */ }
        }

        function resetHouseholdSelection() {
            if (lastSelectedHouseholdRow) {
                lastSelectedHouseholdRow.classList.remove('household-row-selected');
            }
            lastSelectedHouseholdRow = null;
            lastSelectedFamilyId = '';
            lastSelectedPopulationFeature = null;
            removeHighlight();
            removeHouseMarker();
        }

        function removeFilteredHouseholdLayer() {
            if (filteredHouseholdLayer && map) {
                map.removeLayer(filteredHouseholdLayer);
                filteredHouseholdLayer = null;
            }
        }

        function removeSelectedBarangayHighlight() {
            if (selectedBarangayHighlightLayer && map) {
                map.removeLayer(selectedBarangayHighlightLayer);
                selectedBarangayHighlightLayer = null;
            }
        }


        function featureToGeoJson(feature) {
            if (!feature) return null;
            if (feature.type === 'Feature' && feature.geometry) {
                return feature;
            }
            if (feature.getGeometry) {
                try {
                    var format = new ol.format.GeoJSON();
                    return format.writeFeatureObject(feature, {
                        dataProjection: 'EPSG:4326',
                        featureProjection: map ? map.getView().getProjection() : 'EPSG:3857'
                    });
                } catch (e) {
                    console.warn('Failed to convert feature to GeoJSON:', e);
                    return null;
                }
            }
            return null;
        }

        function highlightFeatureSelection(feature) {
            var geoFeature = featureToGeoJson(feature);
            if (!geoFeature) return;
            highlightPopulationPolygon(geoFeature);
        }

        function getSelectedBarangayFeatures() {
            if (typeof json_Region2_39 === 'undefined' || !json_Region2_39.features) {
                return [];
            }
            var regionSelect = document.getElementById('region-select');
            var provinceSelect = document.getElementById('province-select');
            var municipalitySelect = document.getElementById('municipality-select');

            var region = regionSelect ? normalizeBarangayName(regionSelect.value) : '';
            var province = provinceSelect ? normalizeBarangayName(provinceSelect.value) : '';
            var municipality = municipalitySelect ? normalizeBarangayName(municipalitySelect.value) : '';
            var selectedBarangays = getSelectedBarangays();
            var barangaySet = new Set(selectedBarangays.map(normalizeBarangayName));

            if (barangaySet.size === 0) {
                return [];
            }

            var matches = [];
            for (var i = 0; i < json_Region2_39.features.length; i++) {
                var feature = json_Region2_39.features[i];
                if (!feature || !feature.properties) continue;
                var props = feature.properties;
                var featureBarangay = normalizeBarangayName(props.Bgy_Name);
                if (!barangaySet.has(featureBarangay)) continue;

                var featureMunicipality = normalizeBarangayName(props.Mun_Name);
                var featureProvince = normalizeBarangayName(props.Pro_Name);
                var featureRegion = normalizeBarangayName(props.Reg_Name);

                if (municipality && featureMunicipality !== municipality) continue;
                if (province && featureProvince !== province) continue;
                if (region && featureRegion !== region) continue;

                matches.push(feature);
            }
            console.log('Matched', matches.length, 'barangay polygons for selections:', selectedBarangays);
            return matches;
        }

        function highlightSelectedBarangays(features) {
            removeSelectedBarangayHighlight();
            if (!features || !features.length || !map) return;
            try {
                var format = new ol.format.GeoJSON({
                    dataProjection: 'EPSG:4326',
                    featureProjection: map.getView().getProjection()
                });
                var olFeatures = [];
                for (var i = 0; i < features.length; i++) {
                    try {
                        var olFeature = format.readFeature(features[i]);
                        if (olFeature) {
                            olFeatures.push(olFeature);
                        }
                    } catch (err) {
                        console.warn('Failed to convert barangay feature for highlight:', err);
                    }
                }
                if (!olFeatures.length) return;
                var highlightStyle = new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: '#f39c12',
                        width: 3
                    }),
                    fill: new ol.style.Fill({
                        color: 'rgba(243, 156, 18, 0.15)'
                    })
                });
                selectedBarangayHighlightLayer = new ol.layer.Vector({
                    source: new ol.source.Vector({ features: olFeatures }),
                    style: highlightStyle,
                    zIndex: 1050
                });
                map.addLayer(selectedBarangayHighlightLayer);
                console.log('Applied persistent highlight for', olFeatures.length, 'barangay polygons.');
            } catch (e) {
                console.error('Failed to highlight barangays:', e);
            }
        }


        function updateTableSelectionHighlight() {
            var tbody = document.querySelector('#people-24-table-inner tbody');
            if (lastSelectedHouseholdRow) {
                lastSelectedHouseholdRow.classList.remove('household-row-selected');
                lastSelectedHouseholdRow = null;
            }
            if (!tbody || !lastSelectedFamilyId) {
                return;
            }
            var row = tbody.querySelector('tr[data-exposure-id=\"' + lastSelectedFamilyId + '\"]');
            if (row) {
                row.classList.add('household-row-selected');
                lastSelectedHouseholdRow = row;
            } else {
                lastSelectedFamilyId = '';
                lastSelectedPopulationFeature = null;
                removeHighlight();
                removeHouseMarker();
            }
        }

        function getFamilyIdFromFeature(feature) {
            if (!feature) return '';
            var props = feature.get ? feature.getProperties() : feature.properties;
            if (!props) return '';
            var candidates = [
                props.exposure_id,
                props.exposureId,
                props['exposure_id'],
                props['fid'],
                props['FID'],
                props['FAMILY-ID'],
                props['FAMILY_ID'],
                props['family_id']
            ];
            for (var i = 0; i < candidates.length; i++) {
                var candidate = candidates[i];
                if (candidate !== undefined && candidate !== null && String(candidate).trim() !== '') {
                    return String(candidate).trim();
                }
            }
            return '';
        }

        function applyHouseholdSelection(familyId, feature, options) {
            if (!familyId) {
                resetHouseholdSelection();
                return;
            }
            lastSelectedFamilyId = familyId;
            var geoFeature = feature ? featureToGeoJson(feature) : featureToGeoJson(findFeatureByFamilyId(familyId));
            if (geoFeature) {
                lastSelectedPopulationFeature = geoFeature;
            } else {
                lastSelectedPopulationFeature = null;
            }
            updateTableSelectionHighlight();
            if (lastSelectedPopulationFeature) {
                highlightFeatureSelection(lastSelectedPopulationFeature);
                if (!options || options.zoom !== false) {
                    zoomToFeature(lastSelectedPopulationFeature);
                }
            }
        }

        function filterHouseholdsBySelectedBarangay() {
            ensureHouseholdLayers();
            var selections = getSelectedBarangays();
            var selectionSet = new Set(selections.map(normalizeBarangayName));
            removeSelectedBarangayHighlight();
            removeFilteredHouseholdLayer();

            if (selectionSet.size === 0) {
                console.log('No barangay selections detected. Household filter cleared.');
                if (householdLayersVisible) {
                    setBaseHouseholdLayersVisible(true);
                }
                return;
            }

            if (typeof json_Households_1 === 'undefined' || !json_Households_1.features) {
                console.warn('Household data unavailable');
                return;
            }

            if (!map) {
                console.warn('Map not available for filtering households');
                return;
            }

            var barangayFeatures = getSelectedBarangayFeatures();
            if (!barangayFeatures.length) {
                console.warn('Unable to locate barangay boundary features for selections:', selections);
                return;
            }

            highlightSelectedBarangays(barangayFeatures);

            var format = new ol.format.GeoJSON({
                dataProjection: 'EPSG:4326',
                featureProjection: map.getView().getProjection()
            });

            var matchedFeatures = [];
            for (var i = 0; i < json_Households_1.features.length; i++) {
                var feat = json_Households_1.features[i];
                if (!feat || !feat.properties || !feat.geometry) continue;

                var props = feat.properties;
                var featureBarangay = normalizeBarangayName(props.BARANGAY);
                if (!selectionSet.has(featureBarangay)) {
                    continue;
                }

                try {
                    var olFeature = format.readFeature(feat);
                    if (olFeature) {
                        matchedFeatures.push(olFeature);
                    }
                } catch (err) {
                    console.warn('Failed to convert household feature for filtering:', err);
                }
            }

            console.log('Prepared', matchedFeatures.length, 'household polygons for barangay selections:', selections);

            if (matchedFeatures.length === 0) {
                if (householdLayersVisible) {
                    setBaseHouseholdLayersVisible(false);
                }
                return;
            }

            if (!householdLayersVisible) {
                console.log('Household layers are currently hidden; filtered results will render when activated.');
                return;
            }

            filteredHouseholdLayer = new ol.layer.Vector({
                source: new ol.source.Vector({
                    features: matchedFeatures
                }),
                style: function(feature) {
                    return [
                        new ol.style.Style({
                            stroke: new ol.style.Stroke({
                                color: 'rgba(35,35,35,1.0)',
                                width: 0.988
                            }),
                            fill: new ol.style.Fill({
                                color: 'rgba(196,60,57,1.0)'
                            })
                        })
                    ];
                },
                visible: householdLayersVisible,
                title: 'Filtered Households',
                zIndex: 1200
            });

            map.addLayer(filteredHouseholdLayer);
            if (householdLayersVisible) {
                setBaseHouseholdLayersVisible(false);
                filteredHouseholdLayer.setVisible(true);
            } else {
                filteredHouseholdLayer.setVisible(false);
            }
        }

        function checkDemoFilter(filter, demos, properties) {
            try {
                var lower = (filter || '').toLowerCase();
                var fallback = function(key) {
                    var raw = properties ? properties[key] : 0;
                    var num = parseFloat(raw || 0);
                    return isNaN(num) ? 0 : num;
                };
                var values = {
                    infant: demos ? demos.infant : fallback('infant'),
                    child: demos ? demos.child : fallback('child'),
                    youth: demos ? demos.youth : fallback('youth'),
                    adult: demos ? demos.adult : fallback('adult'),
                    elderly: demos ? demos.elderly : fallback('elderly'),
                    male: demos ? demos.male : fallback('male'),
                    female: demos ? demos.female : fallback('female'),
                    disabled: demos ? demos.disabled : fallback('disabled')
                };
                if (!values.hasOwnProperty(lower)) {
                    return true;
                }
                return (values[lower] || 0) > 0;
            } catch (e) {
                return true;
            }
        }

        function applyPeopleFiltersAndRender() {
            var tbody = document.querySelector('#people-24-table-inner tbody');
            if (!tbody) return;
            var selectedBarangays = getSelectedBarangays();
            var barangaySet = new Set(selectedBarangays.map(normalizeBarangayName));
            var hasBarangayFilter = barangaySet.size > 0;

            var rendered = 0;
            var rows = '';
            var totalRecords = 0; // Count total records matching filters (all records)
            var filteredFeatures = []; // Collect features that pass filters for highlighting
            
            var demoFilter = (currentDemoFilter || '').toLowerCase();

            // First pass: count all records matching filters
            for (var i = 0; i < currentPeopleAllFeats.length; i++) {
                var f = currentPeopleAllFeats[i];
                var p = f && f.properties ? f.properties : {};
                
                // Apply barangay filter
                var brgyVal = normalizeBarangayName(p['aggregation_name']);
                if (hasBarangayFilter && !barangaySet.has(brgyVal)) continue;
                
                if (demoFilter) {
                    var exposureIdFirst = p.exposure_id || '';
                    var demosFirst = calculateDemographicsFromHouseholds(exposureIdFirst);
                    var passes = checkDemoFilter(demoFilter, demosFirst, p);
                    if (!passes) continue;
                }
                
                // Count all records matching filters
                totalRecords++;
            }
            
            // Second pass: render all records matching filters (no deduplication)
            for (var i = 0; i < currentPeopleAllFeats.length; i++) {
                var f = currentPeopleAllFeats[i];
                var p = f && f.properties ? f.properties : {};
                
                // Apply barangay filter
                var brgyVal = normalizeBarangayName(p['aggregation_name']);
                if (hasBarangayFilter && !barangaySet.has(brgyVal)) continue;

                if (demoFilter) {
                    var exposureIdFilter = p.exposure_id || '';
                    var demosFilter = calculateDemographicsFromHouseholds(exposureIdFilter);
                    var passesFilter = checkDemoFilter(demoFilter, demosFilter, p);
                    if (!passesFilter) continue;
                }
                
                // Collect feature for highlighting
                filteredFeatures.push(f);
                
                // Show ALL records matching the filters (no deduplication)
                var hazard = (p.hazard_class != null ? String(p.hazard_class) : '');
                if (hazard.toLowerCase() === 'use_caution') hazard = 'very low';
                var brgyShow = p['aggregation_name'] || '';
                var exposureId = p.exposure_id || '';
                
                // Calculate demographics from household data
                var calculatedDemos = calculateDemographicsFromHouseholds(exposureId);
                
                // Use calculated demographics if available, otherwise fall back to exposure data
                var infant = calculatedDemos ? calculatedDemos.infant : (p.infant || 0);
                var child = calculatedDemos ? calculatedDemos.child : (p.child || 0);
                var youth = calculatedDemos ? calculatedDemos.youth : (p.youth || 0);
                var adult = calculatedDemos ? calculatedDemos.adult : (p.adult || 0);
                var elderly = calculatedDemos ? calculatedDemos.elderly : (p.elderly || 0);
                var male = calculatedDemos ? calculatedDemos.male : (p.male || 0);
                var female = calculatedDemos ? calculatedDemos.female : (p.female || 0);
                var disabled = calculatedDemos ? calculatedDemos.disabled : (p.disabled || 0);
                
                // Increment row number for display
                rendered++;
                
                rows += '<tr data-exposure-id="' + exposureId + '">' +
                    '<td>' + rendered + '</td>' +
                    '<td>' + brgyShow + '</td>' +
                    '<td>' + infant + '</td>' +
                    '<td>' + child + '</td>' +
                    '<td>' + youth + '</td>' +
                    '<td>' + adult + '</td>' +
                    '<td>' + elderly + '</td>' +
                    '<td>' + male + '</td>' +
                    '<td>' + female + '</td>' +
                    '<td>' + disabled + '</td>' +
                    '<td>' + hazard + '</td>' +
                '</tr>';
            }
            if (rows === '') rows = '<tr><td colspan="11" class="empty-message">No data</td></tr>';
            tbody.innerHTML = rows;
            updateTableSelectionHighlight();
            if (lastSelectedPopulationFeature) {
                highlightFeatureSelection(lastSelectedPopulationFeature);
            }
            updatePeopleCount(rendered, totalRecords);
            
            // Highlight all filtered features on the map
            highlightTableFeatures(filteredFeatures);
        }
        
        // Highlight features displayed in the population exposure table
        function highlightTableFeatures(features) {
            try {
                if (!highlightLayer) {
                    createHighlightLayer();
                }
                
                // Clear previous highlights
                highlightLayer.getSource().clear();
                
                if (features.length === 0) {
                    return;
                }
                
                // Get the current meter value to find the correct layer
                var dropdown = document.getElementById('floodExtentDropdown');
                var meter = dropdown ? dropdown.value : null;
                if (!meter) return;
                
                // Find the layer for this meter (e.g., Numberofpeopleat24meters_12)
                var layerName = 'numberofpeopleat' + meter + 'meters';
                var targetLayer = null;
                
                map.getLayers().forEach(function(layer) {
                    var layerTitle = layer.get('title') || '';
                    var layerTitleLower = layerTitle.toLowerCase();
                    var layerTitleCompact = layerTitleLower.replace(/[^a-z0-9]+/g, '');
                    if (layerTitleLower.indexOf(layerName) !== -1 || layerTitleCompact.indexOf(layerName) !== -1) {
                        targetLayer = layer;
                    }
                });
                
                if (!targetLayer || !targetLayer.getSource()) {
                    console.warn('Could not find layer for meter:', meter);
                    return;
                }
                
                // Collect exposure_ids from filtered features
                var exposureIds = new Set();
                for (var i = 0; i < features.length; i++) {
                    var f = features[i];
                    var p = f && f.properties ? f.properties : {};
                    var exposureId = p.exposure_id;
                    if (exposureId != null) {
                        exposureIds.add(String(exposureId));
                    }
                }
                
                // Find matching features from the layer source
                var layerSource = targetLayer.getSource();
                var olFeatures = [];
                
                layerSource.forEachFeature(function(olFeature) {
                    var props = olFeature.getProperties();
                    var exposureId = props.exposure_id;
                    if (exposureId != null && exposureIds.has(String(exposureId))) {
                        // Clone the feature to add to highlight layer
                        var clonedFeature = olFeature.clone();
                        olFeatures.push(clonedFeature);
                    }
                });
                
                // Add all features to highlight layer
                if (olFeatures.length > 0) {
                    highlightLayer.getSource().addFeatures(olFeatures);
                    console.log('Highlighted', olFeatures.length, 'polygons from population exposure table');
                }
            } catch (e) {
                console.error('Error highlighting table features:', e);
            }
        }

        function updatePeopleCount(rendered, total) {
            try {
                var el = document.getElementById('people-table-count');
                if (el) {
                    var text = String(rendered) + ' of ' + String(total) + ' rows';
                    if (currentDemoFilter) {
                        text += ' (filtered by ' + currentDemoFilter.replace(/_/g, ' ') + ')';
                    }
                    el.textContent = text;
                }
            } catch (e) { /* ignore */ }
        }

        


        // Wire close button
        (function(){
            var btn = document.getElementById('people-24-close');
            if (btn && !btn._wired) {
                btn.addEventListener('click', function(){ hidePeople24Table(); });
                btn._wired = true;
            }
        })();
        
        // Chart instances
        var hazardPieChart = null;
        var demographicsBarChart = null;
        var currentDemoFilter = '';
        var lastSelectedFamilyId = '';
        var lastSelectedHouseholdRow = null;
        var lastSelectedPopulationFeature = null;
        var filteredHouseholdLayer = null;
        var selectedBarangayHighlightLayer = null;
        
        // Show Charts Panel
        function showChartsPanel() {
            var chartsPanel = document.getElementById('charts-panel');
            var mapContainer = document.getElementById('map-container');
            if (chartsPanel && mapContainer) {
                chartsPanel.style.display = 'flex';
                mapContainer.classList.add('charts-open');
                updateCharts();
            }
        }
        
        // Hide Charts Panel
        function hideChartsPanel() {
            var chartsPanel = document.getElementById('charts-panel');
            var mapContainer = document.getElementById('map-container');
            if (chartsPanel && mapContainer) {
                chartsPanel.style.display = 'none';
                mapContainer.classList.remove('charts-open');
            }
        }
        
        // Update Charts - shows totals if no filters, or filtered data if filters are selected
        // Charts now reflect the actual data shown in the Population exposure table
        function updateCharts() {
            if (!currentPeopleAllFeats || currentPeopleAllFeats.length === 0) {
                // Clear charts if no data
                if (hazardPieChart) hazardPieChart.destroy();
                if (demographicsBarChart) demographicsBarChart.destroy();
                hazardPieChart = null;
                demographicsBarChart = null;
                return;
            }
            
            var selectedBarangays = getSelectedBarangays();
            var barangaySet = new Set(selectedBarangays.map(normalizeBarangayName));
            var hasBarangayFilter = barangaySet.size > 0;
            
            // Filter data based on selected filters (if any) - same logic as table
            var filteredData = [];
            for (var i = 0; i < currentPeopleAllFeats.length; i++) {
                var f = currentPeopleAllFeats[i];
                var p = f && f.properties ? f.properties : {};
                
                // Apply barangay filter if selected
                if (hasBarangayFilter) {
                    var brgyVal = normalizeBarangayName(p['aggregation_name']);
                    if (!barangaySet.has(brgyVal)) continue;
                }
                
                filteredData.push(p);
            }
            
            if (filteredData.length === 0) {
                if (hazardPieChart) hazardPieChart.destroy();
                if (demographicsBarChart) demographicsBarChart.destroy();
                hazardPieChart = null;
                demographicsBarChart = null;
                return;
            }
            
            // Calculate hazard level distribution - COUNT ROWS (not sum population)
            var hazardData = {
                'high': 0,
                'medium': 0,
                'low': 0,
                'very low': 0
            };
            
            for (var i = 0; i < filteredData.length; i++) {
                var p = filteredData[i];
                var hazardClass = (p['hazard_class'] || '').toString().trim().toLowerCase();
                if (hazardClass === 'use_caution') hazardClass = 'very low';
                
                if (hazardData.hasOwnProperty(hazardClass)) {
                    hazardData[hazardClass]++; // Count rows, not sum population
                }
            }
            
            // Calculate demographics - use calculated values from household data (same as table)
            var demoData = {
                infant: 0,
                child: 0,
                youth: 0,
                adult: 0,
                elderly: 0,
                disabled: 0
            };
            var demoKeysForChart = ['infant', 'child', 'youth', 'adult', 'elderly', 'disabled'];
            
            for (var i = 0; i < filteredData.length; i++) {
                var p = filteredData[i];
                var exposureId = p.exposure_id || '';
                
                // Calculate demographics from household data (same as table)
                var calculatedDemos = calculateDemographicsFromHouseholds(exposureId);
                
                // Use calculated demographics if available, otherwise fall back to exposure data
                demoData.infant += calculatedDemos ? calculatedDemos.infant : (parseFloat(p.infant || 0));
                demoData.child += calculatedDemos ? calculatedDemos.child : (parseFloat(p.child || 0));
                demoData.youth += calculatedDemos ? calculatedDemos.youth : (parseFloat(p.youth || 0));
                demoData.adult += calculatedDemos ? calculatedDemos.adult : (parseFloat(p.adult || 0));
                demoData.elderly += calculatedDemos ? calculatedDemos.elderly : (parseFloat(p.elderly || 0));
                demoData.disabled += calculatedDemos ? calculatedDemos.disabled : (parseFloat(p.disabled || 0));
            }
            
            // Update Pie Chart
            var pieCtx = document.getElementById('hazardPieChart');
            if (pieCtx) {
                if (hazardPieChart) hazardPieChart.destroy();
                hazardPieChart = new Chart(pieCtx, {
                    type: 'pie',
                    data: {
                        labels: ['High', 'Medium', 'Low', 'Very Low'],
                        datasets: [{
                            data: [
                                hazardData['high'],
                                hazardData['medium'],
                                hazardData['low'],
                                hazardData['very low']
                            ],
                            backgroundColor: [
                                'rgba(220, 53, 69, 0.8)',   // Red for High
                                'rgba(255, 193, 7, 0.8)',   // Yellow for Medium
                                'rgba(40, 167, 69, 0.8)',   // Green for Low
                                'rgba(108, 117, 125, 0.8)'  // Gray for Very Low
                            ],
                            borderColor: [
                                'rgba(220, 53, 69, 1)',
                                'rgba(255, 193, 7, 1)',
                                'rgba(40, 167, 69, 1)',
                                'rgba(108, 117, 125, 1)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#fafafa',
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                enabled: false // Disable tooltips
                            },
                            datalabels: {
                                color: '#ffffff',
                                font: {
                                    weight: 'bold',
                                    size: 12
                                },
                                formatter: function(value, context) {
                                    return Math.round(value);
                                },
                                anchor: 'center',
                                align: 'center'
                            }
                        }
                    },
                    plugins: [ChartDataLabels] // Register the plugin
                });
            }
            
            // Update Bar Chart
            var barCtx = document.getElementById('demographicsBarChart');
            if (barCtx) {
                if (demographicsBarChart) demographicsBarChart.destroy();
                var demoColors = demoKeysForChart.map(function(key) {
                    if (!currentDemoFilter) {
                        return 'rgba(243, 156, 18, 0.8)';
                    }
                    return currentDemoFilter === key ? 'rgba(243, 156, 18, 1)' : 'rgba(243, 156, 18, 0.35)';
                });
                demographicsBarChart = new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Infant', 'Child', 'Youth', 'Adult', 'Elderly', 'Disabled'],
                        datasets: [{
                            label: 'Population',
                            data: [
                                demoData.infant,
                                demoData.child,
                                demoData.youth,
                                demoData.adult,
                                demoData.elderly,
                                demoData.disabled
                            ],
                            backgroundColor: demoColors,
                            borderColor: 'rgba(243, 156, 18, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: false // Disable tooltips
                            },
                            datalabels: {
                                color: '#ffffff',
                                font: {
                                    weight: 'bold',
                                    size: 11
                                },
                                formatter: function(value) {
                                    var rounded = Math.round(value);
                                    return rounded > 0 ? rounded.toLocaleString() : '';
                                },
                                anchor: 'end',
                                align: 'top',
                                offset: 5
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 20000,
                                ticks: {
                                    color: '#fafafa',
                                    font: {
                                        size: 11
                                    }
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#fafafa',
                                    font: {
                                        size: 11
                                    }
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            }
                        },
                        onClick: function(evt, elements) {
                            if (!elements || elements.length === 0) {
                                if (currentDemoFilter) {
                                    currentDemoFilter = '';
                                    applyPeopleFiltersAndRender();
                                    updateCharts();
                                }
                                return;
                            }
                            var first = elements[0];
                            if (typeof first.index === 'undefined') return;
                            var key = demoKeysForChart[first.index] || '';
                            if (!key) return;
                            currentDemoFilter = (currentDemoFilter === key) ? '' : key;
                            applyPeopleFiltersAndRender();
                            updateCharts();
                        },
                        onHover: function(evt, elements) {
                            var target = evt && evt.native ? evt.native.target : (evt ? evt.target : null);
                            if (target) {
                                target.style.cursor = (elements && elements.length) ? 'pointer' : 'default';
                            }
                        }
                    },
                    plugins: [ChartDataLabels] // Register the plugin
                });
            }
        }
        
        // Show charts when table is shown, hide when table is hidden
        function showPeopleTableFor(meter) {
            try {
                var dropdown = document.getElementById('floodExtentDropdown');
                if (!dropdown || String(dropdown.value) !== String(meter)) { 
                    hidePeople24Table(); 
                    return; 
                }
                var pane = document.getElementById('upper-pane-people24');
                var tbody = document.querySelector('#people-24-table-inner tbody');
                var titleTextEl = document.getElementById('people-table-title-text');
                if (!pane || !tbody) return;
                // If data not ready yet, retry shortly
                var jsonObj = getPeopleJsonFor(meter);
                if (!jsonObj) { setTimeout(function(){ showPeopleTableFor(meter); }, 200); return; }
                var feats = (jsonObj && jsonObj.features) ? jsonObj.features : [];
                currentPeopleAllFeats = feats;
                populatePeopleFiltersFromFeatures(feats);
                applyPeopleFiltersAndRender(); // This will update the counter correctly
                // show pane at 40% of available height
                pane.style.display = 'block';
                pane.style.height = '40%';
                if (titleTextEl) titleTextEl.textContent = 'Population Exposure - ' + String(meter) + ' meters';
                // Show charts panel
                showChartsPanel();
            } catch (e) { /* ignore */ }
        }

        function hidePeople24Table() {
            var pane = document.getElementById('upper-pane-people24');
            if (pane) { pane.style.display = 'none'; pane.style.height = '0'; }
            updatePeopleCount(0, 0);
            hideChartsPanel();
            resetHouseholdSelection();
            // Clear highlights when table is hidden
            if (highlightLayer) {
                highlightLayer.getSource().clear();
            }
        }
        
        // Household Modal Functions
        function showHouseholdModal(familyId, feature) {
            try {
                var modal = document.getElementById('household-modal');
                var title = document.getElementById('household-modal-title');
                var tbody = document.getElementById('household-details-tbody');
                var householdSizeValue = document.getElementById('household-size-value');
                
                if (!modal || !title || !tbody || !householdSizeValue) return;
                
                // Find household data for this fid
                var householdData = findHouseholdDataByFamilyId(familyId);
                
                if (householdData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">No household data found for fid: ' + familyId + '</td></tr>';
                    householdSizeValue.textContent = '-';
                } else {
                    var rows = '';
                    var familyReligion = generateReligion(); // Generate one religion for the entire family
                    var householdSize = householdData.length; // Count the number of rows
                    
                    // Display household size at the top
                    householdSizeValue.textContent = householdSize;
                    
                    householdData.forEach(function(member) {
                        rows += '<tr>' +
                            '<td>' + (member['RELATION'] || '') + '</td>' +
                            '<td>' + (member['GIVEN NAME'] || '') + '</td>' +
                            '<td>' + (member['LAST NAME'] || '') + '</td>' +
                            '<td>' + (member['AGE'] || '') + '</td>' +
                            '<td>' + (member['SEX'] || '') + '</td>' +
                            '<td>' + (member['OCCUPATION'] || '') + '</td>' +
                            '<td>' + familyReligion + '</td>' +
                        '</tr>';
                    });
                    tbody.innerHTML = rows;
                }
                
                title.textContent = 'Household Details - fid: ' + familyId;
                modal.style.display = 'flex';
                
                // Zoom to and highlight the selected polygon
                console.log('Attempting to zoom to feature:', feature);
                if (feature) {
                    zoomToFeature(feature);
                    // Highlight the population polygon
                    highlightPopulationPolygon(feature);
                } else {
                    console.log('No feature provided for zooming');
                }
            } catch (e) {
                console.error('Error showing household modal:', e);
            }
        }
        
        function hideHouseholdModal() {
            var modal = document.getElementById('household-modal');
            if (modal) {
                modal.style.display = 'none';
                // Remove house marker when modal is closed
                removeHouseMarker();
                // Remove highlight when modal is closed
                removeHighlight();
            }
        }
        
        function findHouseholdDataByFamilyId(familyId) {
            try {
                if (typeof json_Households_1 === 'undefined' || !json_Households_1.features) {
                    console.log('Household data not available');
                    return [];
                }
                
                // Convert both values to strings for comparison
                var familyIdStr = String(familyId).trim();
                if (familyIdStr === '') {
                    return [];
                }

                console.log('Looking for household data with identifier:', familyIdStr);

                // First try direct FAMILY-ID matches
                var directMatches = json_Households_1.features.filter(function(feature) {
                    if (!feature || !feature.properties) return false;
                    var householdFamilyId = feature.properties['FAMILY-ID'] || feature.properties['FAMILY_ID'];
                    return householdFamilyId !== undefined && householdFamilyId !== null &&
                        String(householdFamilyId).trim() === familyIdStr;
                });

                if (directMatches.length > 0) {
                    console.log('Found', directMatches.length, 'rows via FAMILY-ID match');
                    return directMatches.map(function(feature) {
                        return feature.properties;
                    });
                }

                console.log('No direct FAMILY-ID match; falling back to fid lookup');
                
                // First, find the fid match to get the FAMILY-ID
                var matchedFeature = null;
                for (var i = 0; i < json_Households_1.features.length; i++) {
                    var feature = json_Households_1.features[i];
                    if (feature && feature.properties) {
                        var householdFid = String(feature.properties['fid']);
                        if (householdFid === familyIdStr) {
                            matchedFeature = feature;
                            console.log('Found matching fid!', feature);
                            break;
                        }
                    }
                }
                
                if (!matchedFeature) {
                    console.log('No matching fid found:', familyIdStr);
                    return [];
                }
                
                // Now get the FAMILY-ID from the matched feature
                var familyIdValue = matchedFeature.properties['FAMILY-ID'];
                console.log('FAMILY-ID for fid', familyIdStr, 'is:', familyIdValue);
                
                // Now find all features with the same FAMILY-ID
                var matchingFeatures = json_Households_1.features.filter(function(feature) {
                    if (!feature.properties) return false;
                    var householdFamilyId = String(feature.properties['FAMILY-ID']);
                    return householdFamilyId === String(familyIdValue);
                });
                
                console.log('Found', matchingFeatures.length, 'matching household features');
                
                if (matchingFeatures.length === 0) {
                    // Let's check if there are any similar IDs for debugging
                    var allFamilyIds = json_Households_1.features
                        .filter(function(f) { return f.properties && f.properties['FAMILY-ID']; })
                        .map(function(f) { return f.properties['FAMILY-ID']; })
                        .slice(0, 10); // Show first 10 for debugging
                    console.log('Sample household Family IDs:', allFamilyIds);
                }
                
                return matchingFeatures.map(function(feature) {
                    return feature.properties;
                });
            } catch (e) {
                console.error('Error finding household data:', e);
                return [];
            }
        }
        
        function generateReligion() {
            // Most households are Roman Catholic, then others
            // Weighted distribution: 70% Roman Catholic, 15% Iglesia ni Cristo, 10% Born Again Christian, 5% Islam
            var random = Math.random();
            if (random < 0.70) {
                return 'Roman Catholic';
            } else if (random < 0.85) {
                return 'Iglesia ni Cristo';
            } else if (random < 0.95) {
                return 'Born Again Christian';
            } else {
                return 'Islam';
            }
        }
        
        // Infographics modal helpers
        function showInfographicsModal(meter) {
            try {
                var modal = document.getElementById('infographics-modal');
                var title = document.getElementById('infographics-modal-title');
                var body = modal ? modal.querySelector('.modal-body') : null;
                var container = document.getElementById('infographics-container');
                if (!modal || !container) return;
                var safeMeter = String(meter).replace(/[^0-9]/g, '');
                var pdfPath = 'infographics/' + safeMeter + '/output/infographic.pdf';
                if (title) title.textContent = 'Infographics â€“ ' + safeMeter + ' meters';
                // Show loading state
                container.innerHTML = '<div class="loading-wrap"><div class="spinner"></div></div>';
                // Insert <object> for PDF
                var objectEl = document.createElement('object');
                objectEl.setAttribute('data', pdfPath);
                objectEl.setAttribute('type', 'application/pdf');
                objectEl.setAttribute('style', 'width:100%; height:100%;');
                // Fallback content for object
                var fallbackDiv = document.createElement('div');
                fallbackDiv.setAttribute('style', 'padding:16px; color:#e0e0e0; text-align:center;');
                fallbackDiv.textContent = 'Attempting to load PDF...';
                objectEl.appendChild(fallbackDiv);

                // Replace loading after a short delay regardless (object has no reliable load)
                setTimeout(function(){
                    container.innerHTML = '';
                    container.appendChild(objectEl);
                }, 800);
                modal.style.display = 'flex';
                modal.style.zIndex = '1000';
            } catch (e) { /* ignore */ }
        }

        function hideInfographicsModal() {
            try {
                var modal = document.getElementById('infographics-modal');
                if (!modal) return; 
                modal.style.display = 'none';
                var container = document.getElementById('infographics-container');
                if (container) container.innerHTML = '';
            } catch (e) { /* ignore */ }
        }

        // Impact Report modal helpers
        function showImpactReportModal(meter) {
            try {
                var modal = document.getElementById('impact-report-modal');
                var container = document.getElementById('impact-report-container');
                var title = document.getElementById('impact-report-modal-title');
                if (!modal || !container) return;
                var safeMeter = String(meter).replace(/[^0-9]/g, '');
                if (title) title.textContent = 'Impact Report â€“ ' + safeMeter + ' meters';
                var htmlPath = 'infographics/' + safeMeter + '/output/impact-report-output.html';
                // Prepare container and overlay spinner without replacing content repeatedly
                container.innerHTML = '';
                var wrapper = document.createElement('div');
                wrapper.setAttribute('style', 'position:relative; width:100%; height:100%; background:#1e2329;');

                var spinnerWrap = document.createElement('div');
                spinnerWrap.className = 'loading-wrap';
                spinnerWrap.setAttribute('style', 'position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:#1e2329;');
                var spinner = document.createElement('div');
                spinner.className = 'spinner';
                spinnerWrap.appendChild(spinner);

                var iframe = document.createElement('iframe');
                iframe.src = htmlPath;
                iframe.title = 'Impact Report';
                iframe.setAttribute('style', 'width:100%; height:100%; border:none; background:#1e2329; visibility:hidden;');
                iframe.onload = function(){
                    iframe.style.visibility = 'visible';
                    if (spinnerWrap && spinnerWrap.parentNode) spinnerWrap.parentNode.removeChild(spinnerWrap);
                };
                iframe.onerror = function(){
                    if (spinnerWrap && spinnerWrap.parentNode) spinnerWrap.parentNode.removeChild(spinnerWrap);
                    wrapper.innerHTML = '';
                    var err = document.createElement('div');
                    err.className = 'inline-error';
                    err.innerHTML = 'Unable to load Impact Report. <a href="' + htmlPath + '" target="_blank" style="color:#f39c12; text-decoration:underline;">Open in new tab</a>';
                    wrapper.appendChild(err);
                };

                wrapper.appendChild(iframe);
                wrapper.appendChild(spinnerWrap);
                container.appendChild(wrapper);
                modal.style.display = 'flex';
                modal.style.zIndex = '1000';
            } catch (e) { /* ignore */ }
        }

        function hideImpactReportModal() {
            try {
                var modal = document.getElementById('impact-report-modal');
                if (!modal) return;
                modal.style.display = 'none';
                var container = document.getElementById('impact-report-container');
                if (container) container.innerHTML = '';
            } catch (e) { /* ignore */ }
        }

        // Global variable to store the current house marker
        var currentHouseMarker = null;
        // Global variable to store the current highlighted polygon layer
        var currentHighlightLayer = null;
        
        // Highlight population polygon function
        function highlightPopulationPolygon(feature) {
            try {
                // Remove existing highlight layer
                if (currentHighlightLayer) {
                    map.removeLayer(currentHighlightLayer);
                    currentHighlightLayer = null;
                }
                
                if (!feature || !feature.geometry) {
                    console.log('No feature geometry to highlight');
                    return;
                }
                
                // Convert GeoJSON feature to OpenLayers feature
                var format = new ol.format.GeoJSON({
                    dataProjection: 'EPSG:4326',
                    featureProjection: 'EPSG:3857'
                });
                
                var olFeature = format.readFeature(feature);
                
                // Create highlight style
                var highlightStyle = new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: '#ff0000',
                        width: 3
                    }),
                    fill: new ol.style.Fill({
                        color: 'rgba(255, 0, 0, 0.2)'
                    })
                });
                
                // Create vector layer with highlighted feature
                currentHighlightLayer = new ol.layer.Vector({
                    source: new ol.source.Vector({
                        features: [olFeature]
                    }),
                    style: highlightStyle,
                    zIndex: 3000 // Above other layers
                });
                
                // Add highlight layer to map
                map.addLayer(currentHighlightLayer);
                console.log('Population polygon highlighted');
                
            } catch (e) {
                console.error('Error highlighting population polygon:', e);
            }
        }
        
        // Remove highlight function
        function removeHighlight() {
            if (currentHighlightLayer) {
                map.removeLayer(currentHighlightLayer);
                currentHighlightLayer = null;
                console.log('Highlight removed');
            }
        }
        
        // Zoom to feature function
        function zoomToFeature(feature) {
            try {
                console.log('zoomToFeature called with:', feature);
                
                if (!map) {
                    console.log('Map not available');
                    return;
                }
                
                if (!feature) {
                    console.log('No feature provided');
                    return;
                }
                
                // Handle both OpenLayers features and raw GeoJSON features
                var geometry;
                if (feature.getGeometry) {
                    // OpenLayers feature
                    console.log('Processing OpenLayers feature');
                    geometry = feature.getGeometry();
                } else if (feature.geometry) {
                    // Raw GeoJSON feature - convert to OpenLayers geometry
                    console.log('Processing GeoJSON feature:', feature.geometry);
                    var format = new ol.format.GeoJSON({
                        dataProjection: 'EPSG:4326', // Input projection (WGS84)
                        featureProjection: 'EPSG:3857' // Output projection (Web Mercator)
                    });
                    geometry = format.readGeometry(feature.geometry);
                    console.log('Converted geometry:', geometry);
                } else {
                    console.log('No geometry found in feature');
                    return;
                }
                
                if (!geometry) {
                    console.log('No geometry after processing');
                    return;
                }
                
                var extent = geometry.getExtent();
                console.log('Feature extent:', extent);
                
                if (!extent || extent.length !== 4) {
                    console.log('Invalid extent');
                    return;
                }
                
                // Get center coordinates
                var center = ol.extent.getCenter(extent);
                console.log('Center coordinates:', center);
                
                // Check if extent has valid coordinates (not all zeros)
                if (extent[0] === 0 && extent[1] === 0 && extent[2] === 0 && extent[3] === 0) {
                    console.log('Extent is all zeros, trying alternative approach');
                    
                    if (center[0] !== 0 || center[1] !== 0) {
                        // Use center coordinates with a reasonable zoom level
                        map.getView().setCenter(center);
                        map.getView().setZoom(15);
                        console.log('Set center and zoom manually');
                        
                        // Add house marker at center
                        addHouseMarker(center);
                        return;
                    }
                }
                
                // Add some padding around the feature
                var padding = 100; // Use meters for Web Mercator
                var expandedExtent = [
                    extent[0] - padding,
                    extent[1] - padding,
                    extent[2] + padding,
                    extent[3] + padding
                ];
                
                console.log('Expanded extent:', expandedExtent);
                console.log('Zooming to feature...');
                
                map.getView().fit(expandedExtent, {
                    duration: 1000, // Animation duration in milliseconds
                    padding: [50, 50, 50, 50] // Add padding around the feature
                });
                
                // Add house marker at center after zoom
                setTimeout(function() {
                    addHouseMarker(center);
                }, 1100); // Wait for zoom animation to complete
                
                console.log('Zoom command sent');
            } catch (e) {
                console.error('Error zooming to feature:', e);
            }
        }
        
        // Add house marker function
        function addHouseMarker(center) {
            try {
                // Remove existing marker
                if (currentHouseMarker) {
                    map.removeLayer(currentHouseMarker);
                }
                
                // Create marker style
                var markerStyle = new ol.style.Style({
                    image: new ol.style.Icon({
                        src: 'data:image/svg+xml;base64,' + btoa(`
                            <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="16" cy="16" r="12" fill="#e74c3c" stroke="#fff" stroke-width="3"/>
                                <path d="M16 8l-8 6v10h4v-6h8v6h4V14l-8-6z" fill="#fff"/>
                            </svg>
                        `),
                        scale: 1,
                        anchor: [0.5, 1]
                    }),
                    text: new ol.style.Text({
                        text: 'This house',
                        font: 'bold 14px Arial',
                        fill: new ol.style.Fill({
                            color: '#2c3e50'
                        }),
                        stroke: new ol.style.Stroke({
                            color: '#fff',
                            width: 3
                        }),
                        offsetY: -40,
                        textAlign: 'center'
                    })
                });
                
                // Create marker feature
                var markerFeature = new ol.Feature({
                    geometry: new ol.geom.Point(center),
                    name: 'House Marker'
                });
                
                // Create marker layer
                currentHouseMarker = new ol.layer.Vector({
                    source: new ol.source.Vector({
                        features: [markerFeature]
                    }),
                    style: markerStyle,
                    zIndex: 1000
                });
                
                // Add marker to map
                map.addLayer(currentHouseMarker);
                console.log('House marker added at:', center);
                
            } catch (e) {
                console.error('Error adding house marker:', e);
            }
        }
        
        // Remove house marker function
        function removeHouseMarker() {
            if (currentHouseMarker) {
                map.removeLayer(currentHouseMarker);
                currentHouseMarker = null;
                console.log('House marker removed');
            }
        }
        
        // Setup modal event listeners
        function setupHouseholdModal() {
            var modal = document.getElementById('household-modal');
            var modalContent = document.querySelector('.modal-content');
            var modalHeader = document.querySelector('.modal-header');
            var closeBtn = document.getElementById('household-modal-close');
            
            if (closeBtn) {
                closeBtn.addEventListener('click', hideHouseholdModal);
            }
            
            // Remove the click-outside-to-close functionality since we want map interaction
            // Users can close the modal using the X button
            
            // Make modal draggable
            if (modalHeader && modalContent) {
                var isDragging = false;
                var currentX;
                var currentY;
                var initialX;
                var initialY;
                var xOffset = 0;
                var yOffset = 0;
                
                modalHeader.addEventListener('mousedown', dragStart);
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', dragEnd);
                
                function dragStart(e) {
                    initialX = e.clientX - xOffset;
                    initialY = e.clientY - yOffset;
                    
                    if (e.target === modalHeader || modalHeader.contains(e.target)) {
                        isDragging = true;
                    }
                }
                
                function drag(e) {
                    if (isDragging) {
                        e.preventDefault();
                        currentX = e.clientX - initialX;
                        currentY = e.clientY - initialY;
                        
                        xOffset = currentX;
                        yOffset = currentY;
                        
                        modalContent.style.transform = 'translate(' + currentX + 'px, ' + currentY + 'px)';
                    }
                }
                
                function dragEnd(e) {
                    initialX = currentX;
                    initialY = currentY;
                    isDragging = false;
                }
            }
        }
        
        // Setup table cell click handlers
        function setupTableClickHandlers() {
            var tbody = document.querySelector('#people-24-table-inner tbody');
            if (tbody) {
                tbody.addEventListener('click', function(e) {
                    var cell = e.target;
                    if (cell.tagName === 'TD') {
                        var row = cell.parentElement;
                        // Get exposure_id from the row's data attribute
                        var exposureId = row.getAttribute('data-exposure-id');
                        var familyId = exposureId ? exposureId.trim() : '';
                        
                        console.log('Table cell clicked, fid:', familyId);
                        console.log('fid type:', typeof familyId, 'Value:', familyId);
                        
                        if (familyId && familyId !== '') {
                            var populationFeature = findFeatureByFamilyId(familyId);
                            applyHouseholdSelection(familyId, populationFeature);
                        } else {
                            resetHouseholdSelection();
                        }
                    }
                });
            }
        }
        
        // Find feature by fid
        function findFeatureByFamilyId(familyId) {
            try {
                if (!currentPeopleAllFeats || currentPeopleAllFeats.length === 0) return null;
                
                var familyIdStr = String(familyId);
                for (var i = 0; i < currentPeopleAllFeats.length; i++) {
                    var feature = currentPeopleAllFeats[i];
                    if (feature && feature.properties && String(feature.properties.exposure_id) === familyIdStr) {
                        return feature;
                    }
                }
                return null;
            } catch (e) {
                console.error('Error finding feature by fid:', e);
                return null;
            }
        }
        
        // Find household polygon by fid (first match to get the FAMILY-ID, then find polygon)
        function findHouseholdPolygonByFamilyId(familyId) {
            try {
                console.log('Looking for household polygon with fid:', familyId);
                
                if (typeof json_Households_1 === 'undefined' || !json_Households_1.features) {
                    console.log('json_Households_1 not available');
                    return null;
                }
                
                var familyIdStr = String(familyId);
                console.log('Searching for fid string:', familyIdStr);
                console.log('Total household features:', json_Households_1.features.length);
                
                // Check first 10 household IDs for debugging
                var sampleIds = json_Households_1.features
                    .slice(0, 10)
                    .map(function(f) { 
                        return f.properties ? f.properties['fid'] : 'no-properties'; 
                    });
                console.log('Sample household fids:', sampleIds);
                
                // First, find the fid match to get the FAMILY-ID
                var matchedFeature = null;
                for (var i = 0; i < json_Households_1.features.length; i++) {
                    var feature = json_Households_1.features[i];
                    if (feature && feature.properties) {
                        var householdFid = String(feature.properties['fid']);
                        if (householdFid === familyIdStr) {
                            matchedFeature = feature;
                            console.log('Found matching fid!', feature);
                            break;
                        }
                    }
                }
                
                if (!matchedFeature) {
                    console.log('No matching fid found:', familyIdStr);
                    return null;
                }
                
                // Now get the FAMILY-ID from the matched feature
                var familyIdValue = matchedFeature.properties['FAMILY-ID'];
                console.log('FAMILY-ID for fid', familyIdStr, 'is:', familyIdValue);
                
                // Return the first feature we found (they all have the same FAMILY-ID)
                return matchedFeature;
            } catch (e) {
                console.error('Error finding household polygon by fid:', e);
                return null;
            }
        }
        
        // Initialize modal functionality
        document.addEventListener('DOMContentLoaded', function() {
            setupHouseholdModal();
            setupTableClickHandlers();
            // Restore last selected flood extent if available
            (function restoreLastMeter(){
                try {
                    // Removed localStorage memory - always start with "Select Flood Extent"
                    // var last = localStorage.getItem('lastFloodMeter');
                    // if (!last) return;
                    // var dropdown = document.getElementById('floodExtentDropdown');
                    // if (!dropdown) return;
                    // var exists = false;
                    // for (var i = 0; i < dropdown.options.length; i++) {
                    //     if (String(dropdown.options[i].value) === String(last)) { exists = true; break; }
                    // }
                    // if (exists) dropdown.value = String(last);
                } catch (e) { /* ignore */ }
            })();
            var infoClose = document.getElementById('infographics-modal-close');
            if (infoClose && !infoClose._wired) {
                infoClose.addEventListener('click', hideInfographicsModal);
                infoClose._wired = true;
            }

            var infoMax = document.getElementById('infographics-modal-maximize');
            if (infoMax && !infoMax._wired) {
                infoMax.addEventListener('click', function(){
                    try {
                        var modal = document.getElementById('infographics-modal');
                        if (!modal) return;
                        var content = modal.querySelector('.modal-content');
                        if (!content) return;
                        var isMax = content.classList.contains('maximized');
                        if (isMax) {
                            content.classList.remove('maximized');
                            infoMax.title = 'Maximize';
                            infoMax.textContent = 'â›¶';
                        } else {
                            content.classList.add('maximized');
                            infoMax.title = 'Restore';
                            infoMax.textContent = 'â†™';
                        }
                    } catch (e) { /* ignore */ }
                });
                infoMax._wired = true;
            }

            // Impact Report modal close
            var irClose = document.getElementById('impact-report-modal-close');
            if (irClose && !irClose._wired) {
                irClose.addEventListener('click', hideImpactReportModal);
                irClose._wired = true;
            }
            
            // Barangay Population modal close
            var barangayPopClose = document.getElementById('barangay-population-close');
            if (barangayPopClose && !barangayPopClose._wired) {
                barangayPopClose.addEventListener('click', hideBarangayPopulationPopup);
                barangayPopClose._wired = true;
            }

            // Impact Report modal maximize
            var irMax = document.getElementById('impact-report-modal-maximize');
            if (irMax && !irMax._wired) {
                irMax.addEventListener('click', function(){
                    try {
                        var modal = document.getElementById('impact-report-modal');
                        if (!modal) return;
                        var content = modal.querySelector('.modal-content');
                        if (!content) return;
                        var isMax = content.classList.contains('maximized');
                        if (isMax) {
                            content.classList.remove('maximized');
                            irMax.title = 'Maximize';
                            irMax.textContent = 'â›¶';
                        } else {
                            content.classList.add('maximized');
                            irMax.title = 'Restore';
                            irMax.textContent = 'â†™';
                        }
                    } catch (e) { /* ignore */ }
                });
                irMax._wired = true;
            }

            // Make Infographics modal draggable by its header
            (function(){
                var modal = document.getElementById('infographics-modal');
                if (!modal) return;
                var content = modal.querySelector('.modal-content');
                var header = modal.querySelector('.modal-header');
                if (!content || !header) return;

                var isDragging = false;
                var initialX = 0, initialY = 0;
                var currentX = 0, currentY = 0;
                var xOffset = 0, yOffset = 0;

                header.style.cursor = 'move';
                header.addEventListener('mousedown', dragStart);
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', dragEnd);

                function dragStart(e) {
                    initialX = e.clientX - xOffset;
                    initialY = e.clientY - yOffset;
                    if (e.target === header || header.contains(e.target)) {
                        isDragging = true;
                    }
                }

                function drag(e) {
                    if (!isDragging) return;
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    xOffset = currentX;
                    yOffset = currentY;
                    content.style.transform = 'translate(' + currentX + 'px, ' + currentY + 'px)';
                }

                function dragEnd() {
                    isDragging = false;
                }
            })();

            // Make Impact Report modal draggable by its header
            (function(){
                var modal = document.getElementById('impact-report-modal');
                if (!modal) return;
                var content = modal.querySelector('.modal-content');
                var header = modal.querySelector('.modal-header');
                if (!content || !header) return;

                var isDragging = false;
                var initialX = 0, initialY = 0;
                var currentX = 0, currentY = 0;
                var xOffset = 0, yOffset = 0;

                header.style.cursor = 'move';
                header.addEventListener('mousedown', dragStart);
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', dragEnd);

                function dragStart(e) {
                    initialX = e.clientX - xOffset;
                    initialY = e.clientY - yOffset;
                    if (e.target === header || header.contains(e.target)) {
                        isDragging = true;
                    }
                }

                function drag(e) {
                    if (!isDragging) return;
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                    xOffset = currentX;
                    yOffset = currentY;
                    content.style.transform = 'translate(' + currentX + 'px, ' + currentY + 'px)';
                }

                function dragEnd() {
                    isDragging = false;
                }
            })();

            // Wire Impact Report button
            var impactBtn = document.getElementById('impactReportBtn');
            if (impactBtn && !impactBtn._wired) {
                impactBtn.addEventListener('click', function() {
                    try {
                        var dropdown = document.getElementById('floodExtentDropdown');
                        var meterVal = dropdown ? String(dropdown.value || '').trim() : '';
                        if (!meterVal) {
                            alert('Please select a Flood Extent first.');
                            return;
                        }
                        try { localStorage.setItem('lastFloodMeter', meterVal); } catch (e) { /* ignore */ }
                        showImpactReportModal(meterVal);
                    } catch (e) { /* ignore */ }
                });
                impactBtn._wired = true;
            }

            // Wire standalone Infographics button (near L645)
            var toggleInfoBtn = document.getElementById('toggleInfographicsBtn');
            if (toggleInfoBtn && !toggleInfoBtn._wired) {
                toggleInfoBtn.addEventListener('click', function() {
                    try {
                        var dropdown = document.getElementById('floodExtentDropdown');
                        var meterVal = dropdown ? String(dropdown.value || '').trim() : '';
                        if (!meterVal) {
                            alert('Please select a Flood Extent first.');
                            return;
                        }
                        try { localStorage.setItem('lastFloodMeter', meterVal); } catch (e) { /* ignore */ }
                        showInfographicsModal(meterVal);
                    } catch (e) { /* ignore */ }
                });
                toggleInfoBtn._wired = true;
            }

            // AI Chat widget logic
            (function(){
                var toggle = document.getElementById('ai-chat-toggle');
                var panel = document.getElementById('ai-chat-panel');
                var closeBtn = document.getElementById('ai-chat-close');
                var body = document.getElementById('ai-chat-body');
                var input = document.getElementById('ai-chat-input');
                var send = document.getElementById('ai-chat-send');
                var settings = document.getElementById('ai-chat-settings');
                var docsBtn = document.getElementById('ai-chat-docs');
                var keyHint = document.getElementById('ai-key-hint');
                var isSending = false;

                function getApiKey(){
                    try { return localStorage.getItem('openai_api_key') || ''; } catch(e){ return ''; }
                }
                function setApiKey(val){
                    try { localStorage.setItem('openai_api_key', val || ''); } catch(e){}
                }
                function getProxyUrl(){
                    try { return localStorage.getItem('openai_proxy_url') || ''; } catch(e){ return ''; }
                }
                function setProxyUrl(val){
                    try { localStorage.setItem('openai_proxy_url', val || ''); } catch(e){}
                }
                function getOrgId(){ try { return localStorage.getItem('openai_org_id') || ''; } catch(e){ return ''; } }
                function setOrgId(v){ try { localStorage.setItem('openai_org_id', v || ''); } catch(e){} }
                function getProjectId(){ try { return localStorage.getItem('openai_project_id') || ''; } catch(e){ return ''; } }
                function setProjectId(v){ try { localStorage.setItem('openai_project_id', v || ''); } catch(e){} }
                function ensureKeyHint(){
                    var has = !!getApiKey() || !!getProxyUrl();
                    if (keyHint) keyHint.style.display = has ? 'none' : 'block';
                }
                function appendMsg(role, text){
                    var div = document.createElement('div');
                    div.className = 'ai-msg ' + (role === 'user' ? 'user' : 'assistant');
                    div.textContent = text;
                    body.appendChild(div);
                    body.scrollTop = body.scrollHeight;
                }
                function currentMeter(){
                    var dd = document.getElementById('floodExtentDropdown');
                    return dd ? String(dd.value || '').trim() : '';
                }
                function sleep(ms){ return new Promise(function(r){ setTimeout(r, ms); }); }
                async function sendToAI(query){
                    var key = getApiKey();
                    var proxy = getProxyUrl();
                    if (!key && !proxy){ appendMsg('assistant', 'Set an API key or a proxy URL in âš™ (recommended: proxy on your server).'); return; }
                    var meter = currentMeter();
                    var systemPrompt = 'You are a helpful GIS assistant for a flood exposure web app. Answer concisely. If asked about a meter, assume the selected meter is ' + (meter || 'unknown') + ' unless specified.';
                    var backoffs = [1000, 2000, 4000];
                    var warnedRateLimit = false;
                    try {
                        for (var i = 0; i <= backoffs.length; i++) {
                            var url = proxy || 'https://api.openai.com/v1/chat/completions';
                            var headers = { 'Content-Type': 'application/json' };
                            if (!proxy && key) headers['Authorization'] = 'Bearer ' + key;
                            var org = getOrgId();
                            var proj = getProjectId();
                            if (!proxy && org) headers['OpenAI-Organization'] = org;
                            if (!proxy && proj) headers['OpenAI-Project'] = proj;
                            var res = await fetch(url, {
                                method: 'POST',
                                headers: headers,
                                body: JSON.stringify({
                                    model: 'gpt-4o-mini',
                                    messages: [
                                        { role: 'system', content: systemPrompt },
                                        { role: 'user', content: query }
                                    ],
                                    temperature: 0.2,
                                    max_tokens: 400
                                })
                            });
                            if (res.ok) {
                                var data = await res.json();
                                var answer = (data && data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) || 'No response';
                                try {
                                    var reqId = res.headers.get('x-request-id');
                                    var remReq = res.headers.get('x-ratelimit-remaining-requests');
                                    var remTok = res.headers.get('x-ratelimit-remaining-tokens');
                                    if (reqId) console.log('OpenAI x-request-id:', reqId);
                                    if (remReq || remTok) console.log('RateLimit remaining - requests:', remReq, 'tokens:', remTok);
                                } catch(_e){}
                                appendMsg('assistant', answer);
                                return;
                            }
                            if (res.status === 429 && i < backoffs.length) {
                                if (!warnedRateLimit) {
                                    var resetMs = res.headers.get('x-ratelimit-reset-requests');
                                    var waitHint = resetMs ? (' ~' + resetMs + 'ms') : '';
                                    appendMsg('assistant', 'Rate limit reached. Retrying' + waitHint + '...');
                                    warnedRateLimit = true;
                                }
                                await sleep(backoffs[i]);
                                continue;
                            }
                            // Non-retryable or final failure
                            throw new Error('HTTP ' + res.status);
                        }
                        // If we exit loop without return, treat as failure
                        throw new Error('HTTP 429');
                    } catch(err){
                        var msg = (err && err.message) ? err.message : String(err);
                        if (msg.indexOf('429') >= 0) {
                            appendMsg('assistant', 'Rate limit from API. Please wait a moment and try again.');
                        } else {
                            appendMsg('assistant', 'Error contacting AI: ' + msg);
                        }
                    }
                }

                if (toggle && !toggle._wired){
                    toggle.addEventListener('click', function(){
                        if (!panel) return;
                        var isOpen = panel.style.display === 'flex';
                        panel.style.display = isOpen ? 'none' : 'flex';
                        ensureKeyHint();
                    });
                    toggle._wired = true;
                }
                if (closeBtn && !closeBtn._wired){
                    closeBtn.addEventListener('click', function(){ if(panel) panel.style.display = 'none'; });
                    closeBtn._wired = true;
                }
                if (settings && !settings._wired){
                    settings.addEventListener('click', function(){
                        var currentKey = getApiKey();
                        var keyVal = prompt('OpenAI API key (stored locally). Leave blank if using a server proxy:', currentKey ? (currentKey.slice(0,3) + '...' + currentKey.slice(-4)) : '');
                        if (keyVal && keyVal.indexOf('...') < 0) setApiKey(keyVal); else if (!keyVal) setApiKey('');
                        var currentProxy = getProxyUrl();
                        var proxyVal = prompt('Proxy URL (optional, recommended). Example: https://your-domain.com/api/chat', currentProxy || '');
                        if (proxyVal !== null) setProxyUrl(proxyVal.trim());
                        var org = prompt('OpenAI Organization ID (optional):', getOrgId() || ''); if (org !== null) setOrgId(org.trim());
                        var proj = prompt('OpenAI Project ID (optional):', getProjectId() || ''); if (proj !== null) setProjectId(proj.trim());
                        ensureKeyHint();
                        if (!getProxyUrl() && getApiKey()) {
                            appendMsg('assistant', 'Note: Using a key in the browser is insecure. Prefer configuring a server proxy.');
                        }
                    });
                    settings._wired = true;
                }
                if (docsBtn && !docsBtn._wired){
                    docsBtn.addEventListener('click', function(){
                        try { window.open('Documentation.html#ai-proxy', '_blank'); } catch(e){}
                    });
                    docsBtn._wired = true;
                }
                function doSend(){
                    var q = (input && input.value || '').trim();
                    if (!q) return;
                    if (isSending) { return; }
                    isSending = true;
                    if (send) { send.disabled = true; }
                    appendMsg('user', q);
                    if (input) input.value = '';
                    Promise.resolve().then(function(){ return sendToAI(q); }).finally(function(){
                        isSending = false;
                        if (send) { send.disabled = false; }
                    });
                }
                if (send && !send._wired){ send.addEventListener('click', doSend); send._wired = true; }
                if (input && !input._wired){ input.addEventListener('keydown', function(e){ if(e.key==='Enter'){ doSend(); } }); input._wired = true; }
            })();

            // ESC to close whichever modal is open
            document.addEventListener('keydown', function(e){
                try {
                    if (e.key !== 'Escape') return;
                    var info = document.getElementById('infographics-modal');
                    var ir = document.getElementById('impact-report-modal');
                    if (ir && ir.style.display === 'flex') {
                        hideImpactReportModal();
                        return;
                    }
                    if (info && info.style.display === 'flex') {
                        hideInfographicsModal();
                        return;
                    }
                } catch (err) { /* ignore */ }
            });
        });
        </script>
        </body>
        </html>
